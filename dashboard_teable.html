<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheep Land - Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com " />
  <link rel="preconnect" href="https://fonts.gstatic.com " crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter :wght@400;500;600;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Root Variables */
    :root {
      --c1: #5D4037;
      --c1d: #3E2723;
      --c2: #386641;
      --c2l: #A3B18A;
      --c3: #F28C28;
      --t1: #212529;
      --tm: #6c757d;
      --td: #FAF8F5;
      --b1: var(--td);
      --b2: #F0EBE3;
      --bc: #fff;
      --bs: #DDE0E3;
      --bs-darker: #c5c8cb;
      --rad: 6px;
      --s0: .2rem;
      --s1: .4rem;
      --s2: .5rem;
      --s3: 1.2rem;
      --s4: 1.6rem;
      --fe: 'Inter', sans-serif;
      --fa: 'Noto Kufi Arabic', sans-serif;
      --lh: 1.5;
      --bg-main: #f8f9fa;
      --sidebar-bg: #ffffff;
      --sidebar-width: 240px;
      --header-height: 60px;
      --border-color: var(--bs);
      --text-muted: var(--tm);
      --text-dark: var(--t1);
      --pill-radius: 12px;
    }

    *, ::after, ::before {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 15px;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--fe);
      line-height: var(--lh);
      color: var(--t1);
      background-color: var(--bg-main);
    }

    a {
      text-decoration: none;
      color: var(--c2);
    }

    a:hover {
      color: var(--c1d);
    }

    :focus-visible {
      outline: 2px solid var(--c3);
      outline-offset: 2px;
    }

    /* Layout */
    .dash-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .dash-main-app {
      display: flex;
      flex-grow: 1;
    }

    .dash-global-header {
      background-color: #fff;
      border-bottom: 1px solid var(--border-color);
      padding: 0 20px;
      height: var(--header-height);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .dash-global-header h1 {
      font-size: 1.5rem;
      color: var(--c1);
      margin: 0;
    }

    .dash-sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      padding: 20px 0;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .dash-sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .dash-sidebar-nav li button {
      display: block;
      padding: 10px 20px;
      color: var(--text-dark);
      font-size: 0.95rem;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      border-left: 3px solid transparent;
      font-family: var(--fe);
    }

    .dash-sidebar-nav li button:hover {
      background-color: #f0f0f0;
      color: var(--c1d);
    }

    .dash-sidebar-nav li.active button {
      background-color: var(--b2);
      color: var(--c1d);
      font-weight: 600;
      border-left-color: var(--c1);
    }

    .dash-content-area {
      flex-grow: 1;
      padding: 20px;
      overflow-x: auto;
    }

    .dash-content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .dash-content-header h2 {
      font-size: 1.6rem;
      color: var(--c1d);
      margin: 0;
    }

    /* Buttons */
    .btn {
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: var(--rad);
      cursor: pointer;
      background-color: var(--b2);
      color: var(--c1d);
      border: 1px solid var(--border-color);
      transition: background-color .2s, color .2s;
      line-height: normal;
    }

    .btn:hover {
      background-color: var(--c2l);
      color: var(--c1d);
    }

    .btn.bp {
      background-color: var(--c1);
      color: white;
      border-color: var(--c1);
    }

    .btn.bp:hover {
      background-color: var(--c1d);
    }

    .btn.bac {
      background-color: var(--c2);
      color: white;
      border-color: var(--c2);
    }

    .btn.bac:hover {
      background-color: #2a5031;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    .btn-small {
      font-size: 0.8rem;
      padding: 5px 10px;
    }

    .btn.btn-delete {
      background-color: #e74c3c;
      color: white;
      border-color: #e74c3c;
    }

    .btn.btn-delete:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }

    /* Filters */
    .dash-filters {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .dash-filters label {
      font-weight: 500;
      margin-right: 5px;
    }

    .dash-filters input[type="date"],
    .dash-filters select,
    .dash-filters input[type="text"],
    .dash-filters button {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: var(--rad);
      font-size: 0.9rem;
    }

    /* Table Grid */
    .teable-grid-wrapper {
      max-height: calc(100vh - var(--header-height) - 180px);
      overflow: auto;
      border: 1px solid var(--bs-darker);
      border-radius: var(--rad);
      margin-bottom: 10px;
      background-color: var(--bc);
    }

    .teable-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      table-layout: auto;
    }

    .teable-grid th,
    .teable-grid td {
      border-bottom: 1px solid var(--border-color);
      padding: 10px 12px;
      text-align: left;
      vertical-align: middle;
      word-wrap: break-word;
    }

    .teable-grid th {
      background-color: #f1f3f5;
      font-weight: 600;
      color: var(--text-dark);
      position: sticky;
      top: 0;
      z-index: 1;
      border-bottom-width: 2px;
      border-bottom-color: var(--bs-darker);
      white-space: nowrap;
    }

    .teable-grid td {
      background-color: var(--bc);
    }

    .teable-grid td .cell-content {
      display: block;
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .teable-grid td .cell-content.no-truncate {
      max-width: none;
      white-space: normal;
    }

    .teable-grid tbody tr:nth-child(even) td {
      background-color: #fdfdfd;
    }

    .teable-grid tbody tr:hover td {
      background-color: #e9ecef;
    }

    .teable-grid .actions-col {
      width: auto;
      text-align: right;
      white-space: nowrap;
    }

    .teable-grid .actions-col .btn {
      margin-left: 4px;
    }

    .teable-grid .text-right {
      text-align: right;
    }

    .teable-grid .text-center {
      text-align: center;
    }

    /* Status Pills */
    .status-pill {
      padding: 3px 10px;
      border-radius: var(--pill-radius);
      font-size: 0.75rem;
      display: inline-block;
      text-transform: capitalize;
      font-weight: 500;
      border: 1px solid transparent;
      line-height: 1.4;
    }

    .status-pill.paid_confirmed {
      background-color: #d1fae5;
      color: #065f46;
      border-color: #a7f3d0;
    }

    .status-pill.pending_confirmation,
    .status-pill.processing_pending,
    .status-pill.order_pending_confirmation {
      background-color: #ffedd5;
      color: #9a3412;
      border-color: #fed7aa;
    }

    .status-pill.payment_failed,
    .status-pill.order_failed {
      background-color: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-pill.default {
      background-color: #e5e7eb;
      color: #374151;
      border-color: #d1d5db;
    }

    .status-pill.available {
      background-color: #e0f2fe;
      color: #075985;
      border-color: #bae6fd;
    }

    .status-pill.sold {
      background-color: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }

    /* P&L Summary & Settings */
    .pnl-summary {
      background-color: var(--bc);
      padding: 20px;
      border-radius: var(--rad);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .pnl-summary h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--c1d);
      font-size: 1.3rem;
    }

    .pnl-summary div {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed var(--border-color);
      font-size: 0.95rem;
    }

    .pnl-summary div:last-child {
      border-bottom: none;
    }

    .pnl-summary strong {
      color: var(--c1d);
      font-weight: 600;
    }

    .pnl-profit {
      color: var(--c2);
      font-size: 1.1rem;
    }

    .pnl-loss {
      color: #e74c3c;
      font-size: 1.1rem;
    }

    .settings-card {
      padding: 20px;
      font-size: 0.9rem;
      background-color: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--rad);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .settings-card p,
    .settings-card div {
      margin-bottom: 10px;
    }

    .settings-card strong {
      color: var(--c1d);
    }

    /* Login Form */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background-color: #e9ecef;
    }

    .login-form {
      max-width: 400px;
      width: 100%;
      padding: 30px;
      border: 1px solid var(--border-color);
      border-radius: var(--rad);
      background-color: var(--bc);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .login-form h2 {
      text-align: center;
      margin-bottom: 25px;
      color: var(--c1d);
      font-size: 1.8rem;
    }

    .login-form .fg {
      margin-bottom: 15px;
    }

    .login-form .fg label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .login-form .input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--rad);
      font-size: 0.9rem;
    }

    .no-data {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-style: italic;
    }

    .load-text {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-weight: bold;
    }

    .pagination {
      margin-top: 15px;
      text-align: center;
    }

    .pagination button {
      margin: 0 5px;
    }

    .json-viewer {
      background-color: #2d2d2d;
      color: #f8f8f2;
      padding: 10px;
      border-radius: var(--rad);
      font-size: 0.8em;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
      margin-top: 5px;
    }

    [x-cloak] {
      display: none !important;
    }
  </style>
</head>
<body x-data="adminDashboard" x-init="initDashboard()" x-cloak>
  <div x-show="!isAdminAuth" class="login-container">
    <div class="login-form">
      <h2>Admin Login</h2>
      <div class="fg">
        <label for="adminEmail">Email:</label>
        <input type="email" id="adminEmail" x-model="loginForm.email" class="input" />
      </div>
      <div class="fg">
        <label for="adminPassword">Password:</label>
        <input type="password" id="adminPassword" x-model="loginForm.password" class="input" @keyup.enter="loginAdmin()" />
      </div>
      <button class="btn bac btn-block" @click="loginAdmin()" :disabled="loading.auth">
        <span x-show="!loading.auth">Login</span>
        <span x-show="loading.auth">Logging in...</span>
      </button>
      <p x-show="authError" x-text="authError" style="color:red; text-align:center; margin-top:10px;"></p>
    </div>
  </div>

  <div x-show="isAdminAuth" class="dash-wrapper">
    <header class="dash-global-header">
      <h1>Sheep Land - Admin</h1>
      <div>
        <a href="index.html" class="btn bp" style="margin-right:10px;">Main Site</a>
        <button class="btn bp" @click="logoutAdmin()">Logout</button>
      </div>
    </header>

    <div class="dash-main-app">
      <aside class="dash-sidebar">
        <ul class="dash-sidebar-nav">
          <li :class="{ active: currentView === 'pnl' }"><button @click="switchView('pnl')">P&L Summary</button></li>
          <li :class="{ active: currentView === 'orders' }"><button @click="switchView('orders')">Orders</button></li>
          <li :class="{ active: currentView === 'animals' }"><button @click="switchView('animals')">Animals</button></li>
          <li :class="{ active: currentView === 'animal_events' }"><button @click="switchView('animal_events')">Events</button></li>
          <li :class="{ active: currentView === 'products' }"><button @click="switchView('products')">Products</button></li>
          <li :class="{ active: currentView === 'expenses' }"><button @click="switchView('expenses')">Expenses</button></li>
          <li :class="{ active: currentView === 'settings' }"><button @click="switchView('settings')">Settings</button></li>
        </ul>
      </aside>

      <main class="dash-content-area">
        <div class="dash-content-header">
          <h2 x-text="getViewTitle(currentView)"></h2>
          <a :href="getPbAdminCreateUrl(getCollectionNameForView(currentView))" target="_blank" class="btn bp btn-small"
             x-show="getCollectionNameForView(currentView) && !['pnl', 'settings'].includes(currentView)">
            + New <span x-text="getSingularViewTitle(currentView) || 'Item'"></span>
          </a>
        </div>

        <div class="dash-filters" x-show="['pnl', 'orders', 'expenses'].includes(currentView)">
          <label for="startDate">From:</label>
          <input type="date" id="startDate" x-model="filterStartDate" @change="refreshCurrentViewData()" />
          <label for="endDate">To:</label>
          <input type="date" id="endDate" x-model="filterEndDate" @change="refreshCurrentViewData()" />
        </div>

        <!-- P&L View -->
        <div x-show="currentView === 'pnl'">
          <section class="pnl-summary">
            <h3>Profit & Loss <span x-text="filterDateRangeText" style="font-size: 0.9rem; color: var(--text-muted);"></span></h3>
            <div x-show="loading.pnl" class="load-text">Calculating P&L...</div>
            <div x-show="!loading.pnl">
              <div><span>Total Revenue (Paid Orders):</span> <strong x-text="formatCurrency(pnl.totalRevenue)"></strong></div>
              <div><span>Total Cost of Animals Sold (COGS):</span> <strong x-text="formatCurrency(pnl.totalCOGS)"></strong></div>
              <div><span>Gross Profit:</span> <strong x-text="formatCurrency(pnl.grossProfit)"></strong></div>
              <div><span>Total Operating Expenses:</span> <strong x-text="formatCurrency(pnl.totalExpenses)"></strong></div>
              <hr style="margin: 10px 0; border-color: var(--border-color); border-style:dashed;" />
              <div><span>Net Profit / (Loss):</span> <strong :class="pnl.netProfit >= 0 ? 'pnl-profit' : 'pnl-loss'" x-text="formatCurrency(pnl.netProfit)"></strong></div>
            </div>
          </section>
        </div>

        <!-- Settings View -->
        <div x-show="currentView === 'settings'">
          <section>
            <div x-show="loading.current" class="load-text">Loading settings...</div>
            <div x-show="!loading.current && data.settings?.items.length > 0">
              <template x-for="item in data.settings.items" :key="item.id">
                <div class="settings-card">
                  <p><strong>Default Currency:</strong> <span x-text="item.defCurr"></span></p>
                  <p><strong>WhatsApp Raw:</strong> <span x-text="item.waNumRaw"></span></p>
                  <p><strong>WhatsApp Display:</strong> <span x-text="item.waNumDisp"></span></p>
                  <p><strong>Promo Active:</strong> <span x-text="item.promoActive ? 'Yes' : 'No'"></span></p>
                  <p><strong>Promo Discount:</strong> <span x-text="item.promoDiscPc + '%'"></span></p>
                  <p><strong>Promo End:</strong> <span x-text="formatDate(item.promoEndISO)"></span></p>
                  <p><strong>Service Fee (EGP):</strong> <span x-text="formatCurrency(item.servFeeEGP, 'EGP', 0)"></span></p>
                  <div><strong>Exchange Rates:</strong> <pre class="json-viewer" x-text="JSON.stringify(item.xchgRates, null, 2)"></pre></div>
                  <div style="margin-top:10px;"><strong>Delivery Areas:</strong> <pre class="json-viewer" x-text="JSON.stringify(item.delAreas, null, 2)"></pre></div>
                  <div style="margin-top:10px;"><strong>Payment Details:</strong> <pre class="json-viewer" x-text="JSON.stringify(item.payDetails, null, 2)"></pre></div>
                  <a :href="getPbAdminEditUrl('settings', item.id)" target="_blank" class="btn bp" style="margin-top:15px;">Edit Settings in Admin UI</a>
                </div>
              </template>
            </div>
            <div x-show="!loading.current && (!data.settings || data.settings?.items.length === 0)" class="no-data">No settings found.</div>
          </section>
        </div>

        <!-- Data Grid View -->
        <template x-if="!['pnl', 'settings'].includes(currentView)">
          <section>
            <div x-show="loading.current" class="load-text" x-text="`Loading ${getViewTitle(currentView).toLowerCase()}...`"></div>
            <template x-if="!loading.current && data[getCollectionNameForView(currentView)]?.items.length > 0">
              <div class="teable-grid-wrapper">
                <table class="teable-grid">
                  <thead>
                    <tr>
                      <template x-for="column in getColumnsForView(currentView)" :key="column.key">
                        <th :class="{
                            'text-right': column.textAlign === 'right',
                            'text-center': column.textAlign === 'center'
                          }"
                          :style="column.headerWidth ? `width: ${column.headerWidth};` : ''"
                          x-text="column.label">
                        </th>
                      </template>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="item in data[getCollectionNameForView(currentView)].items" :key="item.id">
                      <tr>
                        <template x-for="column in getColumnsForView(currentView)" :key="column.key + '_' + item.id">
                          <td :class="{
                              'text-right': column.textAlign === 'right',
                              'text-center': column.textAlign === 'center',
                              'actions-col': column.type === 'actions' || column.type === 'actions_animal'
                            }"
                            x-html="renderCellContent(item, column, getCollectionNameForView(currentView))">
                          </td>
                        </template>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <div x-show="!loading.current && (!data[getCollectionNameForView(currentView)] || data[getCollectionNameForView(currentView)]?.items.length === 0)" class="no-data" x-text="`No ${getViewTitle(currentView).toLowerCase()} found.`"></div>
            <div class="pagination" x-show="data[getCollectionNameForView(currentView)]?.totalPages > 1">
              <button class="btn" @click="changePage(getCollectionNameForView(currentView), data[getCollectionNameForView(currentView)].page - 1)" :disabled="data[getCollectionNameForView(currentView)].page <= 1">Prev</button>
              <span x-text="`Page ${data[getCollectionNameForView(currentView)]?.page} of ${data[getCollectionNameForView(currentView)]?.totalPages}`"></span>
              <button class="btn" @click="changePage(getCollectionNameForView(currentView), data[getCollectionNameForView(currentView)].page + 1)" :disabled="data[getCollectionNameForView(currentView)].page >= data[getCollectionNameForView(currentView)].totalPages">Next</button>
            </div>
          </section>
        </template>
      </main>
    </div>
  </div>

  <script src="pocketbase.umd.js"></script>
  <script defer src="https://unpkg.com/alpinejs @3.x.x/dist/cdn.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      const ADM_E_PLACEHOLDER = 'admin@example.com';
      Alpine.data('adminDashboard', () => ({
        pb: null,
        isAdminAuth: false,
        loading: { auth: false, pnl: true, current: true },
        loginForm: { email: ADM_E_PLACEHOLDER, password: '' },
        authError: '',
        currentView: 'pnl',
        data: {
          orders: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
          expenses: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
          sheep_log: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
          animal_events: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
          products: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
          settings: { items: [], page: 1, perPage: 1, totalItems: 0, totalPages: 1 }
        },
        pnl: { totalRevenue: 0, totalCOGS: 0, grossProfit: 0, totalExpenses: 0, netProfit: 0 },
        filterStartDate: '',
        filterEndDate: '',
        pbAdminUrl: '',
        columnsConfig: {
          orders: [
            { key: 'order_id_text', label: 'ID', type: 'text', headerWidth: '100px' },
            { key: 'created', label: 'Date', type: 'date', headerWidth: '120px' },
            { key: 'ordering_person_name', label: 'Customer', type: 'text', cellMaxWidth: '180px' },
            { key: 'ordered_product_name_en', label: 'Product', type: 'text', cellMaxWidth: '200px' },
            { key: 'total_amount_due_egp', label: 'Total', type: 'currency', currency: 'EGP', digits: 0, textAlign: 'right', headerWidth: '100px' },
            { key: 'payment_status', label: 'Payment', type: 'status_pill', headerWidth: '140px' },
            { key: 'order_status', label: 'Order Status', type: 'text', format: (val) => val ? val.replace(/_/g, ' ') : 'N/A', headerWidth: '140px' },
            { key: 'id', label: 'Actions', type: 'actions', identifierField: 'order_id_text', headerWidth: '130px', textAlign: 'right' }
          ],
          expenses: [
            { key: 'expense_date', label: 'Date', type: 'date', headerWidth: '120px' },
            { key: 'category', label: 'Category', type: 'text', cellMaxWidth: '150px' },
            { key: 'description', label: 'Description', type: 'text', cellMaxWidth: '300px' },
            { key: 'amount_egp', label: 'Amount', type: 'currency', currency: 'EGP', digits: 0, textAlign: 'right', headerWidth: '100px' },
            { key: 'id', label: 'Actions', type: 'actions', identifierField: 'description', headerWidth: '130px', textAlign: 'right' }
          ],
          sheep_log: [
            { key: 'animal_tag_id', label: 'Tag ID', type: 'text', headerWidth: '100px' },
            { key: 'breed', label: 'Breed', type: 'text', cellMaxWidth: '120px' },
            { key: 'acquisition_date', label: 'Acq. Date', type: 'date', headerWidth: '120px' },
            { key: 'acquisition_cost_egp', label: 'Acq. Cost', type: 'currency', currency: 'EGP', digits: 0, textAlign: 'right', headerWidth: '110px' },
            { key: 'current_status', label: 'Status', type: 'status_pill', headerWidth: '100px' },
            { key: 'sale_order_id', label: 'Sold Order', type: 'expand', expandedField: 'sale_order_id', displayField: 'order_id_text', placeholder: 'N/A', headerWidth: '120px' },
            { key: 'id', label: 'Actions', type: 'actions_animal', identifierField: 'animal_tag_id', headerWidth: '180px', textAlign: 'right' }
          ],
          animal_events: [
            { key: 'animal_id', label: 'Animal Tag', type: 'expand', expandedField: 'animal_id', displayField: 'animal_tag_id', placeholder: 'N/A', headerWidth: '120px' },
            { key: 'event_date', label: 'Event Date', type: 'date', headerWidth: '120px' },
            { key: 'event_type', label: 'Type', type: 'text', cellMaxWidth: '150px' },
            { key: 'description', label: 'Description', type: 'text', cellMaxWidth: '300px' },
            { key: 'cost_associated_egp', label: 'Cost', type: 'currency', currency: 'EGP', digits: 0, textAlign: 'right', headerWidth: '100px' },
            { key: 'id', label: 'Actions', type: 'actions',
              identifierField: (item) => {
                const animalTag = item.expand?.animal_id?.animal_tag_id || 'Event';
                const eventDate = this.formatDate(item.event_date, { day:'2-digit', month:'short' });
                let descForIdentifier = item.description || '';
                if (descForIdentifier.length > 30) descForIdentifier = descForIdentifier.substring(0,27) + '...';
                return `${animalTag} - ${descForIdentifier} @ ${eventDate}`;
              },
              headerWidth: '130px', textAlign: 'right'
            }
          ],
          products: [
            { key: 'item_key', label: 'Key', type: 'text', cellMaxWidth: '150px' },
            { key: 'type_key', label: 'Type', type: 'text', headerWidth: '100px' },
            { key: 'variant_name_en', label: 'Variant (EN)', type: 'text', cellMaxWidth: '200px' },
            { key: 'base_price_egp', label: 'Price', type: 'currency', currency: 'EGP', digits: 0, textAlign: 'right', headerWidth: '100px' },
            { key: 'stock_available_pb', label: 'Stock', type: 'number', textAlign: 'right', headerWidth: '80px' },
            { key: 'is_active', label: 'Active', type: 'boolean', headerWidth: '80px', textAlign: 'center' },
            { key: 'id', label: 'Actions', type: 'actions', identifierField: 'item_key', headerWidth: '130px', textAlign: 'right' }
          ]
        },
        initDashboard() {
          this.pb = new PocketBase(window.location.origin);
          this.pbAdminUrl = window.location.origin;
          this.loginForm.email = ADM_E_PLACEHOLDER;
          if (this.pb.authStore.isAdmin && this.pb.authStore.isValid) {
            this.isAdminAuth = true;
            this.setDefaultDateRange();
            this.refreshCurrentViewData();
          } else {
            this.setDefaultDateRange();
          }
        },
        setDefaultDateRange() {
          const today = new Date();
          const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          this.filterStartDate = firstDayOfMonth.toISOString().split('T')[0];
          this.filterEndDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
        },
        async loginAdmin() {
          this.loading.auth = true;
          this.authError = '';
          try {
            await this.pb.admins.authWithPassword(this.loginForm.email, this.loginForm.password);
            this.isAdminAuth = true;
            this.loginForm.password = '';
            this.currentView = 'pnl';
            await this.refreshCurrentViewData();
          } catch (error) {
            this.authError = 'Login failed. Check credentials or server status.';
            console.error("Login Error:", error);
          } finally {
            this.loading.auth = false;
          }
        },
        logoutAdmin() {
          this.pb.authStore.clear();
          this.isAdminAuth = false;
          this.authError = '';
          Object.keys(this.data).forEach(key => {
            const perPage = this.data[key]?.perPage || 15;
            this.data[key] = { items: [], page: 1, perPage: perPage, totalItems: 0, totalPages: 1 };
          });
          this.pnl = { totalRevenue: 0, totalCOGS: 0, grossProfit: 0, totalExpenses: 0, netProfit: 0 };
          this.currentView = 'pnl';
        },
        get filterDateRangeText() {
          if (this.filterStartDate && this.filterEndDate) return `(from ${this.formatDate(this.filterStartDate)} to ${this.formatDate(this.filterEndDate)})`;
          return '(all time)';
        },
        getPbAdminEditUrl(collectionName, recordId) {
          return `${this.pbAdminUrl}/_/collections/${collectionName}/records/${recordId}`;
        },
        getPbAdminCreateUrl(collectionName) {
          return collectionName ? `${this.pbAdminUrl}/_/collections/${collectionName}/records/new` : '#';
        },
        async switchView(viewName) {
          this.currentView = viewName;
          await this.refreshCurrentViewData();
        },
        async refreshCurrentViewData() {
          if (!this.isAdminAuth) return;
          if (this.currentView === 'pnl') {
            await this.fetchPnlData();
          } else {
            const collectionName = this.getCollectionNameForView(this.currentView);
            if (collectionName) {
              const currentDataState = this.data[collectionName];
              if (currentDataState) currentDataState.page = 1;
              await this.fetchPaginatedData(collectionName, 1);
            }
          }
        },
        getCollectionNameForView(viewKey) {
          const map = { animals: 'sheep_log' };
          return map[viewKey] || viewKey;
        },
        getViewTitle(viewKey) {
          const titles = {
            pnl: 'P&L Summary',
            orders: 'Orders',
            animals: 'Animals',
            animal_events: 'Animal Events',
            products: 'Products',
            expenses: 'Expenses',
            settings: 'Settings'
          };
          return titles[viewKey] || 'Data';
        },
        getSingularViewTitle(viewKey) {
          const titles = {
            orders: 'Order',
            animals: 'Animal',
            animal_events: 'Event',
            products: 'Product',
            expenses: 'Expense'
          };
          return titles[viewKey] || '';
        },
        async fetchPnlData() {
          if (!this.isAdminAuth) return;
          this.loading.pnl = true;
          let ordersForPnl = [];
          let expensesForPnl = [];
          let orderFilter = `payment_status = "paid_confirmed"`;
          let expenseFilter = '';
          if (this.filterStartDate && this.filterEndDate) {
            const start = `${this.filterStartDate} 00:00:00.000Z`;
            const end = `${this.filterEndDate} 23:59:59.999Z`;
            orderFilter += ` && created >= "${start}" && created <= "${end}"`;
            expenseFilter = `expense_date >= "${this.filterStartDate}" && expense_date <= "${this.filterEndDate}"`;
          }
          try {
            ordersForPnl = await this.pb.collection('orders').getFullList({ filter: orderFilter, sort: '-created' });
            const expenseParams = { sort: '-expense_date' };
            if (expenseFilter) expenseParams.filter = expenseFilter;
            expensesForPnl = await this.pb.collection('expenses').getFullList(expenseParams);
            this.calculatePnlSummary(ordersForPnl, expensesForPnl);
          } catch (error) {
            this.handleFetchError(error, 'P&L');
          } finally {
            this.loading.pnl = false;
          }
        },
        async fetchPaginatedData(collectionName, page = 1) {
          if (!this.isAdminAuth) return;
          this.loading.current = true;
          const currentDataState = this.data[collectionName];
          if (!currentDataState) {
            console.error(`Data state for ${collectionName} is undefined. View key: ${this.currentView}`);
            this.loading.current = false;
            return;
          }
          currentDataState.page = page;
          const params = { page: page, perPage: currentDataState.perPage, sort: '-created' };
          let expandFields = [];
          const viewColumns = this.getColumnsForView(this.currentView);
          if (viewColumns) {
            viewColumns.forEach(col => {
              if (col.type === 'expand' && col.expandedField) {
                expandFields.push(col.expandedField);
              }
            });
          }
          if (expandFields.length > 0) params.expand = expandFields.join(',');
          if (collectionName === 'settings') {
            params.sort = 'created';
          } else if (collectionName === 'orders') {
            params.sort = '-created';
            let filter = 'id != ""';
            if (this.filterStartDate && this.filterEndDate && ['orders'].includes(this.currentView)) {
              filter += ` && created >= "${this.filterStartDate} 00:00:00.000Z" && created <= "${this.filterEndDate} 23:59:59.999Z"`;
            }
            params.filter = filter;
          } else if (collectionName === 'expenses') {
            params.sort = '-expense_date';
            if (this.filterStartDate && this.filterEndDate && ['expenses'].includes(this.currentView)) {
              params.filter = `expense_date >= "${this.filterStartDate}" && expense_date <= "${this.filterEndDate}"`;
            }
          } else if (collectionName === 'sheep_log') {
            params.sort = '-acquisition_date';
          } else if (collectionName === 'animal_events') {
            params.sort = '-event_date';
          } else if (collectionName === 'products') {
            params.sort = 'type_key,sort_order_variant';
          }
          try {
            const resultList = await this.pb.collection(collectionName).getList(page, currentDataState.perPage, params);
            currentDataState.items = resultList.items;
            currentDataState.totalPages = resultList.totalPages;
            currentDataState.totalItems = resultList.totalItems;
          } catch (error) {
            this.handleFetchError(error, collectionName);
            currentDataState.items = [];
            currentDataState.totalPages = 1;
            currentDataState.totalItems = 0;
          } finally {
            this.loading.current = false;
          }
        },
        handleFetchError(error, context) {
          console.error(`Error fetching ${context}:`, error);
          this.authError = `Failed to load data for ${context}. Check console for details.`;
          if (error.status === 401 || error.status === 403) {
            this.isAdminAuth = false;
            this.authError = 'Session expired or unauthorized. Please login again.';
          }
        },
        async changePage(collectionName, newPage) {
          const currentDataState = this.data[collectionName];
          if (currentDataState && newPage >= 1 && newPage <= currentDataState.totalPages) {
            await this.fetchPaginatedData(collectionName, newPage);
          }
        },
        calculatePnlSummary(ordersData, expensesData) {
          this.pnl.totalRevenue = ordersData.reduce((sum, order) => sum + (order.total_amount_due_egp || 0), 0);
          this.pnl.totalCOGS = ordersData.reduce((sum, order) => sum + (order.cost_of_animal_egp || 0), 0);
          this.pnl.grossProfit = this.pnl.totalRevenue - this.pnl.totalCOGS;
          this.pnl.totalExpenses = expensesData.reduce((sum, expense) => sum + (expense.amount_egp || 0), 0);
          this.pnl.netProfit = this.pnl.grossProfit - this.pnl.totalExpenses;
        },
        async deleteRecord(collectionName, recordId, recordIdentifier) {
          if (!this.isAdminAuth) {
            alert("Authentication required.");
            return;
          }
          const displayIdentifier = String(recordIdentifier).replace(/"/g, "'");
          const singularName = (this.getSingularViewTitle(this.currentView) || collectionName.replace(/_/g, ' ').replace(/s$/, '')).toLowerCase();
          if (!confirm(`Are you sure you want to delete this ${singularName}: "${displayIdentifier}"? This action cannot be undone.`)) return;
          this.loading.current = true;
          try {
            await this.pb.collection(collectionName).delete(recordId);
            console.info(`${singularName} "${displayIdentifier}" deleted successfully.`);
            const currentDataState = this.data[collectionName];
            let pageToFetch = currentDataState.page;
            if (currentDataState.items.length === 1 && pageToFetch > 1) {
              pageToFetch--;
            }
            await this.fetchPaginatedData(collectionName, pageToFetch);
            if (['orders', 'expenses', 'sheep_log'].includes(collectionName)) {
              await this.fetchPnlData();
            }
          } catch (error) {
            this.handleFetchError(error, `deleting from ${collectionName}`);
          } finally {
            this.loading.current = false;
          }
        },
        formatDate(dateString, options = { year: 'numeric', month: 'short', day: 'numeric' }) {
          if (!dateString) return 'N/A';
          try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString(undefined, options);
          } catch (e) {
            return dateString;
          }
        },
        formatCurrency(amount, currency = 'EGP', digits = 0) {
          if (amount === null || typeof amount === 'undefined') return 'N/A';
          const numAmount = Number(amount);
          if (isNaN(numAmount)) return 'N/A';
          const options = { style: 'currency', currency: currency, minimumFractionDigits: digits, maximumFractionDigits: digits };
          try {
            return new Intl.NumberFormat('en-US', options).format(numAmount);
          } catch (e) {
            return `${currency} ${numAmount.toFixed(digits)}`;
          }
        },
        escapeHtml(unsafe) {
          if (unsafe === null || typeof unsafe === 'undefined') return '';
          return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        },
        getColumnsForView(viewKey) {
          const collectionName = this.getCollectionNameForView(viewKey);
          return this.columnsConfig[collectionName] || [];
        },
        renderCellContent(item, column, collectionName) {
          let value = item[column.key];
          if (column.type === 'expand' && column.expandedField) {
            value = item.expand && item.expand[column.expandedField] ? item.expand[column.expandedField][column.displayField] : (item[column.expandedField] ? '...' : (column.placeholder || 'N/A'));
          }
          const cellContentClasses = ['cell-content'];
          if (!column.cellMaxWidth) cellContentClasses.push('no-truncate');
          const titleAttributeValue = (typeof value === 'object' && value !== null) ? JSON.stringify(value) : value;
          const escapedTitle = this.escapeHtml(titleAttributeValue);
          const contentSpan = `<span class="${cellContentClasses.join(' ')}" ${column.cellMaxWidth ? `style="max-width:${column.cellMaxWidth};"` : ''} title="${escapedTitle}">`;

          const escapeForJsSingleQuote = (str) => {
            if (str === null || typeof str === 'undefined') return '';
            return String(str)
              .replace(/\\/g, '\\\\')
              .replace(/'/g, "\\'")
              .replace(/\n/g, "\\n")
              .replace(/\r/g, "\\r")
              .replace(/\u2028/g, "\\u2028")
              .replace(/\u2029/g, "\\u2029");
          };

          switch (column.type) {
            case 'text':
              const textValue = column.format ? column.format(value) : (value !== null && typeof value !== 'undefined' ? this.escapeHtml(value) : 'N/A');
              return `${contentSpan}${textValue}</span>`;
            case 'date':
              return `${contentSpan}${this.formatDate(value)}</span>`;
            case 'currency':
              return `${contentSpan}${this.formatCurrency(value, column.currency, column.digits)}</span>`;
            case 'number':
              return `${contentSpan}${(typeof value === 'number' ? value.toLocaleString() : 'N/A')}</span>`;
            case 'boolean':
              return `${contentSpan}${value ? 'Yes' : 'No'}</span>`;
            case 'status_pill':
              const rawStatus = item[column.key];
              const statusClass = rawStatus ? String(rawStatus).toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '') : 'default';
              const statusText = rawStatus ? this.escapeHtml(String(rawStatus).replace(/_/g, ' ')) : 'N/A';
              return `<span class="status-pill ${this.escapeHtml(statusClass)}">${statusText}</span>`;
            case 'expand':
              return `${contentSpan}${this.escapeHtml(value)}</span>`;
            case 'actions':
            case 'actions_animal': {
              const editUrl = this.getPbAdminEditUrl(collectionName, item.id);
              let identifierValue;
              if (typeof column.identifierField === 'function') {
                identifierValue = column.identifierField(item);
              } else {
                identifierValue = item[column.identifierField] || item.id;
              }
              const jsEscapedCollectionName = escapeForJsSingleQuote(collectionName);
              const jsEscapedItemId = escapeForJsSingleQuote(item.id);
              const jsEscapedIdentifier = escapeForJsSingleQuote(identifierValue);
              const deleteAction = `$data.deleteRecord('${jsEscapedCollectionName}', '${jsEscapedItemId}', '${jsEscapedIdentifier}')`;
              let buttonsHtml = `<a href="${editUrl}" target="_blank" class="btn bp btn-small">Edit</a> 
                                 <button @click="${deleteAction}" class="btn btn-delete btn-small">Del</button>`;
              if (column.type === 'actions_animal') {
                const addEventUrl = `${this.getPbAdminCreateUrl('animal_events')}?animal_id=${item.id}`;
                buttonsHtml += ` <a href="${addEventUrl}" target="_blank" class="btn bp btn-small" title="Add Event">+Evt</a>`;
              }
              return buttonsHtml;
            }
            default:
              return `${contentSpan}${(value !== null && typeof value !== 'undefined' ? this.escapeHtml(value) : 'N/A')}</span>`;
          }
        }
      }));
    });
  </script>
</body>
</html>