document.addEventListener('alpine:init',()=>{const iF={customer_name:"",customer_phone:"",customer_email:"",customer_country:"Egypt",delivery_option:"self_pickup_or_internal_distribution",delivery_city_id:"",delivery_address:"",delivery_instructions:"",delivery_time_slot:"9AM-11AM",payment_method:"vodafone_cash",terms_agreed:!1,total_service_fee_egp:0,delivery_fee_egp:0,online_payment_fee_applied_egp:0,final_total_egp:0,user_id:null},iU={itemKey:null,serviceOption:"standard_service",sacrificeDay:"day1_10_dhul_hijjah",distribution:{choice:"me",splitOption:"",customSplitText:""},isBuyNowIntent:!1},pM=[{id:'online_card',title:'Online Payment',imgSrc:'card_payment.svg'},{id:'vodafone_cash',title:'Vodafone Cash',imgSrc:'vodafonecash.png'},{id:'instapay',title:'InstaPay',imgSrc:'instapay.svg'},{id:'fawry',title:'Fawry',imgSrc:'fawry.svg'},{id:'bank_transfer',title:'Bank Transfer',imgSrc:'bank_transfer.svg'},{id:'western_union',title:'Western Union',imgSrc:'western_union.svg'},{id:'moneygram',title:'MoneyGram',imgSrc:'moneygram.svg'},{id:'paypal',title:'PayPal',imgSrc:'paypal.svg'},{id:'revolut',title:'Revolut',imgSrc:'revolut.svg'},{id:'monzo',title:'Monzo',imgSrc:'monzo.svg'},{id:'cod',title:'Cash on Delivery',imgSrc:'cod.svg'}],sD={"day1_10_dhul_hijjah":{"en":"Day 1 of Eid (10th Dhul Hijjah)","ar":"اليوم الأول (10 ذو الحجة)"},"day2_11_dhul_hijjah":{"en":"Day 2 of Eid (11th Dhul Hijjah)","ar":"اليوم الثاني (11 ذو الحجة)"},"day3_12_dhul_hijjah":{"en":"Day 3 of Eid (12th Dhul Hijjah)","ar":"اليوم الثالث (12 ذو الحجة)"},"day4_13_dhul_hijjah":{"en":"Day 4 of Eid (13th Dhul Hijjah)","ar":"اليوم الرابع (13 ذو الحجة)"}};Alpine.data('sheepLand',()=>({ld:{init:!0,status:!1,checkout:!1,auth:!1,orders:!1,addingToCart:null},st:{xchgRates:{EGP:{rate_from_egp:1,symbol:"LE",is_active:!0}},defCurr:"EGP",waNumRaw:"",waNumDisp:"",promoEndISO:new Date().toISOString(),promoDiscPc:0,promoActive:!1,servFeeEGP:0,delAreas:[],payDetails:{},enable_udheya_section:!0,enable_livesheep_section:!0,enable_meat_section:!0,enable_gatherings_section:!0,slaughter_location_gmaps_url:"",online_payment_fee_egp:0,refundPolicyHTMLContent:"<p>Loading policy...</p>",app_email_sender_address:"noreply@sheepland.eg",app_email_sender_name:"Sheep Land",site_title_en:"Sheep Land",site_title_ar:"أرض الأغنام",site_desc_en:"Premium live sheep & Udheya",site_desc_ar:"مواشي وأضاحي فاخرة"},pO:{udheya:[],livesheep_general:[],meat_cuts:[],gathering_package:[]},sBS:'',sBrS:'',sMW:{},sQ:'',sS:!1,sEO:!1,sMC:!1,cI:[],iMNO:!1,iCO:!1,iRMO:!1,iOSMO:!1,iUCMO:!1,cP:'home',cL:"en",cr:"EGP",cd:{days:"00",hours:"00",mins:"00",secs:"00",ended:!1},cdT:null,cF:JSON.parse(JSON.stringify(iF)),tUC:JSON.parse(JSON.stringify(iU)),aE:null,uAE:"",aCM:{text:null,isError:!1,pageContext:''},sR:null,sNF:!1,lOID:"",oC:{show:!1,orderID:"",totalEgp:0,items:[],paymentInstructions:"",customerEmail:""},cU:null,au:{email:"",password:"",passwordConfirm:"",name:"",phone:"",country:"Egypt",view:'login'},uO:[],rAL:null,er:{},eM:{required:{en:"This field is required.",ar:"هذا الحقل مطلوب."},email:{en:"Please enter a valid email address.",ar:"يرجى إدخال بريد إلكتروني صحيح."},phone:{en:"Please enter a valid phone number.",ar:"يرجى إدخال رقم هاتف صحيح."},terms_agreed:{en:"You must agree to the terms and refund policy.",ar:"يجب أن توافق على الشروط وسياسة الاسترداد."}},aC:[],iDFV:!1,cUI:null,get sacrificeDayMapInternal(){return sD},get availPayMeths(){return pM},get cartItemCount(){return this.cI.reduce((s,i)=>s+i.quantity,0)},dTS:[{value:"9AM-11AM",label:"9 AM - 11 AM"},{value:"11AM-1PM",label:"11 AM - 1 PM"},{value:"1PM-3PM",label:"1 PM - 3 PM"},{value:"3PM-5PM",label:"3 PM - 5 PM"},{value:"5PM-7PM",label:"5 PM - 7 PM"},{value:"7PM-9PM",label:"7 PM - 9 PM"}],pageTitle(){const t={home:this.st.site_title_en||"Premium Live Sheep & Udheya",udheya:"Premium Udheya Collection",livesheep:"Live Sheep",meat:"Fresh Meat & Cuts",gatherings:"Event & Gathering Packages",checkout:"Secure Checkout",auth:"Account Access",account:"My Account"};return t[this.cP]||t.home},async initApp(){this.ld.init=!0;this.dCPFU();const pb=new PocketBase('/');this.pb=pb;pb.authStore.isValid&&pb.authStore.model?this.cU=pb.authStore.model:(pb.authStore.clear(),this.cU=null);this.lCFS();try{const rs=await pb.collection('settings').getFirstListItem('id!=""');rs&&Object.assign(this.st,{xchgRates:rs.xchgRates||this.st.xchgRates,defCurr:rs.defCurr||this.st.defCurr,waNumRaw:rs.waNumRaw||"",waNumDisp:rs.waNumDisp||"",promoEndISO:rs.promoEndISO||new Date().toISOString(),promoDiscPc:Number(rs.promoDiscPc)||0,promoActive:typeof rs.promoActive==='boolean'?rs.promoActive:!1,servFeeEGP:Number(rs.servFeeEGP)||0,delAreas:Array.isArray(rs.delAreas)?rs.delAreas:[],payDetails:typeof rs.payDetails==='object'&&rs.payDetails!==null?rs.payDetails:{},enable_udheya_section:typeof rs.enable_udheya_section==='boolean'?rs.enable_udheya_section:!0,enable_livesheep_section:typeof rs.enable_livesheep_section==='boolean'?rs.enable_livesheep_section:!0,enable_meat_section:typeof rs.enable_meat_section==='boolean'?rs.enable_meat_section:!0,enable_gatherings_section:typeof rs.enable_gatherings_section==='boolean'?rs.enable_gatherings_section:!0,slaughter_location_gmaps_url:rs.slaughter_location_gmaps_url||"",online_payment_fee_egp:Number(rs.online_payment_fee_egp)||0,refundPolicyHTMLContent:rs.refund_policy_html||this.gDRPH(),app_email_sender_address:rs.app_email_sender_address||"noreply@sheepland.eg",app_email_sender_name:rs.app_email_sender_name||"Sheep Land",site_title_en:rs.site_title_en||"Sheep Land",site_title_ar:rs.site_title_ar||"أرض الأغنام",site_desc_en:rs.site_desc_en||"Premium live sheep & Udheya",site_desc_ar:rs.site_desc_ar||"مواشي وأضاحي فاخرة"});const aP=await pb.collection('products').getFullList({filter:'is_active = true',sort:'+sort_order_type,+sort_order_variant'}),cP=(p,f)=>{const cp=p.filter(x=>x.product_category===f),g={};cp.forEach(x=>{g[x.type_key]||(g[x.type_key]={valKey:x.type_key,nameEn:x.type_name_en,nameAr:x.type_name_ar,descEn:x.type_description_en,descAr:x.type_description_ar,priceKgEgp:x.price_per_kg_egp||0,wps:[]});g[x.type_key].wps.push({itemKey:x.item_key,varIdPb:x.id,nameENSpec:x.variant_name_en,nameARSpec:x.variant_name_ar,wtRangeEn:x.weight_range_text_en,wtRangeAr:x.weight_range_text_ar,avgWtKg:x.avg_weight_kg,priceEGP:x.base_price_egp,stock:x.stock_available_pb,isActive:x.is_active,is_premium:x.is_premium,origin_farm:x.origin_farm,product_category:x.product_category,type_key:x.type_key,type_name_en:x.type_name_en,type_name_ar:x.type_name_ar,descEn:x.type_description_en,descAr:x.type_description_ar,breed_info_en:x.breed_info_en,breed_info_ar:x.breed_info_ar})});return Object.values(g)};this.pO.udheya=cP(aP,'udheya');this.pO.livesheep_general=cP(aP,'livesheep_general');this.pO.meat_cuts=cP(aP,'meat_cuts');this.pO.gathering_package=cP(aP,'gathering_package');let c=[];(this.st.delAreas||[]).forEach(g=>{g.cities&&Array.isArray(g.cities)&&g.cities.length>0?g.cities.forEach(x=>{c.push({id:`${g.id}_${x.id}`,nameEn:`${g.name_en} - ${x.name_en}`,nameAr:`${g.name_ar} - ${x.name_ar}`,delFeeEgp:x.delivery_fee_egp,govId:g.id})}):g.delivery_fee_egp!==undefined&&c.push({id:g.id,nameEn:g.name_en,nameAr:g.name_ar,delFeeEgp:g.delivery_fee_egp,govId:g.id})});this.aC=c.sort((a,b)=>a.nameEn.localeCompare(b.nameEn))}catch(e){this.aE=String(e.message||"Could not load initial application data.");this.uAE="Error loading essential data. Please try refreshing the page."}this.cr=this.st.defCurr||"EGP";this.sCD();this.cAE();this.cP==='checkout'?this.iCP():this.cP==='auth'?this.iAP():this.cP==='account'?this.iAcP():this.cFT();this.ld.init=!1;window.addEventListener('hashchange',()=>this.dCPFU())},dCPFU(){const h=window.location.hash.replace(/^#/,''),vP=['home','udheya','livesheep','meat','gatherings','checkout','auth','account'];h&&vP.includes(h.split('?')[0])?this.cP=h.split('?')[0]:this.cP='home';this.uPS()},uPS(){this.cP!=='checkout'&&this.oC.show&&(this.oC={show:!1,orderID:"",totalEgp:0,items:[],paymentInstructions:"",customerEmail:""});this.cP==='checkout'?this.iCP():this.cP==='auth'?this.iAP():this.cP==='account'&&this.iAcP();this.$nextTick(()=>{const m=document.querySelector(`main > section[x-show*="${this.cP}"]`);if(m){let o=document.querySelector('.site-head')?.offsetHeight||0;window.scrollTo({top:m.offsetTop-o-10,behavior:'smooth'})}else window.scrollTo({top:0,behavior:'smooth'})})},nTS(t,a=null){t.startsWith('#')&&(a=t.substring(1),t=this.cP);const p=t.split('?')[0];if(this.cP!==p)this.cP=p,window.location.hash=t;else if(a){const e=document.getElementById(a);if(e){let o=document.querySelector('.site-head')?.offsetHeight||0;window.scrollTo({top:e.getBoundingClientRect().top+window.pageYOffset-o-10,behavior:'smooth'})}}else{const m=document.querySelector(`main > section[x-show*="${this.cP}"]`);if(m){let o=document.querySelector('.site-head')?.offsetHeight||0;window.scrollTo({top:m.offsetTop-o-10,behavior:'smooth'})}else window.scrollTo({top:0,behavior:'smooth'})}},gDRPH(){return`<div class="bil-row"><p class="en">Welcome to Sheep Land. Please read our policy carefully.</p><p class="ar" dir="rtl">مرحباً بكم في أرض الأغنام. يرجى قراءة سياستنا بعناية.</p></div>`},oC(){this.iCO=!0;document.body.classList.add('overflow-hidden')},cC(){this.iCO=!1;document.body.classList.remove('overflow-hidden')},aITC(p,u=null){this.ld.addingToCart=p.itemKey;this.aCM={text:null,isError:!1,pageContext:this.cP};if(!p||!p.itemKey||p.stock<=0){this.aCM={text:{en:'This item is out of stock.',ar:'هذا المنتج غير متوفر.'},isError:!0,pageContext:this.cP};this.ld.addingToCart=null;setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000);return}const iU=p.product_category==='udheya',eII=this.cI.findIndex(i=>i.itemKey===p.itemKey);if(eII>-1){if(iU){this.aCM={text:{en:'This Udheya is already in your cart.',ar:'هذه الأضحية موجودة بالفعل في سلتك.'},isError:!0,pageContext:this.cP};this.ld.addingToCart=null;setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},5000);return}if(this.cI[eII].quantity<p.stock)this.cI[eII].quantity++;else{this.aCM={text:{en:'Stock limit reached.',ar:'وصلت إلى الحد الأقصى للمخزون.'},isError:!0,pageContext:this.cP};this.ld.addingToCart=null;setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000);return}}else{const nI={...p,quantity:1,uniqueIdInCart:Date.now().toString(36)+Math.random().toString(36).substring(2)};iU&&u&&(nI.udheya_details={...u});this.cI.push(nI)}this.sCTS();this.cFT();this.aCM={text:{en:`${p.nameENSpec} added to cart.`,ar:`تمت إضافة ${p.nameARSpec} إلى السلة.`},isError:!1,pageContext:this.cP};this.ld.addingToCart=null;this.iUCMO&&u&&!u.isBuyNowIntent&&this.cUC();setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000)},async bN(p,u=null){this.ld.addingToCart=p.itemKey;this.aCM={text:null,isError:!1,pageContext:this.cP};this.cAE();if(!p||!p.itemKey||p.stock<=0){this.aCM={text:{en:'This item is out of stock.',ar:'هذا المنتج غير متوفر.'},isError:!0,pageContext:this.cP};this.ld.addingToCart=null;setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000);return}const bNI={...p,quantity:1,uniqueIdInCart:Date.now().toString(36)+Math.random().toString(36).substring(2)};if(p.product_category==='udheya'){if(!u){this.oUC(p,!0);this.ld.addingToCart=null;return}bNI.udheya_details={...u}}try{localStorage.setItem('sheepLandBuyNowItem',JSON.stringify(bNI))}catch(e){this.uAE="Could not proceed with Buy Now. Please try adding to cart.";this.ld.addingToCart=null;return}this.ld.addingToCart=null;this.iUCMO&&this.cUC();this.nTS('checkout?buyNow=true')},rFC(u){this.cI=this.cI.filter(i=>i.uniqueIdInCart!==u);this.sCTS();this.cFT()},uCQ(u,n){const iI=this.cI.findIndex(i=>i.uniqueIdInCart===u);if(iI>-1){const i=this.cI[iI],q=Math.max(1,parseInt(n)||1);if(i.product_category==='udheya'&&q>1)this.aCM={text:{en:'Only one of each Udheya can be added.',ar:'يمكن إضافة أضحية واحدة فقط من كل نوع.'},isError:!0,pageContext:'cart'},i.quantity=1,setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000);else if(q<=i.stock)i.quantity=q,this.aCM={text:null,isError:!1,pageContext:''};else i.quantity=i.stock,this.aCM={text:{en:'Requested quantity exceeds available stock.',ar:'الكمية المطلوبة تتجاوز المخزون المتاح.'},isError:!0,pageContext:'cart'},setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000)}this.sCTS();this.cFT()},gSFI(c){let t=c.priceEGP*c.quantity;return c.product_category==='udheya'&&c.udheya_details?.serviceOption==='standard_service'&&(t+=this.st.servFeeEGP||0),t},cCS(){return this.cI.reduce((t,i)=>t+i.priceEGP*i.quantity,0)},cTSF(){return this.cI.reduce((t,i)=>i.product_category==='udheya'&&i.udheya_details?.serviceOption==='standard_service'?t+(this.st.servFeeEGP||0):t,0)},cCT(){return this.cCS()+this.cTSF()},sCTS(){try{localStorage.setItem('sheepLandCart-'+(this.cU?.id||'guest'),JSON.stringify(this.cI))}catch(e){console.error("Error saving cart to localStorage",e)}},lCFS(){try{const s=localStorage.getItem('sheepLandCart-'+(this.cU?.id||'guest'));s?this.cI=JSON.parse(s):this.cI=[]}catch(e){console.error("Error loading cart from localStorage",e);this.cI=[];localStorage.removeItem('sheepLandCart-'+(this.cU?.id||'guest'))}this.cFT()},clC(){this.cI=[];this.sCTS();this.cFT()},oUC(i,b=!1){if(!i.isActive||i.stock<=0){this.aCM={text:{en:'This Udheya is out of stock.',ar:'هذه الأضحية غير متوفرة حالياً.'},isError:!0,pageContext:'udheya'};setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000);return}this.cUI={...i};this.tUC=JSON.parse(JSON.stringify(iU));this.tUC.itemKey=i.itemKey;this.tUC.isBuyNowIntent=b;this.iUCMO=!0;document.body.classList.add('overflow-hidden')},cUC(){this.iUCMO=!1;this.cUI=null;const k=['udheya_service_config','udheya_sacrifice_day_config','udheya_distribution_choice_config','udheya_split_option_config'];k.forEach(x=>this.cE(x));document.body.classList.remove('overflow-hidden')},cUCAP(){if(!this.cUI)return;let v=!0;const k=['udheya_service_config','udheya_sacrifice_day_config','udheya_distribution_choice_config','udheya_split_option_config'];k.forEach(x=>this.cE(x));!this.tUC.serviceOption&&(this.sE('udheya_service_config','required'),v=!1);this.tUC.serviceOption==='standard_service'&&!this.tUC.sacrificeDay&&(this.sE('udheya_sacrifice_day_config','required'),v=!1);!this.tUC.distribution.choice&&(this.sE('udheya_distribution_choice_config','required'),v=!1);this.tUC.distribution.choice==='split'&&!this.tUC.distribution.splitOption&&(this.sE('udheya_split_option_config','required'),v=!1);this.tUC.distribution.choice==='split'&&this.tUC.distribution.splitOption==='custom'&&!this.tUC.distribution.customSplitText.trim()&&(this.sE('udheya_split_option_config',{en:'Please specify custom split details.',ar:'يرجى تحديد تفاصيل التقسيم المخصصة.'}),v=!1);v&&(this.tUC.isBuyNowIntent?this.bN(this.cUI,this.tUC):this.aITC(this.cUI,this.tUC))},gUCET(){const k=['udheya_service_config','udheya_sacrifice_day_config','udheya_distribution_choice_config','udheya_split_option_config'];for(const x of k)if(this.er[x])return this.cL==='ar'?this.er[x].ar:this.er[x].en;return''},oRM(){this.iRMO=!0;document.body.classList.add('overflow-hidden')},cRM(){this.iRMO=!1;document.body.classList.remove('overflow-hidden')},oOSM(){this.iOSMO=!0;document.body.classList.add('overflow-hidden');this.$nextTick(()=>this.$refs.lookupOrderIdInputModal?.focus())},cOSM(){this.iOSMO=!1;document.body.classList.remove('overflow-hidden');this.lOID='';this.sR=null;this.sNF=!1;this.cE('lookupOrderID')},sCD(){if(this.cdT)clearInterval(this.cdT);if(!this.st.promoActive||!this.st.promoEndISO){this.cd.ended=!0;return}const t=new Date(this.st.promoEndISO).getTime();if(isNaN(t)){this.cd.ended=!0;return}this.uCDD(t);this.cdT=setInterval(()=>this.uCDD(t),1000)},uCDD(t){const d=t-Date.now();if(d<0){this.cdT&&clearInterval(this.cdT);this.cd.days="00";this.cd.hours="00";this.cd.mins="00";this.cd.secs="00";this.cd.ended=!0;return}this.cd.ended=!1;this.cd.days=String(Math.floor(d/864e5)).padStart(2,'0');this.cd.hours=String(Math.floor(d%864e5/36e5)).padStart(2,'0');this.cd.mins=String(Math.floor(d%36e5/6e4)).padStart(2,'0');this.cd.secs=String(Math.floor(d%6e4/1e3)).padStart(2,'0')},fP(p,c){const cc=c||this.cr,ci=this.st?.xchgRates?.[cc];if(p==null||p===undefined||!ci||typeof ci.rate_from_egp!=='number')return`${ci?.symbol||(cc==='EGP'?'LE':'')} ---`;const cp=p*ci.rate_from_egp;return`${ci.symbol||(cc==='EGP'?'LE':cc)} ${cp.toFixed(ci.symbol==="LE"||ci.symbol==="ل.م"||cc==='EGP'||ci.symbol==="€"?0:2)}`},gBP(){const p={small:4500,medium:5500,large:6500};return p[this.sBS]||0},gBrP(){const p={small:5000,medium:6000,large:7000};return p[this.sBrS]||0},gBPr(){if(!this.sBS)return null;const w={small:'25-30',medium:'30-35',large:'35-40'};return{itemKey:`baladi_${this.sBS}`,varIdPb:`baladi_${this.sBS}`,nameENSpec:`Baladi Sheep - ${this.sBS.charAt(0).toUpperCase()+this.sBS.slice(1)}`,nameARSpec:`خروف بلدي - ${this.sBS==='small'?'صغير':this.sBS==='medium'?'متوسط':'كبير'}`,wtRangeEn:`${w[this.sBS]} kg`,wtRangeAr:`${w[this.sBS]} كجم`,priceEGP:this.gBP(),stock:10,isActive:!0,product_category:'udheya'}},gBrPr(){if(!this.sBrS)return null;const w={small:'25-30',medium:'30-35',large:'35-40'};return{itemKey:`barki_${this.sBrS}`,varIdPb:`barki_${this.sBrS}`,nameENSpec:`Barki Sheep - ${this.sBrS.charAt(0).toUpperCase()+this.sBrS.slice(1)}`,nameARSpec:`خروف برقي - ${this.sBrS==='small'?'صغير':this.sBrS==='medium'?'متوسط':'كبير'}`,wtRangeEn:`${w[this.sBrS]} kg`,wtRangeAr:`${w[this.sBrS]} كجم`,priceEGP:this.gBrP(),stock:10,isActive:!0,product_category:'udheya'}},tS(){this.sS=!this.sS;this.sS&&this.$nextTick(()=>{this.$refs.searchInput?.focus()})},uBP(){},uBrP(){},qBU(p){if(!p)return;const u={serviceOption:'standard_service',sacrificeDay:'day1_10_dhul_hijjah',distribution:{choice:'char'}},c={...p,udheya_details:u,quantity:1};this.cI.push(c);this.iCO=!0;this.aCM={text:{en:'Udheya added to cart! Proceed to checkout when ready.',ar:'تمت إضافة الأضحية للسلة! تابع للدفع عندما تكون جاهزًا.'},isError:!1,pageContext:'udheya'};setTimeout(()=>this.aCM={text:null,isError:!1,pageContext:''},3000)},gMP(i){const w=this.sMW[i.itemKey]||1;return(i.pricePerKg||i.priceEGP)*w},uMP(i){},gMIWW(i,s){if(s!=='meat')return i;const w=this.sMW[i.itemKey]||1;return{...i,nameENSpec:`${i.nameENSpec} - ${w} kg`,nameARSpec:`${i.nameARSpec} - ${w} كجم`,priceEGP:this.gMP(i),selectedWeight:w}},fP(){this.$nextTick()},get fPr(){if(!this.sQ||this.sQ.trim().length<2)return{};const q=this.sQ.toLowerCase().trim(),f={},n={udheya:{en:'Udheya',ar:'الأضحية'},livesheep_general:{en:'Live Sheep',ar:'الأغنام الحية'},meat_cuts:{en:'Fresh Meat',ar:'اللحوم الطازجة'},gathering_package:{en:'Gatherings',ar:'الولائم'}};Object.keys(this.pO).forEach(c=>{const m=[];this.pO[c].forEach(t=>{const i=t.wps.filter(x=>x.nameENSpec.toLowerCase().includes(q)||x.nameARSpec.includes(q)||t.nameEn.toLowerCase().includes(q)||t.nameAr.includes(q));i.length>0&&m.push(...i)});m.length>0&&(f[c]=m)});return f},gCDN(c){const n={udheya:{en:'Udheya',ar:'الأضحية'},livesheep_general:{en:'Live Sheep',ar:'الأغنام الحية'},meat_cuts:{en:'Fresh Meat',ar:'اللحوم الطازجة'},gathering_package:{en:'Gatherings',ar:'الولائم'}};return n[c]||{en:c,ar:c}},gSDI(s,a,l=this.cL){return!a?l==='ar'?"غير نشط":"Inactive":s===undefined||s===null||s<=0?l==='ar'?"نفذ المخزون":"Out of Stock":s<=5?l==='ar'?`متوفر: ${s} (كمية محدودة)`:`${s} Available (Limited)`:l==='ar'?`متوفر: ${s}`:`${s} Available`},iEV:e=>e?.trim()&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),iPV:p=>p?.trim()&&/^\+?[0-9\s\-()]{7,20}$/.test(p.trim()),sE(f,m,u=!0){this.er[f]=(typeof m==='string'?this.eM[m]||{en:m,ar:m}:m)||this.eM.required;u&&typeof this.er[f]==='object'?this.uAE=this.cL==='ar'?this.er[f].ar:this.er[f].en:u&&(this.uAE=String(this.er[f]))},cE(f){this.er[f]&&delete this.er[f];Object.keys(this.er).some(k=>this.er[k])||(this.uAE="",this.aE=null)},cAE(){this.er={};this.uAE="";this.aE=null},fR(r,s=!0){this.$nextTick(()=>{const t=this.$refs[r];t&&(t.focus({preventScroll:!s}),s&&setTimeout(()=>{try{t.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'})}catch(e){console.warn("ScrollIntoView failed for:",r,e)}},50))})},dO(){return[{val:'me',txtEn:'Deliver All to Me',txtAr:'توصيل الكل لي'},{val:'char',txtEn:'Donate All (Charity Distribution)',txtAr:'تبرع بالكل (توزيع خيري)'},{val:'split',txtEn:'Split Between Me & Charity',txtAr:'تقسيم بيني وبين الخير'}]},sOL(){return[{val:'1/3_me_2/3_charity_sl',txtEn:'1/3 for me, 2/3 charity',txtAr:'ثلث لي، ثلثان صدقة'},{val:'1/2_me_1/2_charity_sl',txtEn:'1/2 for me, 1/2 charity',txtAr:'نصف لي، نصف صدقة'},{val:'2/3_me_1/3_charity_sl',txtEn:'2/3 for me, 1/3 charity',txtAr:'ثلثان لي، ثلث صدقة'},{val:'all_me_custom_distro',txtEn:'All for me (I will distribute)',txtAr:'الكل لي (سأوزع بنفسي)'},{val:'custom',txtEn:'Custom (Specify)',txtAr:'مخصص (حدد)'}]},iAP(){this.cAE();this.cU?.id?this.nTS('account'):this.au.view='login'},async lU(){this.cAE();this.ld.auth=!0;try{const a=await this.pb.collection('users').authWithPassword(this.au.email,this.au.password);this.cU=a.record;this.cF.user_id=this.cU?.id||null;this.lCFS();this.ld.auth=!1;this.nTS(this.rAL||'account');this.rAL=null}catch(e){this.ld.auth=!1;this.sE('auth_login',{en:'Login failed. Please check credentials.',ar:'فشل الدخول. تحقق من البيانات.'})}},async rU(){this.cAE();this.ld.auth=!0;let v=!0;!this.au.name.trim()&&(this.sE('auth_name',{en:'Name is required.',ar:'الاسم مطلوب.'}),v=!1);!this.iEV(this.au.email)&&(this.sE('auth_email','email'),v=!1);this.au.password.length<8&&(this.sE('auth_password',{en:'Password must be at least 8 characters.',ar:'كلمة المرور يجب أن تكون 8 أحرف على الأقل.'}),v=!1);this.au.password!==this.au.passwordConfirm&&(this.sE('auth_passwordConfirm',{en:'Passwords do not match.',ar:'كلمات المرور غير متطابقة.'}),v=!1);if(!v){this.ld.auth=!1;return}try{const d={email:this.au.email,password:this.au.password,passwordConfirm:this.au.passwordConfirm,name:this.au.name,phone:this.au.phone,country:this.au.country,emailVisibility:!0};await this.pb.collection('users').create(d);this.er.auth_form_success={en:'Registration successful! Please login.',ar:'تم التسجيل بنجاح! يرجى تسجيل الدخول.'};this.ld.auth=!1;this.au.view='login';this.au.password="";this.au.passwordConfirm=""}catch(e){this.ld.auth=!1;this.sE('auth_register',{en:'Registration failed. This email might already be in use.',ar:'فشل التسجيل. قد يكون هذا البريد الإلكتروني مستخدمًا بالفعل.'})}},lOU(){this.pb.authStore.clear();this.cU=null;this.uO=[];this.cF=JSON.parse(JSON.stringify(iF));this.lCFS();this.nTS('home')},async iAcP(){this.cAE();if(!this.pb.authStore.isValid){this.rAL='account';this.nTS('auth');return}!this.cU&&this.pb.authStore.model&&(this.cU=this.pb.authStore.model);this.cU?.id&&await this.fUO()},async fUO(){if(!this.cU?.id)return;this.ld.orders=!0;this.cE('orders_fetch');try{const r=await this.pb.collection('orders').getFullList({filter:`user = "${this.cU.id}"`,sort:'-created'});this.uO=r.map(o=>({...o,order_status:o.order_status?.replace(/_/g," ")||"N/A",payment_status:o.payment_status?.replace(/_/g," ")||"N/A"}))}catch(e){this.sE('orders_fetch',{en:'Could not fetch your orders.',ar:'تعذر جلب طلباتك.'})}finally{this.ld.orders=!1}},iCP(){this.cAE();const u=new URLSearchParams(window.location.hash.split('?')[1]||''),b=u.get('buyNow')==='true';let n=null;if(b){try{const s=localStorage.getItem('sheepLandBuyNowItem');s&&(n=JSON.parse(s),this.cI=[n]);localStorage.removeItem('sheepLandBuyNowItem')}catch(e){console.error("Error loading Buy Now item",e)}}else this.lCFS();this.cU&&(this.cF.customer_name=this.cU.name||'',this.cF.customer_email=this.cU.email||'',this.cF.customer_phone=this.cU.phone||'');if(this.cI.length===0&&!this.oC.show){this.nTS('udheya');return}this.cF=JSON.parse(JSON.stringify(iF));this.cU?.id?(this.cF.customer_name=this.cU.name||"",this.cF.customer_email=this.cU.email||"",this.cF.customer_phone=this.cU.phone||"",this.cF.customer_country=this.cU.country||"Egypt",this.cF.user_id=this.cU.id):this.cF.user_id=null;this.uDFFC();this.cFT()},dNFC(){return this.cI.some(i=>{if(i.product_category==='udheya'){const d=i.udheya_details?.distribution?.choice,s=i.udheya_details?.distribution?.splitOption;return d==='me'||(d==='split'&&["1/3_me_2/3_charity_sl","1/2_me_1/2_charity_sl","2/3_me_1/3_charity_sl","all_me_custom_distro"].includes(s))}return['meat_cuts','livesheep_general','gathering_package'].includes(i.product_category)})},uDFFC(){this.cF.delivery_fee_egp=0;this.iDFV=!1;if(!this.dNFC()||!this.cF.delivery_city_id){this.cFT();return}const c=this.aC.find(x=>x.id===this.cF.delivery_city_id);c&&typeof c.delFeeEgp==='number'?(this.cF.delivery_fee_egp=c.delFeeEgp,this.iDFV=!1):c&&c.delFeeEgp===null?(this.iDFV=!0,this.cF.delivery_fee_egp=0):(this.iDFV=!0,this.cF.delivery_fee_egp=0);this.cFT()},cFT(){const s=this.cCS(),f=this.cTSF();this.cF.total_service_fee_egp=f;let d=0;this.dNFC()&&this.cF.delivery_fee_egp>0&&!this.iDFV&&(d=this.cF.delivery_fee_egp);let o=0;this.cF.payment_method==='online_card'&&this.st.online_payment_fee_egp>0&&(o=this.st.online_payment_fee_egp);this.cF.online_payment_fee_applied_egp=o;this.cF.final_total_egp=s+f+d+o},vCF(){this.cAE();let v=!0;!this.cF.customer_name.trim()&&(this.sE('customer_name','required'),v=!1);!this.iPV(this.cF.customer_phone)&&(this.sE('customer_phone','phone'),v=!1);!this.iEV(this.cF.customer_email)&&(this.sE('customer_email','email'),v=!1);this.dNFC()&&(!this.cF.delivery_city_id&&(this.sE('delivery_city_id','required'),v=!1),!this.cF.delivery_address.trim()&&(this.sE('delivery_address','required'),v=!1),!this.cF.delivery_time_slot&&(this.sE('delivery_time_slot',{en:'Please select a delivery time slot.',ar:'يرجى اختيار وقت التوصيل.'}),v=!1));!this.cF.payment_method&&(this.sE('payment_method','required'),v=!1);!this.cF.terms_agreed&&(this.sE('terms_agreed','terms_agreed'),v=!1);return v},async pO(){if(!this.vCF())return;this.ld.checkout=!0;this.uAE="";this.aE="";const l=this.cI.map(i=>{let li={item_key_pb:i.varIdPb,product_category:i.product_category,name_en:i.nameENSpec,name_ar:i.nameARSpec,quantity:i.quantity,price_egp_each:i.priceEGP,udheya_details:null};return i.product_category==='udheya'&&i.udheya_details&&(li.udheya_details=i.udheya_details),li});let dO="self_pickup_or_internal_distribution";this.dNFC()?dO=this.cF.customer_country?.toLowerCase()==='egypt'?"home_delivery":"international_shipping":(this.cF.delivery_city_id="",this.cF.delivery_address="",this.cF.delivery_instructions="",this.cF.delivery_time_slot="",this.cF.delivery_fee_egp=0);this.cFT();this.cF.user_id=this.cU?.id||null;const oP={order_id_text:`${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substring(2,7).toUpperCase()}`,user:this.cF.user_id,customer_name:this.cF.customer_name,customer_phone:this.cF.customer_phone,customer_email:this.cF.customer_email,customer_country:this.cF.customer_country||"Egypt",line_items:l,delivery_option:dO,delivery_city_id:this.cF.delivery_city_id,delivery_address:this.cF.delivery_address,delivery_instructions:this.cF.delivery_instructions,delivery_time_slot:this.cF.delivery_time_slot,payment_method:this.cF.payment_method,terms_agreed:this.cF.terms_agreed,selected_display_currency:this.cr,subtotal_amount_egp:this.cCS(),total_udheya_service_fee_egp:this.cF.total_service_fee_egp,delivery_fee_applied_egp:this.cF.delivery_fee_egp,online_payment_fee_applied_egp:this.cF.online_payment_fee_applied_egp,total_amount_due_egp:this.cF.final_total_egp};try{const cO=await this.pb.collection('orders').create(oP);this.oC.orderID=cO.order_id_text;this.oC.totalEgp=cO.total_amount_due_egp;this.oC.items=cO.line_items.map(li=>({...li}));this.oC.customerEmail=cO.customer_email;this.oC.paymentInstructions=this.gPIH(cO.payment_method,cO.total_amount_due_egp,cO.order_id_text);this.oC.show=!0;const u=new URLSearchParams(window.location.hash.split('?')[1]||''),b=u.get('buyNow')==='true';b||this.clC();localStorage.removeItem('sheepLandBuyNowItem');this.cF=JSON.parse(JSON.stringify(iF));this.sBWAN(cO);this.$nextTick(()=>{this.fR('orderConfTitle')})}catch(e){this.aE=String(e.data?.message||e.message||"Order placement failed.");this.uAE="An unexpected error occurred. Please check your selections or contact support."}finally{this.ld.checkout=!1}},gPIH(m,t,o){let i="";const p=this.fP(t),w=`https://wa.me/${this.st.waNumRaw}?text=Order%20Payment%20Confirmation%3A%20${o}`,c=`<a href="${w}" target="_blank" rel="noopener noreferrer" class="link-style">${this.st.waNumDisp||'WhatsApp'}</a>`;return m==='online_card'?i=`<div class="bil-row"><p class="en">Your order total is <strong>${p}</strong>. To complete payment, you will be contacted shortly. Order ID: <strong class="pay-ref">${o}</strong>.</p><p class="ar">إجمالي طلبك هو <strong>${p}</strong>. لإتمام الدفع، سنتصل بك قريبًا. رقم الطلب: <strong class="pay-ref">${o}</strong>.</p></div>`:m==='fawry'?i=`<div class="bil-row"><p class="en">Fawry: Pay <strong>${p}</strong>. Use Order ID <strong class="pay-ref">${o}</strong>. Due in 24h.</p><p class="ar">فوري: ادفع <strong>${p}</strong>. استخدم رقم الطلب <strong class="pay-ref">${o}</strong>. خلال 24س.</p></div>`:m==='vodafone_cash'?i=`<div class="bil-row"><p class="en">Vodafone Cash: Pay <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.vodafone_cash||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">فودافون كاش: ادفع <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.vodafone_cash||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='instapay'?i=`<div class="bil-row"><p class="en">InstaPay: Pay <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.instapay_ipn||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">إنستا باي: ادفع <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.instapay_ipn||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='revolut'?i=`<div class="bil-row"><p class="en">Revolut: Pay <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.revolut_details||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">ريفولوت: ادفع <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.revolut_details||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='monzo'?i=`<div class="bil-row"><p class="en">Monzo: Pay <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.monzo_details||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">مونزو: ادفع <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.monzo_details||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='paypal'?i=`<div class="bil-row"><p class="en">PayPal: Send <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.paypal_email||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">باي بال: أرسل <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.paypal_email||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='western_union'?i=`<div class="bil-row"><p class="en">Western Union: Send <strong>${p}</strong> to <strong class="pay-ref">${this.st.payDetails?.western_union_details||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">ويسترن يونيون: أرسل <strong>${p}</strong> إلى <strong class="pay-ref">${this.st.payDetails?.western_union_details||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='moneygram'?i=`<div class="bil-row"><p class="en">MoneyGram: Send <strong>${p}</strong> via <strong class="pay-ref">${this.st.payDetails?.moneygram_details||'N/A'}</strong>. Ref: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">موني جرام: أرسل <strong>${p}</strong> عبر <strong class="pay-ref">${this.st.payDetails?.moneygram_details||'غير متوفر'}</strong>. مرجع: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='bank_transfer'?i=`<div class="bil-row"><p class="en">Bank Transfer <strong>${p}</strong> to:</p><p class="ar">تحويل بنكي <strong>${p}</strong> إلى:</p></div><ul class="bank-dets"><li class="bil-row"><span class="en">Bank: <strong class="pay-ref">${this.st.payDetails?.bank_name||'N/A'}</strong></span><span class="ar">البنك: <strong class="pay-ref">${this.st.payDetails?.bank_name||'غير متوفر'}</strong></span></li><li class="bil-row"><span class="en">Acc No: <strong class="pay-ref">${this.st.payDetails?.bank_account_number||'N/A'}</strong></span><span class="ar">رقم الحساب: <strong class="pay-ref">${this.st.payDetails?.bank_account_number||'غير متوفر'}</strong></span></li></ul><div class="bil-row bank-note"><p class="en">Ref Order ID: <strong class="pay-ref">${o}</strong>. Confirm via ${c}.</p><p class="ar">مرجع الطلب: <strong class="pay-ref">${o}</strong>. أكد عبر ${c}.</p></div>`:m==='cod'&&(i=`<div class="bil-row"><p class="en">COD: Our team will call <strong>${this.cF.customer_phone}</strong> to confirm. Total Amount Due <strong>${p}</strong>. Order ID: <strong class="pay-ref">${o}</strong>.</p><p class="ar">الدفع عند الاستلام: سيتصل بك الفريق على <strong>${this.cF.customer_phone}</strong> للتأكيد. المجموع الكلي للطلب <strong>${p}</strong>. رقم الطلب: <strong class="pay-ref">${o}</strong>.</p></div>`),i},sBWAN(o){const i=o.line_items.map(x=>`• ${x.name_en} x${x.quantity} = ${this.fP(x.price_egp_each*x.quantity)}`).join('\n'),d=o.delivery_option==='home_delivery'?`\n📍 Delivery to: ${o.delivery_address}\n🏙️ Area: ${o.delivery_city_id}`:'\n📦 Self Pickup',m=`🆕 *NEW ORDER ALERT!*\n\n🔢 Order: #${o.order_id_text}\n👤 Customer: ${o.customer_name}\n📱 Phone: ${o.customer_phone}\n✉️ Email: ${o.customer_email}${d}\n\n🛒 *Items:*\n${i}\n\n💰 *Total: ${this.fP(o.total_amount_due_egp)}*\n💳 Payment: ${o.payment_method}\n\n⏰ Time: ${new Date().toLocaleString('en-EG')}`,b=this.st.businessWhatsApp||this.st.waNumRaw,w=`https://wa.me/${b}?text=${encodeURIComponent(m)}`;window.open(w,'_blank');navigator.clipboard.writeText(m).catch(()=>{})},async sSV(){this.cE('lookupOrderID');if(!(this.lOID||"").trim()){this.sE('lookupOrderID','required');this.$refs.lookupOrderIdInputModal?.focus();return}await this.cOS()},async cOS(){this.sR=null;this.sNF=!1;this.ld.status=!0;this.aE=null;this.uAE="";const i=(this.lOID||"").trim();try{const r=await this.pb.collection('orders').getList(1,1,{filter:`order_id_text = "${this.pb.utils.escapeFieldValue(i)}"`});if(r.items&&r.items.length>0){const o=r.items[0];this.sR={orderIdTxt:o.order_id_text,customer_name:o.customer_name,order_status:o.order_status?.replace(/_/g," ")||"N/A",payment_status:o.payment_status?.replace(/_/g," ")||"N/A",line_items:o.line_items||[],total_amount_due_egp:o.total_amount_due_egp,payment_method:o.payment_method,delivery_option:o.delivery_option,delivery_address:o.delivery_address,delivery_area_name_en:o.delivery_area_name_en,delivery_area_name_ar:o.delivery_area_name_ar}}else this.sNF=!0,this.uAE="No order found with that ID."}catch(e){this.aE=String(e.message);this.uAE="Could not get order status. Please check details or contact support.";this.sNF=!0}finally{this.ld.status=!1}}}));Alpine.data('businessStats',()=>({tO:0,tR:0,aC:0,pI:'-',pb:null,async init(){this.pb=this.$root.pb||new PocketBase('/');await this.fTS()},async fTS(){if(!this.pb)return;try{const t=new Date().toISOString().split('T')[0],o=await this.pb.collection('orders').getList(1,50,{filter:`created >= '${t} 00:00:00'`,sort:'-created'});this.tO=o.totalItems;this.tR=o.items.reduce((s,x)=>s+(x.total_amount_due_egp||0),0);const u=new Set(o.items.map(x=>x.user||x.customer_email));this.aC=u.size;const i={};o.items.forEach(x=>{x.line_items&&Array.isArray(x.line_items)&&x.line_items.forEach(l=>{const n=l.name_en||'Unknown';i[n]=(i[n]||0)+l.quantity})});const p=Object.entries(i).sort((a,b)=>b[1]-a[1])[0];this.pI=p?p[0]:'-'}catch(e){console.error('Failed to fetch stats:',e)}},fP(a){return this.$root.fP?this.$root.fP(a):`${a} EGP`}}));document.addEventListener('keydown',e=>{const a=document.querySelector('[x-data="sheepLand"]')?._x_dataStack?.[0];if(!a)return;if(e.target.matches('input, textarea, select'))return;switch(e.key.toLowerCase()){case'c':!e.metaKey&&!e.ctrlKey&&(e.preventDefault(),a.iCO=!a.iCO);break;case'o':!e.metaKey&&!e.ctrlKey&&(e.preventDefault(),a.oOSM());break;case'escape':a&&(a.iCO=!1,a.iOSMO=!1,a.iUCMO=!1,a.sS=!1);break;case'/':if(!e.metaKey&&!e.ctrlKey){e.preventDefault();const p=document.querySelector('[x-data="sheepLand"]')?._x_dataStack?.[0];p&&(p.sS=!0,setTimeout(()=>{document.querySelector('.search-input-header')?.focus()},100))}break}});let eIS=!1;document.addEventListener('mouseleave',e=>{if(e.clientY<=0&&!eIS){const a=document.querySelector('[x-data="sheepLand"]')?._x_dataStack?.[0];a&&a.cI.length>0&&!a.iCO&&(eIS=!0,a.sEO=!0,setTimeout(()=>a.sEO=!1,10000))}})});