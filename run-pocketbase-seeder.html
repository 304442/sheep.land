<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PocketBase Data Seeder</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #5D4037; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .important { color: #c00; font-weight: bold; border: 1px solid #fcc; background-color: #ffe0e0; padding: 10px; border-radius: 4px; margin-bottom: 15px;}
        .log-output { margin-top: 20px; padding: 10px; background-color: #272822; color: #f8f8f2; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .log-output .info { color: #a6e22e; }
        .log-output .error { color: #f92672; }
        .log-output .warn { color: #e6db74; }
        button { padding: 10px 15px; background-color: #386641; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #5D4037; }
        .status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PocketBase Data Seeder</h1>

        <div class="important">
            <strong>IMPORTANT:</strong>
            <ol>
                <li>Ensure your PocketBase instance is running.</li>
                <li>The script below assumes PocketBase API is at <code>/api/</code> relative to this page. If it's on a different URL (e.g., <code>http://localhost:8090</code>), you <strong>MUST</strong> update the <code>API_URL_PREFIX</code> variable in the script.</li>
                <li>Temporarily open API rules in PocketBase for 'app_settings' and 'livestock_types' collections (Create & Update permissions, e.g., set to <code>""</code> for public) if running this unauthenticated.</li>
                <li><strong>Re-secure your API rules immediately after seeding is complete!</strong></li>
            </ol>
        </div>

        <button onclick="manualRunSeeder()">Run Seeder Manually</button>
        <p><em>Alternatively, the seeder will attempt to run automatically on page load if on localhost/127.0.0.1.</em></p>

        <div class="status" id="status-message">Status: Waiting...</div>
        <div class="log-output" id="log-output"></div>
    </div>

    <script>
        const logOutputDiv = document.getElementById('log-output');
        const statusMessageDiv = document.getElementById('status-message');

        function customLog(message, type = 'info') {
            console.log(message); // Also log to actual browser console
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.className = type;
            logOutputDiv.appendChild(logEntry);
            logOutputDiv.scrollTop = logOutputDiv.scrollHeight; // Auto-scroll
        }
        
        async function seedPocketBaseData() {
            customLog("Attempting to seed PocketBase data...", 'info');
            statusMessageDiv.textContent = "Status: Seeding in progress...";
            // --- IMPORTANT: Configure this if your PB is not at '/api/' relative to this HTML file ---
            const API_URL_PREFIX = '/api'; 
            // Example for different origin: const API_URL_PREFIX = 'http://localhost:8090/api';

            // --- App Settings ---
            const defaultAppSettingsData = {
                setting_key: "global_config",
                exchange_rates: {
                    EGP: { rate_from_egp: 1, symbol: 'LE', is_active: true },
                    USD: { rate_from_egp: 0.021, symbol: '$', is_active: true },
                    GBP: { rate_from_egp: 0.017, symbol: '£', is_active: true }
                },
                default_currency: "EGP",
                whatsapp_number_raw: "201234567890", 
                whatsapp_number_display: "+20 123 456 7890", 
                promo_end_date: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(),
                promo_discount_percent: 15,
                promo_is_active: true,
                delivery_areas: [
                    { id: 'cairo', name_en: 'Cairo', name_ar: 'القاهرة', cities: [ {id: 'nasr_city', name_en: 'Nasr City', name_ar: 'مدينة نصر'}, {id: 'maadi', name_en: 'Maadi', name_ar: 'المعادي'}, {id: 'heliopolis', name_en: 'Heliopolis', name_ar: 'مصر الجديدة'} ]},
                    { id: 'giza', name_en: 'Giza', name_ar: 'الجيزة', cities: [ {id: 'dokki', name_en: 'Dokki', name_ar: 'الدقي'}, {id: 'mohandessin', name_en: 'Mohandessin', name_ar: 'المهندسين'}, {id: 'haram', name_en: 'Haram', name_ar: 'الهرم'} ]},
                    { id: 'alexandria', name_en: 'Alexandria', name_ar: 'الإسكندرية', cities: [ {id: 'smouha', name_en: 'Smouha', name_ar: 'سموحة'}, {id: 'miami', name_en: 'Miami', name_ar: 'ميامي'} ]},
                    { id: 'other_gov', name_en: 'Other Governorate', name_ar: 'محافظة أخرى', cities: [] }
                ],
                payment_details: {
                    vodafone_cash: "010 YOUR VODA NUMBER", 
                    instapay_ipn: "YOUR.IPN@instapay", 
                    revolut_details: "@YOUR_REVTAG or Phone: +XX XXXXXXXX", 
                    bank_name: "YOUR BANK NAME", 
                    bank_account_name: "YOUR ACCOUNT HOLDER NAME", 
                    bank_account_number: "YOUR ACCOUNT NUMBER", 
                    bank_iban: "YOUR IBAN (Optional)", 
                    bank_swift: "YOUR SWIFT/BIC (Optional)" 
                }
            };

            try {
                customLog("Processing app_settings...", 'info');
                const checkSettingsUrl = `${API_URL_PREFIX}/collections/app_settings/records?filter=(setting_key='global_config')&perPage=1`;
                const checkResponse = await fetch(checkSettingsUrl);
                if (!checkResponse.ok && checkResponse.status !== 404) {
                    throw new Error(`Checking settings failed: ${checkResponse.statusText} - ${await checkResponse.text()}`);
                }
                const checkData = await checkResponse.json();
                
                if (checkData.items && checkData.items.length > 0) {
                    customLog("App settings 'global_config' already exists. Updating it.", 'info');
                    const existingSettingsId = checkData.items[0].id;
                    const updateResponse = await fetch(`${API_URL_PREFIX}/collections/app_settings/records/${existingSettingsId}`, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(defaultAppSettingsData)
                    });
                    if (!updateResponse.ok) throw new Error(`Failed to update app_settings: ${updateResponse.statusText} - ${await updateResponse.text()}`);
                    customLog("App settings updated successfully.", 'info');
                } else {
                    customLog("App settings 'global_config' not found. Creating it.", 'info');
                    const createResponse = await fetch(`${API_URL_PREFIX}/collections/app_settings/records`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(defaultAppSettingsData)
                    });
                    if (!createResponse.ok) throw new Error(`Failed to create app_settings: ${createResponse.statusText} - ${await createResponse.text()}`);
                    customLog("App settings created successfully.", 'info');
                }
            } catch (error) {
                customLog("Error seeding app_settings: " + error.message, 'error');
                statusMessageDiv.textContent = "Status: Error with app_settings. Check console.";
                return; // Stop if app_settings fail
            }

            // --- Livestock Types ---
            customLog("Processing livestock_types...", 'info');
            const defaultLivestockData = [
                { value_key: 'baladi', name_en: 'Baladi Sheep', name_ar: 'خروف بلدي', weights_prices: [ { weight_range: "30-40 kg", price_egp: 4500, stock: 15, is_active: true }, { weight_range: "40-50 kg", price_egp: 5200, stock: 10, is_active: true }, { weight_range: "50+ kg", price_egp: 6000, stock: 0, is_active: true } ] },
                { value_key: 'barki', name_en: 'Barki Sheep', name_ar: 'خروف برقي', weights_prices: [ { weight_range: "35-45 kg", price_egp: 5100, stock: 8, is_active: true }, { weight_range: "45-55 kg", price_egp: 5900, stock: 12, is_active: true } ] }
            ];

            for (const livestock of defaultLivestockData) {
                try {
                    customLog(`Processing livestock: ${livestock.value_key}`, 'info');
                    const checkLivestockUrl = `${API_URL_PREFIX}/collections/livestock_types/records?filter=(value_key='${livestock.value_key}')&perPage=1`;
                    const checkResponse = await fetch(checkLivestockUrl);
                    if (!checkResponse.ok && checkResponse.status !== 404) {
                         throw new Error(`Checking livestock ${livestock.value_key} failed: ${checkResponse.statusText} - ${await checkResponse.text()}`);
                    }
                    const checkData = await checkResponse.json();

                    if (checkData.items && checkData.items.length > 0) {
                        customLog(`Livestock type '${livestock.value_key}' already exists. Updating.`, 'info');
                        const updateResponse = await fetch(`${API_URL_PREFIX}/collections/livestock_types/records/${checkData.items[0].id}`, {
                            method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(livestock)
                        });
                        if (!updateResponse.ok) throw new Error(`Update failed for ${livestock.value_key}: ${updateResponse.statusText} - ${await updateResponse.text()}`);
                        customLog(`Livestock '${livestock.value_key}' updated successfully.`, 'info');
                    } else {
                        customLog(`Livestock type '${livestock.value_key}' not found. Creating.`, 'info');
                        const createResponse = await fetch(`${API_URL_PREFIX}/collections/livestock_types/records`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(livestock)
                        });
                        if (!createResponse.ok) throw new Error(`Create failed for ${livestock.value_key}: ${createResponse.statusText} - ${await createResponse.text()}`);
                        customLog(`Livestock '${livestock.value_key}' created successfully.`, 'info');
                    }
                } catch (error) {
                    customLog(`Error seeding livestock ${livestock.value_key}: ` + error.message, 'error');
                }
            }

            customLog("Data seeding process finished. REMEMBER TO RE-SECURE YOUR API RULES!", 'warn');
            statusMessageDiv.textContent = "Status: Seeding process finished. Check logs. RE-SECURE API RULES!";
            alert("Data seeding finished. Refresh your main application page to see changes if any. Remember to re-secure your API rules in PocketBase!");
        }

        async function manualRunSeeder() {
            logOutputDiv.innerHTML = ''; // Clear previous logs
            try {
                await seedPocketBaseData();
            } catch (e) {
                customLog("Manual run of seeder failed overall: " + e.message, 'error');
                statusMessageDiv.textContent = "Status: Manual run failed. Check console.";
            }
        }
        
        // Auto-run on page load if in a dev environment
        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.protocol === "file:") {
                customLog("Development environment detected, attempting to auto-run seeder...", 'info');
                statusMessageDiv.textContent = "Status: Auto-running seeder...";
                manualRunSeeder(); // Call the same function used by the button
            } else {
                customLog("Seeder auto-run skipped: Not a recognized development environment.", 'warn');
                statusMessageDiv.textContent = "Status: Auto-run skipped (not dev environment). Click button to run manually.";
            }
        });
    </script>
</body>
</html>
