<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sheep Land - Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --c1:#5D4037; --c1d:#3E2723; --c2:#386641; --c2l:#A3B18A; --c3:#F28C28;
            --t1:#212529; --tm:#6c757d; --td:#FAF8F5;
            --b1:var(--td); --b2:#F0EBE3; --bc:#fff; --bs:#DDE0E3;
            --rad:6px; --s0:.2rem; --s1:.4rem; --s2:.5rem; --s3:1.2rem; --s4:1.6rem;
            --fe:'Inter',sans-serif; --fa:'Noto Kufi Arabic',sans-serif;
            --lh:1.5;
        }
        *,::after,::before{box-sizing:border-box;margin:0;padding:0}
        html{font-size:15px;scroll-behavior:smooth;}
        body { font-family: var(--fe); line-height: var(--lh); color:var(--t1); padding: 20px; background-color: #f4f6f8; }
        a{text-decoration:none;color:var(--c2);} a:hover{color:var(--c1d)}
        :focus-visible{outline:2px solid var(--c3);outline-offset:2px;}

        .dash-container { max-width: 1400px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .dash-header { text-align: center; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; border-bottom: 1px solid var(--bs);}
        .dash-header h1 {font-size: 1.8rem; color: var(--c1); margin:0;}
        .dash-nav { margin-bottom: 20px; border-bottom: 1px solid var(--bs); padding-bottom: 10px; display:flex; flex-wrap:wrap; gap:5px; }
        .dash-nav button, .btn {
            padding: 8px 12px; font-size: 0.9rem; border-radius: var(--rad); cursor:pointer;
            background-color: var(--b2); color: var(--c1d); border:1px solid var(--bs);
            transition: background-color .2s, color .2s;
        }
        .dash-nav button:hover, .btn:hover { background-color: var(--c2l); color:var(--c1d); }
        .dash-nav button.active-tab, .btn.bp { background-color: var(--c1); color: white; border-color: var(--c1); }
        .dash-nav button.active-tab:hover, .btn.bp:hover { background-color: var(--c1d); }
        .btn.bac { background-color: var(--c2); color:white; border-color: var(--c2); }
        .btn.bac:hover { background-color: #2a5031; }
        .btn-block { display: block; width: 100%; }
        .btn-small { font-size: 0.8rem; padding: 5px 10px; }

        .dash-section { margin-bottom: 30px; }
        .dash-section h2 { font-size: 1.5rem; color: var(--c1d); border-bottom: 2px solid var(--c2l); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .dash-filters { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .dash-filters label { font-weight: 500; margin-right: 5px;}
        .dash-filters input[type="date"], .dash-filters select, .dash-filters input[type="text"], .dash-filters button { padding: 8px; border: 1px solid var(--bs); border-radius: var(--rad); font-size: 0.9rem; }
        
        .dash-table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid var(--bs); margin-bottom:10px; border-radius: var(--rad); }
        .dash-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .dash-table th, .dash-table td { border-bottom: 1px solid var(--bs); padding: 8px 10px; text-align: left; word-wrap: break-word; vertical-align: top;}
        .dash-table th { background-color: var(--b2); font-weight: 600; color: var(--c1d); position: sticky; top: 0; z-index: 1; }
        .dash-table td { background-color: var(--bc); position: relative; } /* For spinner positioning */
        .dash-table td.editable:hover { background-color: #e9f5ff; cursor: pointer; }
        .dash-table td input[type="text"], .dash-table td input[type="number"], .dash-table td input[type="date"], .dash-table td select {
            width: calc(100% - 4px); padding: 6px; font-size: inherit; border: 1px solid var(--c3); border-radius: 3px;
            background-color: white;
        }
        .dash-table tbody tr:nth-child(even) td { background-color: #f9f9f9; }
        .dash-table tbody tr:nth-child(even) td.editable:hover { background-color: #e2f0fb; }
        .dash-table tbody tr:hover td:not(.editing) { background-color: #f0f4f8; }

        .actions-col { width: 80px; text-align: center;} /* Reduced width as delete is removed */
        .currency { text-align: right; }
        .status-paid { color: #2ecc71; font-weight: bold; }
        .status-pending { color: #f39c12; }
        .status-failed { color: #e74c3c; }
        
        .pnl-summary { background-color: var(--b1); padding: 15px; border-radius: var(--rad); border: 1px solid var(--bs); }
        .pnl-summary div { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--bs); }
        .pnl-summary div:last-child { border-bottom: none; }
        .pnl-summary strong { color: var(--c1d); }
        .pnl-profit { color: var(--c2); font-size: 1.1rem; }
        .pnl-loss { color: #e74c3c; font-size: 1.1rem; }
        
        .login-form { max-width: 400px; margin: 30px auto; padding: 20px; border: 1px solid var(--bs); border-radius: var(--rad); background-color: var(--b1); }
        .login-form .fg { margin-bottom: 15px; }
        .login-form .fg label { display: block; margin-bottom: 5px; font-weight:500; }
        .login-form .input { width:100%; padding: 8px; border: 1px solid var(--bs); border-radius: var(--rad); font-size: 0.9rem; }
        
        .no-data { text-align: center; color: var(--tm); padding: 20px; font-style: italic; }
        .load-text { text-align: center; color: var(--tm); padding: 20px; font-weight: bold; }
        .pagination { margin-top: 15px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .json-viewer { background-color: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: var(--rad); font-size: 0.8em; white-space: pre-wrap; max-height: 200px; overflow: auto; margin-top: 5px;}
        .cell-saving-spinner {
            display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(0,0,0,.1);
            border-left-color: var(--c2); border-radius: 50%; animation: spin 0.6s linear infinite;
            margin-left: 5px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body x-data="adminDashboard" x-init="initDashboard()" x-cloak>

    <div class="dash-container">
        <header class="dash-header">
            <h1>Sheep Land - Admin Dashboard</h1>
            <div>
                <a href="index.html" class="btn bp" style="margin-right:10px;">Main Site</a>
                <button class="btn bp" @click="logoutAdmin()" x-show="isAdminAuth">Logout</button>
            </div>
        </header>

        <div x-show="!isAdminAuth" class="login-form">
            <h2 style="text-align:center; margin-bottom: 20px;">Admin Login</h2>
            <div class="fg"> <label for="adminEmail">Email:</label> <input type="email" id="adminEmail" x-model="loginForm.email" class="input"> </div>
            <div class="fg"> <label for="adminPassword">Password:</label> <input type="password" id="adminPassword" x-model="loginForm.password" class="input" @keyup.enter="loginAdmin()"> </div>
            <button class="btn bac btn-block" @click="loginAdmin()" :disabled="loading.auth">
                <span x-show="!loading.auth">Login</span> <span x-show="loading.auth">Logging in...</span>
            </button>
            <p x-show="authError" x-text="authError" style="color:red; text-align:center; margin-top:10px;"></p>
        </div>

        <div x-show="isAdminAuth">
            <nav class="dash-nav">
                <button :class="{'active-tab': activeTab === 'pnl'}" @click="switchTab('pnl')">P&L</button>
                <button :class="{'active-tab': activeTab === 'orders'}" @click="switchTab('orders')">Orders</button>
                <button :class="{'active-tab': activeTab === 'animals'}" @click="switchTab('animals')">Animals</button>
                <button :class="{'active-tab': activeTab === 'animal_events'}" @click="switchTab('animal_events')">Events</button>
                <button :class="{'active-tab': activeTab === 'products'}" @click="switchTab('products')">Products</button>
                <button :class="{'active-tab': activeTab === 'expenses'}" @click="switchTab('expenses')">Expenses</button>
                <button :class="{'active-tab': activeTab === 'settings'}" @click="switchTab('settings')">Settings</button>
            </nav>

            <div class="dash-filters" x-show="['pnl', 'orders', 'expenses'].includes(activeTab)">
                <label for="startDate">From:</label> <input type="date" id="startDate" x-model="filterStartDate" @change="refreshCurrentTabData()">
                <label for="endDate">To:</label> <input type="date" id="endDate" x-model="filterEndDate" @change="refreshCurrentTabData()">
            </div>
            
            <div x-show="activeTab === 'pnl'">
                <section class="dash-section pnl-summary">
                    <h2>Profit & Loss Summary <span x-text="filterDateRangeText" style="font-size: 0.9rem; color: var(--tm);"></span></h2>
                    <div x-show="loading.pnl" class="load-text">Calculating P&L...</div>
                    <div x-show="!loading.pnl">
                        <div><span>Total Revenue (Paid Orders):</span> <strong x-text="formatCurrency(pnl.totalRevenue)"></strong></div>
                        <div><span>Total Cost of Animals Sold (COGS):</span> <strong x-text="formatCurrency(pnl.totalCOGS)"></strong></div>
                        <div><span>Gross Profit:</span> <strong x-text="formatCurrency(pnl.grossProfit)"></strong></div>
                        <div><span>Total Operating Expenses:</span> <strong x-text="formatCurrency(pnl.totalExpenses)"></strong></div>
                        <hr style="margin: 10px 0; border-color: var(--bs);">
                        <div><span>Net Profit / (Loss):</span> <strong :class="pnl.netProfit >= 0 ? 'pnl-profit' : 'pnl-loss'" x-text="formatCurrency(pnl.netProfit)"></strong></div>
                    </div>
                </section>
            </div>

            <template x-if="activeTab !== 'pnl' && activeTab !== 'settings'">
                <section class="dash-section">
                    <h2>
                        <span x-text="getTabTitle(activeTab)"></span>
                        <a :href="getPbAdminCreateUrl(getCollectionNameForTab(activeTab))" target="_blank" class="btn bp btn-small" x-show="getCollectionNameForTab(activeTab)">+ New (Admin UI)</a>
                    </h2>
                    <div x-show="loading.current" class="load-text" x-text="`Loading ${getTabTitle(activeTab).toLowerCase()}...`"></div>
                    <div class="dash-table-wrapper" x-show="!loading.current && data[getCollectionNameForTab(activeTab)]?.items.length > 0">
                        <table class="dash-table">
                            <thead> <tr x-html="getTableHeaders(activeTab)"></tr> </thead>
                            <tbody>
                                <template x-for="(item, index) in data[getCollectionNameForTab(activeTab)]?.items" :key="item.id">
                                    <tr>
                                        <!-- Dynamically generated cells based on activeTab -->
                                        <template x-if="activeTab === 'orders'">
                                            <td @click="startInlineEdit(getCollectionNameForTab(activeTab), item.id, 'order_id_text', $event)" :class="{'editable': isEditableField(getCollectionNameForTab(activeTab), 'order_id_text')}">
                                                <span x-show="!isEditing(item.id, 'order_id_text')" x-text="item.order_id_text"></span>
                                                <input type="text" x-show="isEditing(item.id, 'order_id_text')" x-model="editFormData.order_id_text" 
                                                       @blur="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'order_id_text')" 
                                                       @keydown.enter="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'order_id_text')"
                                                       @keydown.escape="cancelInlineEdit()" x-ref="`input-${item.id}-order_id_text`">
                                                <span x-show="isSaving(item.id, 'order_id_text')" class="cell-saving-spinner"></span>
                                            </td>
                                            <td x-text="formatDate(item.created)"></td>
                                            <td @click="startInlineEdit(getCollectionNameForTab(activeTab), item.id, 'ordering_person_name', $event)" class="editable">
                                                <span x-show="!isEditing(item.id, 'ordering_person_name')" x-text="item.ordering_person_name"></span>
                                                <input type="text" x-show="isEditing(item.id, 'ordering_person_name')" x-model="editFormData.ordering_person_name" @blur="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'ordering_person_name')" @keydown.enter="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'ordering_person_name')" @keydown.escape="cancelInlineEdit()" x-ref="`input-${item.id}-ordering_person_name`">
                                                <span x-show="isSaving(item.id, 'ordering_person_name')" class="cell-saving-spinner"></span>
                                            </td>
                                            <td x-text="item.ordered_product_name_en || item.ordered_product_name_ar"></td>
                                            <td class="currency" x-text="formatCurrency(item.total_amount_due_egp, 'EGP', 0)"></td>
                                            <td><span :class="{ 'status-paid': item.payment_status === 'paid_confirmed', 'status-pending': item.payment_status.includes('pending') || item.payment_status.includes('review'), 'status-failed': item.payment_status === 'failed' }" x-text="item.payment_status?.replace(/_/g, ' ')"></span></td>
                                            <td x-text="item.order_status?.replace(/_/g, ' ')"></td>
                                        </template>
                                        <template x-if="activeTab === 'expenses'">
                                            <td x-text="formatDate(item.expense_date)"></td>
                                            <td @click="startInlineEdit(getCollectionNameForTab(activeTab), item.id, 'category', $event)" class="editable">
                                                <span x-show="!isEditing(item.id, 'category')" x-text="item.category"></span>
                                                <input type="text" x-show="isEditing(item.id, 'category')" x-model="editFormData.category" @blur="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'category')" @keydown.enter="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'category')" @keydown.escape="cancelInlineEdit()" x-ref="`input-${item.id}-category`">
                                                <span x-show="isSaving(item.id, 'category')" class="cell-saving-spinner"></span>
                                            </td>
                                            <td @click="startInlineEdit(getCollectionNameForTab(activeTab), item.id, 'description', $event)" class="editable">
                                                <span x-show="!isEditing(item.id, 'description')" x-text="item.description"></span>
                                                <input type="text" x-show="isEditing(item.id, 'description')" x-model="editFormData.description" @blur="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'description')" @keydown.enter="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'description')" @keydown.escape="cancelInlineEdit()" x-ref="`input-${item.id}-description`">
                                                <span x-show="isSaving(item.id, 'description')" class="cell-saving-spinner"></span>
                                            </td>
                                            <td @click="startInlineEdit(getCollectionNameForTab(activeTab), item.id, 'amount_egp', $event)" class="currency editable">
                                                <span x-show="!isEditing(item.id, 'amount_egp')" x-text="formatCurrency(item.amount_egp, 'EGP', 0)"></span>
                                                <input type="number" x-show="isEditing(item.id, 'amount_egp')" x-model.number="editFormData.amount_egp" @blur="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'amount_egp')" @keydown.enter="saveInlineEdit(getCollectionNameForTab(activeTab), item.id, 'amount_egp')" @keydown.escape="cancelInlineEdit()" x-ref="`input-${item.id}-amount_egp`" step="0.01">
                                                <span x-show="isSaving(item.id, 'amount_egp')" class="cell-saving-spinner"></span>
                                            </td>
                                        </template>
                                        <!-- Add more templates for other tabs (animals, products, etc.) similarly -->
                                        <td class="actions-col">
                                            <a :href="getPbAdminEditUrl(getCollectionNameForTab(activeTab), item.id)" target="_blank" class="btn bp">Full Edit</a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="!loading.current && (!data[getCollectionNameForTab(activeTab)] || data[getCollectionNameForTab(activeTab)]?.items.length === 0)" class="no-data" x-text="`No ${getTabTitle(activeTab).toLowerCase()} found.`"></div>
                    <div class="pagination" x-show="data[getCollectionNameForTab(activeTab)]?.totalPages > 1">
                        <button class="btn" @click="changePage(getCollectionNameForTab(activeTab), data[getCollectionNameForTab(activeTab)].page - 1)" :disabled="data[getCollectionNameForTab(activeTab)].page <= 1">Prev</button>
                        <span x-text="`Page ${data[getCollectionNameForTab(activeTab)]?.page} of ${data[getCollectionNameForTab(activeTab)]?.totalPages}`"></span>
                        <button class="btn" @click="changePage(getCollectionNameForTab(activeTab), data[getCollectionNameForTab(activeTab)].page + 1)" :disabled="data[getCollectionNameForTab(activeTab)].page >= data[getCollectionNameForTab(activeTab)].totalPages">Next</button>
                    </div>
                </section>
            </template>

            <div x-show="activeTab === 'settings'">
                 <section class="dash-section">
                    <h2><span>Application Settings</span></h2>
                    <div x-show="loading.current" class="load-text">Loading settings...</div>
                    <div x-show="!loading.current && data.settings?.items.length > 0">
                        <template x-for="item in data.settings.items" :key="item.id">
                            <div class="card" style="padding: 15px; font-size:0.9rem;">
                                <!-- Display settings fields, for brevity keeping it simple. Editing via PB Admin UI. -->
                                <p><strong>Default Currency:</strong> <span x-text="item.defCurr"></span></p>
                                <p><strong>Promo Active:</strong> <span x-text="item.promoActive ? 'Yes' : 'No'"></span></p>
                                <div><strong>All Settings Data:</strong> <pre class="json-viewer" x-text="JSON.stringify(item, null, 2)"></pre></div>
                                <a :href="getPbAdminEditUrl('settings', item.id)" target="_blank" class="btn bp" style="margin-top:15px;">Edit Settings in Admin UI</a>
                            </div>
                        </template>
                    </div>
                    <div x-show="!loading.current && (!data.settings || data.settings?.items.length === 0)" class="no-data">No settings found.</div>
                </section>
            </div>
        </div>
    </div>

<script src="pocketbase.umd.js"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    const ADM_E_PLACEHOLDER = 'admin@example.com';
    Alpine.data('adminDashboard', () => ({
        pb: null,
        isAdminAuth: false,
        loading: { auth: false, pnl: true, current: true },
        loginForm: { email: ADM_E_PLACEHOLDER, password: '' },
        authError: '',
        activeTab: 'pnl',
        data: {
            orders: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
            expenses: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
            sheep_log: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
            animal_events: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
            products: { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 },
            settings: { items: [], page: 1, perPage: 1, totalItems: 0, totalPages: 1 }
        },
        pnl: { totalRevenue: 0, totalCOGS: 0, grossProfit: 0, totalExpenses: 0, netProfit: 0 },
        filterStartDate: '',
        filterEndDate: '',
        pbAdminUrl: '',
        // Inline editing state
        editingCell: { recordId: null, field: null, collection: null, originalValue: null },
        editFormData: {}, // Holds temporary values for the input being edited
        savingCell: { recordId: null, field: null },

        initDashboard() {
            this.pb = new PocketBase(window.location.origin);
            this.pbAdminUrl = window.location.origin;
            this.loginForm.email = ADM_E_PLACEHOLDER;

            if (this.pb.authStore.isAdmin && this.pb.authStore.isValid) {
                this.isAdminAuth = true;
                this.setDefaultDateRange();
                this.refreshCurrentTabData();
            } else {
                this.setDefaultDateRange();
            }
        },
        
        setDefaultDateRange() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            this.filterStartDate = firstDayOfMonth.toISOString().split('T')[0];
            this.filterEndDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
        },

        async loginAdmin() {
            this.loading.auth = true; this.authError = '';
            try {
                await this.pb.admins.authWithPassword(this.loginForm.email, this.loginForm.password);
                this.isAdminAuth = true; this.loginForm.password = '';
                await this.refreshCurrentTabData();
            } catch (error) { this.authError = 'Login failed. Check credentials or server status.'; } 
            finally { this.loading.auth = false; }
        },

        logoutAdmin() {
            this.pb.authStore.clear(); this.isAdminAuth = false; this.authError = '';
            Object.keys(this.data).forEach(key => { this.data[key] = { items: [], page: 1, perPage: 15, totalItems: 0, totalPages: 1 }; });
            this.pnl = { totalRevenue: 0, totalCOGS: 0, grossProfit: 0, totalExpenses: 0, netProfit: 0 };
        },

        get filterDateRangeText() {
            if (this.filterStartDate && this.filterEndDate) return `(from ${this.formatDate(this.filterStartDate)} to ${this.formatDate(this.filterEndDate)})`;
            return '(all time)';
        },

        getPbAdminEditUrl(collectionName, recordId) { return `${this.pbAdminUrl}/_/collections/${collectionName}/records/${recordId}`; },
        getPbAdminCreateUrl(collectionName) { return `${this.pbAdminUrl}/_/collections/${collectionName}/records/new`; },
        
        async switchTab(tabName) {
            this.activeTab = tabName;
            this.cancelInlineEdit(); // Cancel any ongoing edit when switching tabs
            await this.refreshCurrentTabData();
        },

        async refreshCurrentTabData() {
            if (this.activeTab === 'pnl') {
                await this.fetchPnlData();
            } else {
                const collectionName = this.getCollectionNameForTab(this.activeTab);
                if (collectionName) await this.fetchPaginatedData(collectionName, 1);
            }
        },
        
        getCollectionNameForTab(tabKey) {
            const map = { animals: 'sheep_log', animal_events: 'animal_events' };
            return map[tabKey] || tabKey;
        },

        getTabTitle(tabKey) {
            const titles = { pnl: 'P&L Summary', orders: 'Orders', animals: 'Animal Log', animal_events: 'Animal Events', products: 'Products', expenses: 'Expenses', settings: 'Settings'};
            return titles[tabKey] || 'Data';
        },

        async fetchPnlData() { /* ... same as previous version ... */ },
        async fetchPaginatedData(collectionName, page = 1) { /* ... same as previous version ... */ },
        handleFetchError(error, context) { /* ... same as previous version ... */ },
        async changePage(collectionName, newPage) { /* ... same as previous version ... */ },
        calculatePnlSummary(ordersData, expensesData) { /* ... same as previous version ... */ },
        
        // --- Inline Editing Logic ---
        isEditableField(collectionName, fieldName) {
            // Define which fields are editable per collection (simple fields for now)
            const editableMap = {
                orders: ['order_id_text', 'ordering_person_name', 'total_amount_due_egp', 'payment_status', 'order_status'], // Example
                expenses: ['category', 'description', 'amount_egp', 'expense_date'],
                // Add more for other collections if desired
            };
            return editableMap[collectionName]?.includes(fieldName) || false;
        },

        isEditing(recordId, field) {
            return this.editingCell.recordId === recordId && this.editingCell.field === field;
        },
        isSaving(recordId, field) {
            return this.savingCell.recordId === recordId && this.savingCell.field === field;
        },

        startInlineEdit(collectionName, recordId, field, event) {
            if (!this.isEditableField(collectionName, field)) return;
            if (this.editingCell.recordId && (this.editingCell.recordId !== recordId || this.editingCell.field !== field)) {
                // If already editing another cell, try to save it first or cancel
                // For simplicity, we'll just cancel the previous edit. A more robust UX might prompt to save.
                this.cancelInlineEdit();
            }
            const record = this.data[collectionName]?.items.find(item => item.id === recordId);
            if (record) {
                this.editingCell = { recordId, field, collection: collectionName, originalValue: record[field] };
                this.editFormData = { ...record }; // Clone record data for editing form
                this.$nextTick(() => {
                    const inputEl = this.$refs[`input-${recordId}-${field}`];
                    if (inputEl) inputEl.focus();
                });
            }
        },

        cancelInlineEdit() {
            this.editingCell = { recordId: null, field: null, collection: null, originalValue: null };
            this.editFormData = {};
        },

        async saveInlineEdit(collectionName, recordId, field) {
            if (!this.editingCell.recordId || this.editingCell.recordId !== recordId || this.editingCell.field !== field) return; // Not in edit mode for this cell

            const newValue = this.editFormData[field];
            if (newValue === this.editingCell.originalValue) {
                this.cancelInlineEdit(); // No change
                return;
            }

            this.savingCell = { recordId, field };
            try {
                const dataToUpdate = { [field]: newValue };
                await this.pb.collection(collectionName).update(recordId, dataToUpdate);
                
                // Update local data
                const recordIndex = this.data[collectionName].items.findIndex(item => item.id === recordId);
                if (recordIndex > -1) {
                    this.data[collectionName].items[recordIndex][field] = newValue;
                }
                log(`Record ${recordId} in ${collectionName}, field ${field} updated to: ${newValue}`, 's');
                if (['orders', 'expenses', 'sheep_log'].includes(collectionName)) { // If COGS or Expenses source changes
                    await this.fetchPnlData(); // Recalculate P&L
                }

            } catch (error) {
                console.error(`Error updating ${collectionName}.${field} for record ${recordId}:`, error);
                alert(`Failed to save change for ${field}. Value reverted. Error: ${error.message}`);
                // Revert UI if needed, or re-fetch record:
                // For simplicity, we just cancel edit, user might have to re-edit.
                // A more robust way would be to restore editFormData[field] = this.editingCell.originalValue;
            } finally {
                this.cancelInlineEdit(); // Clears editingCell
                this.savingCell = { recordId: null, field: null };
            }
        },
        // --- End Inline Editing Logic ---


        formatDate(dateString) { /* ... same as previous version ... */ },
        formatCurrency(amount, currency = 'EGP', digits = 0) { /* ... same as previous version ... */ },
        
        // Dynamic table rendering (updated to call isEditableField)
        getTableHeaders(tabKey) {
            const collName = this.getCollectionNameForTab(tabKey);
            let headers = '';
            if (collName === 'orders') headers = `<th>Order ID</th><th>Date</th><th>Customer</th><th>Product</th><th class="currency">Total</th><th>Payment</th><th>Status</th><th class="actions-col">Actions</th>`;
            else if (collName === 'expenses') headers = `<th>Date</th><th>Category</th><th>Description</th><th class="currency">Amount</th><th class="actions-col">Actions</th>`;
            else if (collName === 'sheep_log') headers = `<th>Tag ID</th><th>Breed</th><th>Acq. Date</th><th class="currency">Acq. Cost</th><th>Status</th><th>Sold Order</th><th class="actions-col">Actions</th>`;
            else if (collName === 'animal_events') headers = `<th>Animal Tag</th><th>Event Date</th><th>Type</th><th>Description</th><th class="currency">Cost</th><th class="actions-col">Actions</th>`;
            else if (collName === 'products') headers = `<th>Key</th><th>Variant</th><th class="currency">Price</th><th>Stock</th><th>Active</th><th class="actions-col">Actions</th>`;
            return headers;
        },
        getTableRow(tabKey, item) {
            const collName = this.getCollectionNameForTab(tabKey);
            let rowHtml = '';
            const editUrl = this.getPbAdminEditUrl(collName, item.id);

            const simpleCell = (fieldName, displayValue, isCurrency = false, isEditableByMe = true) => {
                const editableClass = this.isEditableField(collName, fieldName) && isEditableByMe ? 'editable' : '';
                const clickHandler = editableClass ? `@click="startInlineEdit('${collName}', '${item.id}', '${fieldName}', $event)"` : '';
                const currencyClass = isCurrency ? 'currency' : '';
                
                let valueSpan = `<span x-show="!isEditing('${item.id}', '${fieldName}')">${displayValue}</span>`;
                let inputField = '';
                if (editableClass) {
                    const inputType = typeof item[fieldName] === 'number' ? 'number' : (fieldName.includes('date') ? 'date' : 'text');
                    const step = inputType === 'number' && !Number.isInteger(item[fieldName]) ? '0.01' : (inputType === 'number' ? '1' : '');
                    inputField = `<input type="${inputType}" ${step ? `step="${step}"` : ''} class="input" style="width:100%;" x-show="isEditing('${item.id}', '${fieldName}')" x-model${inputType === 'number' ? '.number' : ''}="editFormData.${fieldName}" 
                                        @blur="saveInlineEdit('${collName}', '${item.id}', '${fieldName}')" 
                                        @keydown.enter.prevent="saveInlineEdit('${collName}', '${item.id}', '${fieldName}')"
                                        @keydown.escape.prevent="cancelInlineEdit()" x-ref="input-${item.id}-${fieldName}">`;
                }
                const savingSpinner = `<span x-show="isSaving('${item.id}', '${fieldName}')" class="cell-saving-spinner"></span>`;
                return `<td class="${editableClass} ${currencyClass}" ${clickHandler}>${valueSpan}${inputField}${savingSpinner}</td>`;
            };
            
            if (collName === 'orders') {
                rowHtml = simpleCell('order_id_text', item.order_id_text) +
                          `<td>${this.formatDate(item.created)}</td>` +
                          simpleCell('ordering_person_name', item.ordering_person_name) +
                          `<td>${item.ordered_product_name_en || item.ordered_product_name_ar || ''}</td>` +
                          simpleCell('total_amount_due_egp', this.formatCurrency(item.total_amount_due_egp, 'EGP', 0), true, false) + // Total not usually inline editable
                          `<td><span :class="{ 'status-paid': '${item.payment_status}' === 'paid_confirmed', 'status-pending': '${item.payment_status}'.includes('pending') || '${item.payment_status}'.includes('review'), 'status-failed': '${item.payment_status}' === 'failed' }">${item.payment_status?.replace(/_/g, ' ')}</span></td>` +
                          `<td>${item.order_status?.replace(/_/g, ' ')}</td>`;
            } else if (collName === 'expenses') {
                rowHtml = simpleCell('expense_date', this.formatDate(item.expense_date), false, true) + // Making date editable too
                          simpleCell('category', item.category) +
                          simpleCell('description', item.description) +
                          simpleCell('amount_egp', this.formatCurrency(item.amount_egp, 'EGP', 0), true);
            } else if (collName === 'sheep_log') {
                 rowHtml = simpleCell('animal_tag_id', item.animal_tag_id) +
                           simpleCell('breed', item.breed || 'N/A') +
                           `<td>${this.formatDate(item.acquisition_date)}</td>` +
                           simpleCell('acquisition_cost_egp', this.formatCurrency(item.acquisition_cost_egp, 'EGP', 0), true) +
                           simpleCell('current_status', item.current_status) + // Could be a select if we build more complex inline
                           `<td>${item.expanded?.sale_order_id?.order_id_text || (item.sale_order_id ? '...' : 'N/A')}</td>`;
            } else if (collName === 'animal_events') {
                 rowHtml = `<td>${item.expanded?.animal_id?.animal_tag_id || 'N/A'}</td>` +
                           `<td>${this.formatDate(item.event_date)}</td>` +
                           simpleCell('event_type', item.event_type) + // Could be a select
                           simpleCell('description', item.description) +
                           simpleCell('cost_associated_egp', this.formatCurrency(item.cost_associated_egp, 'EGP', 0), true);
            } else if (collName === 'products') {
                rowHtml = simpleCell('item_key', item.item_key, false, false) + // Item key likely not editable after creation
                          simpleCell('variant_name_en', item.variant_name_en) +
                          simpleCell('base_price_egp', this.formatCurrency(item.base_price_egp, 'EGP', 0), true) +
                          simpleCell('stock_available_pb', item.stock_available_pb, false, true) + // Number editable
                          `<td>${item.is_active ? 'Yes':'No'}</td>`; // Boolean could be checkbox
            }
            rowHtml += `<td class="actions-col"><a href="${editUrl}" target="_blank" class="btn bp">Details</a></td>`;
             if(collName === 'sheep_log') rowHtml += `<td><a href="${this.getPbAdminCreateUrl('animal_events')}?animal_id=${item.id}" target="_blank" class="btn bp btn-small" title="Add Event">+Evt</a></td>`;

            return rowHtml;
        }

    }));
});
</script>
</body>
</html>