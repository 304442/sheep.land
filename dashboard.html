<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Dashboard Overview</title>
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .kpi-card { background-color: #e9ecef; padding: 15px; border-radius: 5px; text-align: center; }
        .kpi-card h3 { margin-top: 0; color: #007bff; }
        .kpi-value { font-size: 2em; font-weight: bold; color: #28a745; }
        .kpi-value.attention { color: #dc3545; }
        #login-section, #dashboard-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; }
        input[type="email"], input[type="password"], input[type="text"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Farm Dashboard</h1>

        <div id="login-section">
            <h2>Login</h2>
            <div><label for="pb-url">PocketBase URL:</label><input type="text" id="pb-url" value="/"></div>
            <div><label for="email">Email:</label><input type="email" id="email" placeholder="admin@example.com"></div>
            <div><label for="password">Password:</label><input type="password" id="password"></div>
            <button onclick="login()">Login</button>
            <p id="login-error" class="error"></p>
        </div>

        <div id="dashboard-section" style="display:none;">
            <h2>Overview KPIs</h2>
            <button onclick="fetchDashboardData()">Refresh Data</button>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>Total Animals</h3>
                    <p id="total-animals" class="kpi-value">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Needs Attention</h3>
                    <p id="needs-attention" class="kpi-value attention">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Open Opportunities</h3>
                    <p id="open-opportunities" class="kpi-value">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Pending Orders</h3>
                    <p id="pending-orders" class="kpi-value">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Revenue Today (Orders)</h3>
                    <p id="revenue-today" class="kpi-value">£0.00</p>
                </div>
                <div class="kpi-card">
                    <h3>Expenses Today</h3>
                    <p id="expenses-today" class="kpi-value attention">£0.00</p>
                </div>
                <div class="kpi-card">
                    <h3>Est. Profit Today</h3>
                    <p id="profit-today" class="kpi-value">£0.00</p>
                </div>
            </div>
            <p id="data-error" class="error"></p>
        </div>
    </div>

    <script>
        let pb = null;

        async function login() {
            const pbUrl = document.getElementById('pb-url').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginErrorEl = document.getElementById('login-error');
            loginErrorEl.textContent = '';

            if (!pbUrl || !email || !password) {
                loginErrorEl.textContent = 'URL, Email and password are required.';
                return;
            }

            try {
                pb = new PocketBase(pbUrl);
                await pb.admins.authWithPassword(email, password); // Or pb.collection('users').authWithPassword for non-admin
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                fetchDashboardData();
            } catch (err) {
                console.error('Login failed:', err);
                loginErrorEl.textContent = `Login failed: ${err.message || 'Check console.'}`;
                if (err.data) console.error('Error data:', err.data);
            }
        }

        async function fetchDashboardData() {
            if (!pb || !pb.authStore.isValid) {
                document.getElementById('data-error').textContent = "Not authenticated. Please login.";
                return;
            }
            document.getElementById('data-error').textContent = ""; // Clear previous errors

            try {
                // --- FMS Data ---
                const animals = await pb.collection('fms_animals').getFullList({ sort: '-created' });
                document.getElementById('total-animals').textContent = animals.length;

                const attentionAnimals = animals.filter(animal => animal.status === 'needs_attention').length;
                document.getElementById('needs-attention').textContent = attentionAnimals;

                // --- CRM Data ---
                const opportunities = await pb.collection('crm_opportunities').getFullList({
                    filter: "status = 'open'" // Adjust field and value as per your schema
                });
                document.getElementById('open-opportunities').textContent = opportunities.length;

                // --- OMS Data ---
                const orders = await pb.collection('oms_orders').getFullList();
                const pendingOrders = orders.filter(order => order.status === 'pending').length;
                document.getElementById('pending-orders').textContent = pendingOrders;

                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const revenueToday = orders
                    .filter(order => order.order_date && order.order_date.startsWith(today) && (order.status === 'completed' || order.status === 'shipped')) // Assuming order_date is a datetime string
                    .reduce((sum, order) => sum + (parseFloat(order.total_amount) || 0), 0);
                document.getElementById('revenue-today').textContent = `£${revenueToday.toFixed(2)}`;

                // --- P&L (Simplified) ---
                const expenses = await pb.collection('pnl_expenses').getFullList();
                const expensesToday = expenses
                    .filter(expense => expense.expense_date && expense.expense_date.startsWith(today)) // Assuming expense_date
                    .reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
                document.getElementById('expenses-today').textContent = `£${expensesToday.toFixed(2)}`;

                const profitToday = revenueToday - expensesToday;
                const profitEl = document.getElementById('profit-today');
                profitEl.textContent = `£${profitToday.toFixed(2)}`;
                profitEl.className = profitToday >= 0 ? 'kpi-value' : 'kpi-value attention';


            } catch (err) {
                console.error('Failed to fetch dashboard data:', err);
                document.getElementById('data-error').textContent = `Error fetching data: ${err.message}. Check console.`;
                 if (err.data) console.error('Error data:', err.data);
            }
        }
    </script>
</body>
</html>
