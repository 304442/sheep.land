<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>PB Setup: Bookings Collection (Corrected)</title>
    <script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        body{font-family:sans-serif;font-size:13px;line-height:1.4;padding:10px;background:#f0f0f0;color:#333;display:flex;flex-direction:column;align-items:center;margin:0;}
        .c{max-width:600px;width:100%;background:white;padding:15px;border-radius:5px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
        h1{color:#333;border-bottom:1px solid #ccc;padding-bottom:5px;margin:0 0 10px 0;font-size:1.2em;}
        p{font-size:0.9em;margin:0 0 0.5em 0;} .warn{color:red;font-weight:bold;}
        button{padding:6px 10px;background:#007bff;color:white;border:0;border-radius:3px;cursor:pointer;font-size:0.85em;}
        button:disabled{background:#ccc;} button:hover:not(:disabled){background:#0056b3;}
        #out{margin-top:10px;padding:8px;background:#222;color:#eee;border-radius:3px;white-space:pre-wrap;font-family:monospace;font-size:11px;max-height:45vh;overflow-y:auto;}
        .ls{color:lime;} .le{color:salmon;} .li{color:cyan;}
    </style>
</head>
<body>
    <div class="c">
        <h1>PB Udheya Setup (Bookings Collection - Corrected)</h1>
        <p class="warn">This script attempts to create/update the 'bookings' collection following best practices.</p>
        <button id="runSetup">Create/Update 'bookings' Collection</button>
        <div id="out"></div>
    </div>
<script>
    const pbUrl = '/';
    const outputDiv = document.getElementById('out');
    const runSetupButton = document.getElementById('runSetup');

    const ADM_E = 'admin@example.com'; 
    const ADM_P = 'unifiedpassword';

    const log = (message, type = 'i') => {
        const timestamp = `[${new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })}] `;
        const p = document.createElement('p');
        p.className = `l${type[0]}`;
        p.innerHTML = timestamp + message.replace(/</g, '<').replace(/>/g, '>');
        outputDiv.appendChild(p);
        outputDiv.scrollTop = outputDiv.scrollHeight;
        console[type === 'e' ? 'error' : (type === 'w' ? 'warn' : 'log')](timestamp + message.replace(/<[^>]*>?/gm, ''));
    };

    const bookingsCollectionDefinition = {
        "id": "bookings_collection_id_ph", // Placeholder ID for the collection
        "name": "bookings",
        "type": "base",
        "system": false, // Crucial for custom collections
        "listRule": "", 
        "viewRule": "", 
        "createRule": "", 
        "updateRule": "", 
        "deleteRule": "",
        "options": {}, // Ensure options object exists
        "fields": [ // Corrected from 'schema' to 'fields'
            { "id": "bk_f01", "name": "booking_id_text", "type": "text", "system": false, "required": true, "unique": true, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f02", "name": "animal_type_name_en", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } }, 
            { "id": "bk_f03", "name": "animal_type_name_ar", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } },
            { "id": "bk_f04", "name": "weight_category_name_en", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } }, 
            { "id": "bk_f05", "name": "weight_category_name_ar", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } },
            { "id": "bk_f06", "name": "weight_range_actual_en", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 }},
            { "id": "bk_f07", "name": "weight_range_actual_ar", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 }},
            { "id": "bk_f08", "name": "animal_base_price_egp", "type": "number", "system": false, "required": true, "presentable": true, "options": { "min": 0, "noDecimal": false } },
            { "id": "bk_f09", "name": "udheya_service_option_selected", "type": "text", "system": false, "required": true, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f10", "name": "service_fee_applied_egp", "type": "number", "system": false, "required": true, "presentable": true, "options": { "min": 0, "noDecimal": false } },
            { "id": "bk_f11", "name": "delivery_fee_applied_egp", "type": "number", "system": false, "required": false, "presentable": true, "options": { "min": 0, "noDecimal": false } },
            { "id": "bk_f12", "name": "total_amount_due_egp", "type": "number", "system": false, "required": true, "presentable": true, "options": { "min": 0, "noDecimal": false } },
            { "id": "bk_f13", "name": "selected_display_currency", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 5 } },
            { "id": "bk_f14", "name": "sacrifice_day_value", "type": "text", "system": false, "required": true, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f15", "name": "sacrifice_day_text_en", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } }, 
            { "id": "bk_f16", "name": "sacrifice_day_text_ar", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } },
            { "id": "bk_f17", "name": "slaughter_viewing_preference", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } }, 
            { "id": "bk_f18", "name": "distribution_choice", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f19", "name": "split_details_option", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } }, 
            { "id": "bk_f20", "name": "custom_split_details_text", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 500 } },
            { "id": "bk_f21", "name": "niyyah_names", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 500 } }, 
            { "id": "bk_f22", "name": "ordering_person_name", "type": "text", "system": false, "required": false, "presentable": true, "options": {"max": 150}},
            { "id": "bk_f23", "name": "ordering_person_phone", "type": "text", "system": false, "required": false, "presentable": true, "options": {"max": 30}}, 
            { "id": "bk_f24", "name": "customer_email", "type": "email", "system": false, "required": false, "presentable": true, "options": {} },
            { "id": "bk_f25", "name": "delivery_option", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } }, 
            { "id": "bk_f26", "name": "delivery_name", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 150 } },
            { "id": "bk_f27", "name": "delivery_phone", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 30 } }, 
            { "id": "bk_f28", "name": "delivery_area_id", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f29", "name": "delivery_area_name_en", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } }, 
            { "id": "bk_f30", "name": "delivery_area_name_ar", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 100 } },
            { "id": "bk_f31", "name": "delivery_address", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 500 } }, 
            { "id": "bk_f32", "name": "delivery_instructions", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 500 } },
            { "id": "bk_f33", "name": "time_slot", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } }, 
            { "id": "bk_f34", "name": "payment_method", "type": "text", "system": false, "required": true, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f35", "name": "payment_status", "type": "select", "system": false, "required": true, "presentable": true, "maxSelect": 1, "values": ["pending_payment", "payment_under_review", "paid_confirmed", "cod_pending_confirmation", "cod_confirmed_pending_delivery", "failed", "refunded"], "options": {} },
            { "id": "bk_f36", "name": "booking_status", "type": "select", "system": false, "required": true, "presentable": true, "maxSelect": 1, "values": ["confirmed_pending_payment", "payment_confirmed_processing", "ready_for_fulfillment", "fulfilled_completed", "cancelled_by_user", "cancelled_by_admin"], "options": {} },
            { "id": "bk_f37", "name": "terms_agreed", "type": "bool", "system": false, "required": false, "presentable": true, "options": {} }, 
            { "id": "bk_f38", "name": "admin_notes", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 1000 } },
            { "id": "bk_f39", "name": "group_purchase_interest", "type": "bool", "system": false, "required": false, "presentable": true, "options": {} }, 
            { "id": "bk_f40", "name": "user_ip_address", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 50 } },
            { "id": "bk_f41", "name": "user_agent_string", "type": "text", "system": false, "required": false, "presentable": true, "options": { "max": 300 } }
        ]
    };

    runSetupButton.onclick = async () => {
        runSetupButton.disabled = true;
        outputDiv.innerHTML = '';
        log('Setup process started for "bookings" collection...', 'i');
        const pb = new PocketBase(pbUrl);

        try {
            log(`Attempting admin authentication with: ${ADM_E}...`, 'i');
            await pb.admins.authWithPassword(ADM_E, ADM_P);
            log('Admin authentication successful.', 's');

            let existingCollection = null;
            try {
                existingCollection = await pb.collections.getOne(bookingsCollectionDefinition.name);
            } catch (e) {
                if (!(e.status === 404 || (e.response && e.response.status === 404))) {
                    throw e; 
                }
            }
            
            // Prepare payload for create or update
            // For create, send the full definition including placeholder IDs
            // For update, PocketBase documentation suggests sending only modifiable properties.
            // The JS SDK's update method mainly takes rules, options, and schema (fields).
            // Let's use a structure that's generally safe for both by providing the full definition for creation
            // and a more targeted one for updates.

            const createPayload = { ...bookingsCollectionDefinition }; 
            // Remove collection 'id' for create, PB assigns it
            delete createPayload.id; 
            // For field 'id's, PB will use them if valid or generate new ones.

            const updatePayload = { // For updating an existing collection
                name: bookingsCollectionDefinition.name, // Name usually not changed, but good to include
                listRule: bookingsCollectionDefinition.listRule,
                viewRule: bookingsCollectionDefinition.viewRule,
                createRule: bookingsCollectionDefinition.createRule,
                updateRule: bookingsCollectionDefinition.updateRule,
                deleteRule: bookingsCollectionDefinition.deleteRule,
                options: bookingsCollectionDefinition.options,
                fields: bookingsCollectionDefinition.fields // Send the full new fields schema
                // Note: PocketBase handles merging fields based on their existing IDs.
                // New fields will be added if their provided IDs are new or if IDs are omitted.
                // Existing fields are matched by ID and updated. Fields not in the new list are typically removed (be careful).
                // For simplicity and to match the "full definition" approach that worked for you, we send the whole fields array.
            };


            if (existingCollection) {
                log(`Collection '<b>${bookingsCollectionDefinition.name}</b>' exists. Attempting to update...`, 'i');
                // When updating, you pass the collection's *actual existing ID*
                await pb.collections.update(existingCollection.id, updatePayload);
                log(`Collection '<b>${bookingsCollectionDefinition.name}</b>' updated successfully.`, 's');
            } else {
                log(`Collection '<b>${bookingsCollectionDefinition.name}</b>' does not exist. Attempting to create...`, 'i');
                await pb.collections.create(createPayload);
                log(`Collection '<b>${bookingsCollectionDefinition.name}</b>' created successfully.`, 's');
            }
            log('Setup for "bookings" collection completed.', 's');
        } catch (e) {
            log(`<b>ERROR:</b> ${e.message}`, 'e');
            const errorData = e.data || (e.response && e.response.data);
            if (errorData) {
                log(`Details: <pre>${JSON.stringify(errorData, null, 2)}</pre>`, 'e');
            }
            console.error("Full Error Object:", e);
        } finally {
            pb.authStore.clear();
            runSetupButton.disabled = false;
        }
    };
</script>
</body>
</html>