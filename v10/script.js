document.addEventListener('alpine:init',()=>{const t={selectedAnimal:{type:"",value:"",weight:"",basePriceEGP:0,nameEN:"",nameAR:"",stock:null,pbId:null,originalStock:null},selectedPrepStyle:{value:"",nameEN:"",nameAR:"",is_custom:!1},customPrepDetails:"",selectedPackaging:{value:"",addonPriceEGP:0,nameEN:"",nameAR:""},totalPriceEGP:0,customerEmail:"",deliveryName:"",deliveryPhone:"",selectedGovernorate:"",deliveryCity:"",availableCities:[],deliveryAddress:"",deliveryInstructions:"",niyyahNames:"",splitDetailsOption:"",customSplitDetailsText:"",groupPurchase:!1,selectedSacrificeDay:{value:"day1_10_dhul_hijjah",textEN:"Day 1 of Eid (10th Dhul Hijjah)",textAR:"اليوم الأول (10 ذو الحجة)"},selectedTimeSlot:"8 AM-9 AM",distributionChoice:"me",paymentMethod:"fa",errors:{}};async function e(e,{recordId:r="",params:a=""}={}){const o=`/api/collections/${e}/records${r?`/${r}`:""}${a?`?${a}`:""}`;try{const t=await fetch(o,options.fetchOptions);if(!t.ok){let r="Unknown API Error";try{const e=await t.json();r=e&&e.data&&Object.values(e.data).map((t=>t.message||JSON.stringify(t))).join("; ")||e.message||t.statusText}catch(e){r=await t.text()||t.statusText}throw new Error(`API Error (${e} ${r||a}): ${t.status} ${r}`)}const s=await t.text();if(!s)return{items:[]};try{return JSON.parse(s)}catch(t){throw new Error(`API Error (${e} ${r||a}): Failed to parse response. ${t.message}`)}}catch(t){throw new Error(`Network Error: Could not connect. (${t.message})`)}}Alpine.data('udheyaBooking',()=>({isLoading:{status:!1,booking:!1,init:!0},appSettings:{exchange_rates:{EGP:{rate_from_egp:1,symbol:"LE",is_active:!0},USD:{rate_from_egp:.021,symbol:"$",is_active:!1},GBP:{rate_from_egp:.016,symbol:"£",is_active:!1}},default_currency:"EGP",whatsapp_number_raw:"201001234567",whatsapp_number_display:"+20 100 123 4567",promo_end_date:new Date(Date.now()+1296e6).toISOString(),promo_discount_percent:10,promo_is_active:!0,delivery_areas:[],payment_details:{vodafone_cash:"010-YOUR-VODA-NUMBER",instapay_ipn:"YOUR-IPN@instapay",revolut_details:"@YOUR-REVTAG / +XX XXXX XXXX",bank_name:"YOUR BANK NAME",bank_account_name:"YOUR ACCOUNT HOLDER NAME",bank_account_number:"YOUR ACCOUNT NUMBER",bank_iban:"",bank_swift:""}},productOptions:{livestock:[],preparationStyles:[{value:"Standard Mixed Cuts",nameEN:"Standard Mix",nameAR:"مزيج قياسي",is_custom:!1},{value:"Charity Portions",nameEN:"Charity Portions",nameAR:"حصص صدقة",is_custom:!1},{value:"Feast Preparation",nameEN:"Feast Preparation",nameAR:"تجهيز ولائم",is_custom:!1},{value:"Custom & Ground Mix",nameEN:"Custom & Ground",nameAR:"مخصص ومفروم",is_custom:!0}],packagingOptions:[{value:"standard",nameEN:"Standard Packaging",nameAR:"تعبئة قياسية",addonPriceEGP:0},{value:"vacuum_sealed",nameEN:"Vacuum Sealed",nameAR:"تعبئة مفرغة",addonPriceEGP:100}]},apiError:null,userFriendlyApiError:"",...JSON.parse(JSON.stringify(t)),bookingConfirmed:!1,statusResult:null,statusNotFound:!1,lookupBookingID:"",currentCurrency:"EGP",bookingID:"",currentConceptualStep:1,stepProgress:{step1:!1,step2:!1,step3:!1,step4:!1,step5:!1},isMobileMenuOpen:!1,isUdheyaDropdownOpen:!1,isUdheyaMobileSubmenuOpen:!1,stepSectionsMeta:[],countdown:{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!1},promoHasEnded:!1,calculatedPromoDaysLeft:0,countdownTimerInterval:null,currentLang:"en",errors:{},errorMessages:{required:{en:"This field is required.",ar:"هذا الحقل مطلوب."},select:{en:"Please make a selection.",ar:"يرجى الاختيار."},email:{en:"Please enter a valid email address.",ar:"يرجى إدخال بريد إلكتروني صحيح."},phone:{en:"Please enter a valid phone number.",ar:"يرجى إدخال رقم هاتف صحيح."}},navLinksData:[{href:"#udheya-booking-start",sectionId:"udheya-booking-start",parentMenu:"Udheya"},{href:"#how-it-works",sectionId:"how-it-works",parentMenu:"Udheya"},{href:"#check-booking-status",sectionId:"check-booking-status",parentMenu:"Udheya"},{href:"#livestock-section",sectionId:"livestock-section"},{href:"#meat-section",sectionId:"meat-section"}],activeNavLinkHref:"",async initApp(){this.isLoading.init=!0,this.apiError=null,this.userFriendlyApiError="";const t=JSON.parse(JSON.stringify(this.appSettings));try{const r="filter=(setting_key='global_config')&perPage=1",s=await Promise.all([e("app_settings",{params:r}),e("livestock_types")]);if(s[0]?.items?.length){const e=s[0].items[0],r=JSON.parse(JSON.stringify(t));for(const a in e)e.hasOwnProperty(a)&&"site_name"!==a&&(typeof e[a]=="object"&&null!==e[a]&&void 0!==r[a]&&"object"==typeof r[a]&&null!==r[a]&&!Array.isArray(e[a])?r[a]={...r[a],...e[a]}:r[a]=e[a]);r.whatsapp_number_raw||(r.whatsapp_number_raw=t.whatsapp_number_raw),r.whatsapp_number_display||(r.whatsapp_number_display=t.whatsapp_number_display);for(const e in t.payment_details)r.payment_details[e]||null===r.payment_details[e]||(r.payment_details[e]=t.payment_details[e]);this.appSettings=r}else this.appSettings=t;s[1]?.items?this.productOptions.livestock=s[1].items.map((t=>({pbId:t.id,value_key:t.value_key,name_en:t.name_en,name_ar:t.name_ar,weights_prices:Array.isArray(t.weights_prices)?t.weights_prices.map((t=>({...t}))):[]}))):this.productOptions.livestock=[]}catch(e){this.apiError=String(e.message||"Unknown error during data fetch."),this.userFriendlyApiError=e?.message?.includes("Network Error")?e.message:e?.message||"Failed to load settings. Refresh or try later.",this.appSettings=JSON.parse(JSON.stringify(t)),this.productOptions.livestock=[]}finally{this.isLoading.init=!1}"string"!=typeof this.appSettings.default_currency||!this.appSettings.exchange_rates[this.appSettings.default_currency])&&(this.appSettings.default_currency="EGP");this.currentCurrency=this.appSettings.default_currency,this.startOfferDHDMSCountdown(),this.updateSacrificeDayTexts(),this.updateAllDisplayedPrices(),this.clearAllErrors(),this.$watch(["selectedAnimal.basePriceEGP","selectedPackaging.addonPriceEGP"],(()=>this.calculateTotalPrice())),this.$watch("currentCurrency",(()=>{this.calculateTotalPrice(),this.updateAllDisplayedPrices()})),this.$watch("selectedSacrificeDay.value",(()=>this.updateSacrificeDayTexts())),this.$watch("selectedTimeSlot",(()=>this.updateStepCompletionStatus(3))),this.$watch("distributionChoice",(t=>{("split"!==t&&(this.splitDetailsOption="",this.customSplitDetailsText=""),"char"===t&&Object.assign(this,{deliveryName:"",deliveryPhone:"",selectedGovernorate:"",deliveryCity:"",deliveryAddress:"",deliveryInstructions:"",availableCities:[]}),this.clearError("splitDetails"),this.updateStepCompletionStatus(4))})),this.$watch("selectedPrepStyle.value",(()=>{this.selectedPrepStyle.is_custom||(this.customPrepDetails=""),this.updateStepCompletionStatus(2)})),this.$watch("selectedPackaging.value",(()=>this.updateStepCompletionStatus(2))),this.$watch("splitDetailsOption",(t=>{"custom"!==t&&(this.customSplitDetailsText=""),this.clearError("splitDetails"),this.updateStepCompletionStatus(4)})),this.$watch("customSplitDetailsText",(()=>this.updateStepCompletionStatus(4))),this.$watch("selectedGovernorate",(()=>{this.updateCities(),this.clearError("deliveryCity"),this.updateStepCompletionStatus(4)})),this.$watch("deliveryCity",(()=>this.updateStepCompletionStatus(4))),this.$watch("deliveryName",(()=>this.updateStepCompletionStatus(4))),this.$watch("deliveryPhone",(()=>this.updateStepCompletionStatus(4))),this.$watch("deliveryAddress",(()=>this.updateStepCompletionStatus(4))),this.$watch("paymentMethod",(()=>this.updateStepCompletionStatus(5))),this.stepSectionsMeta=["#step1-content","#step2-content","#step3-content","#step4-content","#step5-content"].map(((t,e)=>({id:t,conceptualStep:e+1,element:document.querySelector(t),titleRef:`step${e+1}Title`,firstFocusableErrorRef:null}))),this.$nextTick((()=>{this.updateAllStepCompletionStates(),this.handleScroll();const t=this.bookingConfirmed?"bookingConfirmedTitle":this.$refs.step1Title?"step1Title":"bookingSectionTitle";this.focusOnRef(t)})),window.addEventListener("scroll",(()=>this.handleScroll()),{passive:!0}),document.addEventListener("visibilitychange",(()=>{document.visibilityState==="visible"?this.startOfferDHDMSCountdown():this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval)}))},handleScroll(){if(!this.bookingConfirmed&&this.stepSectionsMeta.some((t=>t.element&&"number"==typeof t.element.offsetTop))){const t=window.scrollY+window.innerHeight/2;let e=1,r=1/0;this.stepSectionsMeta.forEach((s=>{if(s.element){const i=s.element.offsetTop,l=i+s.element.offsetHeight/2,n=Math.abs(t-l);n<r&&(r=n,e=s.conceptualStep)}})),this.currentConceptualStep=e}const t=document.querySelector(".site-header")?.offsetHeight||70,e=t+window.innerHeight*.1,r=window.scrollY+e;let s="",i=null;for(const l of this.navLinksData){const n=document.getElementById(l.sectionId);if(n){const o=n.offsetTop,c=o+n.offsetHeight;if(o<=r&&c>r){s=l.href,i=l.parentMenu;break}}}window.scrollY<(document.getElementById(this.navLinksData[0]?.sectionId)?.offsetTop||t)-t?(s="",i=null):window.innerHeight+Math.ceil(window.scrollY)>=document.body.offsetHeight-2&&this.navLinksData.slice().reverse().find((t=>document.getElementById(t.sectionId)))&&(s=this.navLinksData.slice().reverse().find((t=>document.getElementById(t.sectionId))).href,i=this.navLinksData.slice().reverse().find((t=>document.getElementById(t.sectionId))).parentMenu),this.activeNavLinkHref=i||s},setError(t,e){let r;"string"==typeof e?r=this.errorMessages[e]||{en:e,ar:e}:r=e,"object"==typeof r&&null!==r&&"string"==typeof r.en&&"string"==typeof r.ar?this.errors[t]=r:this.errors[t]=this.errorMessages.required},clearError(t){this.errors[t]&&this.$delete(this.errors,t)},clearAllErrors(){this.errors={}},focusOnRef(t){this.$nextTick((()=>{this.$refs[t]&&(this.$refs[t].focus({preventScroll:!1}),setTimeout((()=>{try{this.$refs[t].scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch(t){}}),50))}))},get _needsDeliveryDetails(){const t=(this.customSplitDetailsText||"").toLowerCase();return"me"===this.distributionChoice||"split"===this.distributionChoice&&(["1/3_me_2/3_charity_sl","1/2_me_1/2_charity_sl","2/3_me_1/3_charity_sl","all_me_custom_distro"].includes(this.splitDetailsOption)||"custom"===this.splitDetailsOption&&(t.includes("for me")||t.includes("all delivered to me")))},get splitDetails(){if("split"!==this.distributionChoice)return"";if("custom"===this.splitDetailsOption)return(this.customSplitDetailsText||"").trim();const t={"1/3_me_2/3_charity_sl":{en:"1/3 for me (delivered), 2/3 for charity (by Sheep Land)",ar:"ثلث لي (يوصل)، ثلثان للصدقة (بواسطة أرض الأغنام)"},"1/2_me_1/2_charity_sl":{en:"1/2 for me (delivered), 1/2 for charity (by Sheep Land)",ar:"نصف لي (يوصل)، نصف للصدقة (بواسطة أرض الأغنام)"},"2/3_me_1/3_charity_sl":{en:"2/3 for me (delivered), 1/3 for charity (by Sheep Land)",ar:"ثلثان لي (يوصل)، ثلث للصدقة (بواسطة أرض الأغنام)"},"all_me_custom_distro":{en:"All for me (I distribute)",ar:"الكل لي (أنا أوزع)"}};return t[this.splitDetailsOption]?"ar"===this.currentLang?t[this.splitDetailsOption].ar:t[this.splitDetailsOption].en:this.splitDetailsOption},_getDeliveryLocation(t){const e="en"===t?"name_en":"name_ar",r=(this.appSettings.delivery_areas||[]).find((t=>t.id===this.selectedGovernorate)),s=r?.cities?.find((t=>t.id===this.deliveryCity));return s&&"string"==typeof s[e]?s[e]:r&&0===r.cities?.length&&this.selectedGovernorate&&"string"==typeof r[e]?r[e]:r&&!s&&this.selectedGovernorate&&"string"==typeof r[e]?`${r[e]} (${"en"===t?"City not selected":"المدينة غير مختارة"})`:""},get summaryDeliveryToEN(){if("char"===this.distributionChoice)return"Charity Distribution by Sheep Land";if(this._needsDeliveryDetails){const t=(this.deliveryName||"").trim(),e=(this.deliveryPhone||"").trim(),r=this.selectedGovernorate,s=this.deliveryCity,i=(this.deliveryAddress||"").trim(),l=(this.appSettings.delivery_areas||[]).find((t=>t.id===r)),n=l&&Array.isArray(l.cities)&&l.cities.length>0&&!s;if(!t||!e||!r||n||!i)return"Delivery Details Incomplete";const o=this._getDeliveryLocation("en"),a=i?i.substring(0,20)+(i.length>20?"...":""):"";return[t,o,a].filter((t=>"string"==typeof t&&""!==t.trim())).join(", ")}return"Self Pickup / Distribution as per split"},get summaryDeliveryToAR(){if("char"===this.distributionChoice)return"توزيع خيري بواسطة أرض الأغنام";if(this._needsDeliveryDetails){const t=(this.deliveryName||"").trim(),e=(this.deliveryPhone||"").trim(),r=this.selectedGovernorate,s=this.deliveryCity,i=(this.deliveryAddress||"").trim(),l=(this.appSettings.delivery_areas||[]).find((t=>t.id===r)),n=l&&Array.isArray(l.cities)&&l.cities.length>0&&!s;if(!t||!e||!r||n||!i)return"تفاصيل التوصيل غير مكتملة";const o=this._getDeliveryLocation("ar"),a=i?i.substring(0,20)+(i.length>20?"...":""):"";return[t,o,a].filter((t=>"string"==typeof t&&""!==t.trim())).join("، ")}return"استلام ذاتي / توزيع حسب التقسيم"},get summaryDistributionEN(){return"me"===this.distributionChoice?"All to me":"char"===this.distributionChoice?"All to charity (by Sheep Land)":`Split: ${(this.splitDetails||"").trim()||"(Not specified)"}`},get summaryDistributionAR(){return"me"===this.distributionChoice?"الكل لي":"char"===this.distributionChoice?"تبرع بالكل للصدقة (أرض الأغنام توزع)":`تقسيم الحصص: ${(this.splitDetails||"").trim()||"(لم يحدد)"}`},startOfferDHDMSCountdown(){if(this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),!this.appSettings.promo_is_active||!this.appSettings.promo_end_date)return this.countdown.ended=!0,this.promoHasEnded=!0,void(this.calculatedPromoDaysLeft=0);if(!this.appSettings.promo_end_date||"string"!=typeof this.appSettings.promo_end_date)return void(this.countdown.ended=!0);const t=new Date(this.appSettings.promo_end_date).getTime();if(isNaN(t))return void(this.countdown.ended=!0);this.updateDHDMSCountdownDisplay(t),this.countdownTimerInterval=setInterval((()=>this.updateDHDMSCountdownDisplay(t)),1e3)},updateDHDMSCountdownDisplay(t){const e=new Date().getTime(),r=t-e;if(r<0)return this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),Object.assign(this.countdown,{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!0}),this.promoHasEnded=!0,void(this.calculatedPromoDaysLeft=0);this.countdown.ended=!1,this.promoHasEnded=!1;const s=Math.floor(r/864e5),i=Math.floor(r%864e5/36e5),l=Math.floor(r%36e5/6e4),n=Math.floor(r%6e4/1e3);Object.assign(this.countdown,{days:String(s).padStart(2,"0"),hours:String(i).padStart(2,"0"),minutes:String(l).padStart(2,"0"),seconds:String(n).padStart(2,"0")}),this.calculatedPromoDaysLeft=s},updateCities(){const t=(this.appSettings.delivery_areas||[]).find((t=>t.id===this.selectedGovernorate));this.availableCities=t?.cities||[],this.deliveryCity=""},getFormattedPrice(t,e){const r=e||this.currentCurrency,s=this.appSettings?.exchange_rates?this.appSettings.exchange_rates[r]:null;return null==t||!s||"number"!=typeof s.rate_from_egp?`${s?.symbol||"?"} ---`:`${s.symbol} ${(t*s.rate_from_egp).toFixed("LE"===s.symbol||"ل.م"===s.symbol?0:2)}`},isValidEmail:t=>!t||"string"!=typeof t||!t.trim()||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),isValidPhone:t=>t&&"string"==typeof t&&/^\+?[0-9\s\-()]{7,20}$/.test(t.trim()),scrollToSection(t){try{const e=document.querySelector(t);if(e){let r=document.querySelector(".site-header")?.offsetHeight||0;if(t.startsWith("#udheya-booking-start")||t.startsWith("#step")||t.startsWith("#udheya-booking-form-panel")){const t=document.querySelector(".stepper-outer-wrapper");t&&"sticky"===getComputedStyle(t).position&&(r+=t.offsetHeight)}const s=e.getBoundingClientRect().top,i=s+window.pageYOffset-r-10;window.scrollTo({top:i,behavior:"smooth"})}}catch(t){}},validateConceptualStep(t,e=!0){let r=!1;switch(t){case 1:r=this.validateStep1(e);break;case 2:r=this.validateStep2(e);break;case 3:r=this.validateStep3(e);break;case 4:r=this.validateStep4(e);break;case 5:r=this.validateStep5(e);break;default:r=!1}return this.stepProgress[`step${t}`]=r,r},updateStepCompletionStatus(t){this.stepProgress[`step${t}`]=this.validateConceptualStep(t,!1)},updateAllStepCompletionStates(){for(let t=1;t<=5;t++)this.updateStepCompletionStatus(t)},handleStepperNavigation(t){this.clearAllErrors();let e=!0;for(let r=1;r<t;r++)if(!this.validateConceptualStep(r,!0)){this.currentConceptualStep=r;const t=this.stepSectionsMeta[r-1];t&&t.firstFocusableErrorRef?this.focusOnRef(t.firstFocusableErrorRef):t&&this.focusOnRef(t.titleRef),this.scrollToSection(this.stepSectionsMeta[r-1]?.id||"#udheya-booking-start"),e=!1;break}e&&(this.currentConceptualStep=t,this.scrollToSection(this.stepSectionsMeta[t-1]?.id||"#udheya-booking-start"),this.focusOnRef(this.stepSectionsMeta[t-1]?.titleRef))},validateAndScrollOrFocus(t,e){this.clearAllErrors();const r=this.validateConceptualStep(t,!0);if(this.stepProgress[`step${t}`]=r,r){1===t&&"#step2-content"===e&&(this.currentConceptualStep=2),this.scrollToSection(e);const r=this.stepSectionsMeta.find((t=>t.id===e||t.id===e.substring(1)));this.focusOnRef(r?.titleRef||this.stepSectionsMeta[t]?.titleRef||e)}else{const e=this.stepSectionsMeta[t-1];e&&e.firstFocusableErrorRef?this.focusOnRef(e.firstFocusableErrorRef):e&&this.focusOnRef(e.titleRef),this.scrollToSection(e?.id||"#udheya-booking-start")}},validateStep1(e=!0){e&&this.clearError("animal");let r=null;const s=this.stepSectionsMeta[0];if(!this.selectedAnimal.type||!this.selectedAnimal.weight)return e&&(this.setError("animal",{en:"Please select an animal and its weight.",ar:"يرجى اختيار الحيوان ووزنه."}),r=this.selectedAnimal.type?("baladi"===this.selectedAnimal.type&&!this.selectedAnimal.weight?"baladiWeightSelect":"barki"===this.selectedAnimal.type&&!this.selectedAnimal.weight?"barkiWeightSelect":null):this.$refs.baladiWeightSelect?"baladiWeightSelect":this.$refs.barkiWeightSelect?"barkiWeightSelect":null),s&&(s.firstFocusableErrorRef=r),this.stepProgress.step1=!1,!1;const i=this.productOptions.livestock.find((t=>t.value_key===this.selectedAnimal.type)),l=i?.weights_prices.find((t=>t.weight_range===this.selectedAnimal.weight));return!l||!l.is_active||null!=l.stock&&l.stock<=0?(e&&(this.setError("animal",{en:`${this.selectedAnimal.nameEN||"Your selected animal"} (${this.selectedAnimal.weight}) is no longer in stock. Please re-select.`,ar:`${this.selectedAnimal.nameAR||"الحيوان المختار"} (${this.selectedAnimal.weight}) لم يعد متوفراً. يرجى إعادة الاختيار.`}),r="baladi"===this.selectedAnimal.type?"baladiWeightSelect":"barkiWeightSelect",this.selectedAnimal={...t.selectedAnimal},this.calculateTotalPrice(),this.updateAllDisplayedPrices(),document.querySelectorAll(".livestock-card").forEach((t=>t.classList.remove("livestock-card-selected")))),s&&(s.firstFocusableErrorRef=r),this.stepProgress.step1=!1,!1):(s&&(s.firstFocusableErrorRef=null),this.stepProgress.step1=!0,!0)},validateStep2(t=!0){t&&(this.clearError("prepStyle"),this.clearError("packaging"));let e=!0,r=null;const s=this.stepSectionsMeta[1];return this.selectedPrepStyle.value||(t&&(this.setError("prepStyle","select"),r||(r="prepStyleSelect")),e=!1),this.selectedPackaging.value||(t&&(this.setError("packaging","select"),r||(r="packagingSelect")),e=!1),s&&(s.firstFocusableErrorRef=r),this.stepProgress.step2=e,e},validateStep3(t=!0){const e=this.stepSectionsMeta[2];return e&&(e.firstFocusableErrorRef=null),this.stepProgress.step3=!0,!0},validateStep4(t=!0){t&&(this.clearError("splitDetails"),this.clearError("deliveryName"),this.clearError("deliveryPhone"),this.clearError("customerEmail"),this.clearError("selectedGovernorate"),this.clearError("deliveryCity"),this.clearError("deliveryAddress"));let e=!0,r=null;const s=this.stepSectionsMeta[3],i=(i,l,n)=>{t&&this.setError(i,l),e=!1,t&&!r&&(r=n)};if("split"===this.distributionChoice&&(this.splitDetailsOption?("custom"===this.splitDetailsOption&&(this.customSplitDetailsText||"").trim()||i("splitDetails","required","customSplitTextarea")):i("splitDetails","select","distributionChoiceRadios")),this._needsDeliveryDetails){(this.deliveryName||"").trim()||i("deliveryName","required","deliveryNameInput"),(this.deliveryPhone||"").trim()?this.isValidPhone((this.deliveryPhone||"").trim())||i("deliveryPhone","phone","deliveryPhoneInput"):i("deliveryPhone","required","deliveryPhoneInput"),(this.customerEmail||"").trim()&&!this.isValidEmail((this.customerEmail||"").trim())&&i("customerEmail","email","customerEmailInput"),this.selectedGovernorate||i("selectedGovernorate","select","deliveryGovernorateSelect");const t=(this.appSettings.delivery_areas||[]).find((t=>t.id===this.selectedGovernorate));t&&Array.isArray(t.cities)&&t.cities.length>0&&!this.deliveryCity&&i("deliveryCity","select","deliveryCitySelect"),(this.deliveryAddress||"").trim()||i("deliveryAddress","required","deliveryAddressInput")}return s&&(s.firstFocusableErrorRef=r),this.stepProgress.step4=e,e},validateStep5(t=!0){t&&this.clearError("paymentMethod");let e=null;const r=this.stepSectionsMeta[4];return this.paymentMethod?(r&&(r.firstFocusableErrorRef=null),this.stepProgress.step5=!0,!0):(t&&(this.setError("paymentMethod","select"),e="paymentMethodRadios"),r&&(r.firstFocusableErrorRef=e),this.stepProgress.step5=!1,!1)},selectAnimal(e,r){this.clearError("animal");const s=this.productOptions.livestock.find((t=>t.value_key===e));if(!s)return this.setError("animal",{en:"Invalid animal type specified.",ar:"تم تحديد نوع حيوان غير صالح."}),void this.updateStepCompletionStatus(1);const i=r.value;if(!i)return this.selectedAnimal.type===e&&(this.selectedAnimal={...t.selectedAnimal},this.calculateTotalPrice(),document.getElementById(e)?.classList.remove("livestock-card-selected")),void this.updateStepCompletionStatus(1);const l=s.weights_prices.find((t=>t.weight_range===i));if(!l||!l.is_active||null!=l.stock&&l.stock<=0)return this.setError("animal",{en:`${s.name_en||"Selected animal"} (${i}) is currently out of stock. Please choose another weight.`,ar:`${s.name_ar||"الحيوان المختار"} (${i}) غير متوفر حاليًا. يرجى اختيار وزن آخر.`}),this.selectedAnimal.type===e&&this.selectedAnimal.weight===i&&(this.selectedAnimal={...t.selectedAnimal},document.getElementById(e)?.classList.remove("livestock-card-selected")),this.calculateTotalPrice(),this.$refs[r.id]&&this.focusOnRef(r.id),void this.updateStepCompletionStatus(1);const n="baladi"===e?"barki":"baladi";if(this.selectedAnimal.type&&this.selectedAnimal.type!==e){const t=this.$refs[`${n}WeightSelect`];t&&(t.value=""),document.getElementById(n)?.classList.remove("livestock-card-selected")}this.selectedAnimal={type:s.value_key,value:s.value_key,weight:l.weight_range,basePriceEGP:parseFloat(l.price_egp),stock:l.stock,originalStock:l.stock,nameEN:s.name_en,nameAR:s.name_ar,pbId:s.pbId},this.calculateTotalPrice(),document.querySelectorAll(".livestock-card").forEach((t=>t.classList.remove("livestock-card-selected"))),r.closest(".livestock-card").classList.add("livestock-card-selected"),this.updateStepCompletionStatus(1),this.stepProgress.step1&&this.validateAndScrollOrFocus(1,"#step2-content")},updateSelectedPrepStyle(e){const r=this.productOptions.preparationStyles.find((t=>t.value===e));r?this.selectedPrepStyle={...r}:this.selectedPrepStyle={value:"",nameEN:"",nameAR:"",is_custom:!1},this.selectedPrepStyle.is_custom||(this.customPrepDetails=""),this.calculateTotalPrice(),this.updateStepCompletionStatus(2)},updateSelectedPackaging(t){const e=this.productOptions.packagingOptions.find((e=>e.value===t));e?this.selectedPackaging={...e,addonPriceEGP:parseFloat(e.addonPriceEGP||0)}:this.selectedPackaging={value:"",addonPriceEGP:0,nameEN:"",nameAR:""},this.calculateTotalPrice(),this.updateStepCompletionStatus(2)},updateSacrificeDayTexts(){const t=document.querySelector(`#sacrifice_day_select_s3 option[value="${this.selectedSacrificeDay.value}"]`);t&&Object.assign(this.selectedSacrificeDay,{textEN:t.dataset.en,textAR:t.dataset.ar}),this.updateStepCompletionStatus(3)},calculateTotalPrice(){this.totalPriceEGP=(this.selectedAnimal.basePriceEGP||0)+(this.selectedPackaging.addonPriceEGP||0)},updateAllDisplayedPrices(){try{(this.productOptions.livestock||[]).forEach((t=>{const e=document.getElementById(t.value_key),r=e?.querySelector("select");if(!e||!r)return;const s=r.value;r.innerHTML="";const i=document.createElement("option");i.value="",i.textContent="ar"===this.currentLang?"-- اختر الوزن --":"-- Select Weight --",i.disabled=!1,r.appendChild(i);let l=null,n=!1;(t.weights_prices||[]).forEach((e=>{const t=document.createElement("option");t.value=e.weight_range;const i=!e.is_active||null!=e.stock&&e.stock<=0,o=i?" - Out of Stock":null!=e.stock?` - Stock: ${e.stock}`:"",c=i?" - نفذت الكمية":null!=e.stock?` - الكمية: ${e.stock}`:"";t.textContent=`${e.weight_range||""} (${this.getFormattedPrice(e.price_egp)})${"ar"===this.currentLang?c:o}`,t.disabled=i,r.appendChild(t),i||null!==l||(l=e.weight_range),e.weight_range===s&&!i&&(n=!0)})),s&&n?r.value=s:this.selectedAnimal.type===t.value_key&&this.selectedAnimal.weight&&t.weights_prices.find((e=>e.weight_range===this.selectedAnimal.weight&&e.is_active&&(null==e.stock||e.stock>0)))?r.value=this.selectedAnimal.weight:r.value="";const o=(t.weights_prices||[]).find((t=>t.is_active&&(null==t.stock||t.stock>0))),a=o?o.price_egp:(t.weights_prices||[])[0]?.price_egp||0,c=e.querySelector(".price.bil-row .en span"),u=e.querySelector(".price.bil-row .ar span");c&&(c.textContent=this.getFormattedPrice(a)),u&&(u.textContent=this.getFormattedPrice(a))})),this.calculateTotalPrice()}catch(t){this.userFriendlyApiError="Error updating price displays."}},async validateAndSubmitBooking(){this.clearAllErrors();let r=!0;for(let e=1;e<=5;e++)if(!this.validateConceptualStep(e,!0)){r=!1;const t=this.stepSectionsMeta[e-1];if(t){const e=t.firstFocusableErrorRef||t.titleRef;e&&this.focusOnRef(e),this.scrollToSection(t.id||"#udheya-booking-start")}break}if(!r)return;const s=this.productOptions.livestock.find((t=>t.value_key===this.selectedAnimal.value)),i=s?.weights_prices.find((t=>t.weight_range===this.selectedAnimal.weight));if(!s||!i||!i.is_active||null!=i.stock&&i.stock<=0)return this.setError("animal",{en:`Sorry, ${this.selectedAnimal.nameEN||"your selected item"} (${this.selectedAnimal.weight}) is no longer available. Please reselect.`,ar:`عذراً، ${this.selectedAnimal.nameAR||"المنتج المختار"} (${this.selectedAnimal.weight}) لم يعد متوفراً. يرجى إعادة الاختيار.`}),this.selectedAnimal={...t.selectedAnimal},this.updateAllDisplayedPrices(),this.updateStepCompletionStatus(1),this.scrollToSection("#step1-content"),void this.focusOnRef(this.stepSectionsMeta[0].titleRef);this.isLoading.booking=!0,this.apiError=null,this.userFriendlyApiError="",this.calculateTotalPrice();const l=this,n={booking_id_text:`SL-UDHY-${(new Date).getFullYear()}-${String(Math.floor(9e4*Math.random())+1e4).padStart(5,"0")}`,animal_type_key:l.selectedAnimal.value,animal_type_name_en:l.selectedAnimal.nameEN,animal_type_name_ar:l.selectedAnimal.nameAR,animal_weight_selected:l.selectedAnimal.weight,animal_base_price_egp:l.selectedAnimal.basePriceEGP,preparation_style_value:l.selectedPrepStyle.value,preparation_style_name_en:l.selectedPrepStyle.nameEN,preparation_style_name_ar:l.selectedPrepStyle.nameAR,is_custom_prep:l.selectedPrepStyle.is_custom,custom_prep_details:l.selectedPrepStyle.is_custom?(l.customPrepDetails||"").trim():"",packaging_value:l.selectedPackaging.value,packaging_name_en:l.selectedPackaging.nameEN,packaging_name_ar:l.selectedPackaging.nameAR,packaging_addon_price_egp:l.selectedPackaging.addonPriceEGP,total_price_egp:l.totalPriceEGP,sacrifice_day_value:l.selectedSacrificeDay.value,time_slot:l.selectedTimeSlot,distribution_choice:l.distributionChoice,split_details_option:"split"===l.distributionChoice?l.splitDetailsOption:"",custom_split_details_text:"split"===l.distributionChoice&&"custom"===l.splitDetailsOption?(l.customSplitDetailsText||"").trim():"",niyyah_names:(l.niyyahNames||"").trim(),customer_email:(l.customerEmail||"").trim(),group_purchase_interest:l.groupPurchase,delivery_name:l._needsDeliveryDetails?(l.deliveryName||"").trim():"",delivery_phone:l._needsDeliveryDetails?(l.deliveryPhone||"").trim():"",delivery_governorate_id:l._needsDeliveryDetails?l.selectedGovernorate:"",delivery_city_id:l._needsDeliveryDetails?l.deliveryCity:"",delivery_address:l._needsDeliveryDetails?(l.deliveryAddress||"").trim():"",delivery_instructions:l._needsDeliveryDetails?(l.deliveryInstructions||"").trim():"",payment_method:l.paymentMethod,payment_status:"cod"===l.paymentMethod&&l._needsDeliveryDetails?"cod_pending":"pending",booking_status:"confirmed_pending_payment"};try{const t=await e("bookings",{fetchOptions:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}});this.bookingID=t.booking_id_text||t.id,null!=i.stock&&i.stock>0&&i.stock--,this.bookingConfirmed=!0,this.$nextTick((()=>{this.scrollToSection("#booking-confirmation-section"),this.focusOnRef("bookingConfirmedTitle")}))}catch(t){this.apiError=t.message,this.userFriendlyApiError=t.message.includes("Network Error")?t.message:"Issue submitting booking. Review details, try again, or contact support.",this.scrollToSection(".global-error-indicator")}finally{this.isLoading.booking=!1}},async validateAndCheckBookingStatus(){if(this.clearError("lookupBookingID"),(this.lookupBookingID||"").trim())await this.checkBookingStatus();else this.setError("lookupBookingID","required"),this.focusOnRef("lookupBookingIdInput")},async checkBookingStatus(){this.statusResult=null,this.statusNotFound=!1,this.isLoading.status=!0,this.apiError=null,this.userFriendlyApiError="";const t=(this.lookupBookingID||"").trim();try{const r=await e("bookings",{params:`filter=(booking_id_text='${encodeURIComponent(t)}')&perPage=1`});r.items?.length?this.statusResult={booking_id_text:r.items[0].booking_id_text||r.items[0].id,status:r.items[0].booking_status||"Unknown",animal_type:r.items[0].animal_type_name_en||r.items[0].animal_type_key,animal_weight_selected:r.items[0].animal_weight_selected,sacrifice_day:r.items[0].sacrifice_day_value,time_slot:r.items[0].time_slot}:this.statusNotFound=!0}catch(t){this.apiError=t.message,this.userFriendlyApiError=t.message.includes("Network Error")?t.message:"Could not retrieve status. Check ID or try again.",this.statusNotFound=!0}finally{this.isLoading.status=!1}},getSacrificeDayText(t){const e=document.querySelector(`#sacrifice_day_select_s3 option[value="${t}"]`);return e?{en:e.dataset.en,ar:e.dataset.ar}:{en:t,ar:t}},resetAndStartOver(){Object.assign(this,JSON.parse(JSON.stringify(t)),{bookingConfirmed:!1,bookingID:"",lookupBookingID:"",statusResult:null,statusNotFound:!1,currentConceptualStep:1,stepProgress:{step1:!1,step2:!1,step3:!1,step4:!1,step5:!1},isMobileMenuOpen:!1,isUdheyaDropdownOpen:!1,isUdheyaMobileSubmenuOpen:!1,apiError:null,userFriendlyApiError:"",activeNavLinkHref:"",countdown:{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!1},promoHasEnded:!1,calculatedPromoDaysLeft:0}),this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),this.initApp(),this.$nextTick((()=>{this.scrollToSection("#udheya-booking-start"),this.focusOnRef("bookingSectionTitle")}))}}))}),function(){const t="run_db_seed";function e(t){return new URLSearchParams(window.location.search).get(t)}if("true"===e(t)){const e="/api/",r=[{collection:"app_settings",data:{setting_key:"global_config",exchange_rates:{EGP:{rate_from_egp:1,symbol:"LE",is_active:!0},USD:{rate_from_egp:.021,symbol:"$",is_active:!0},GBP:{rate_from_egp:.017,symbol:"£",is_active:!0}},default_currency:"EGP",whatsapp_number_raw:"201001234567",whatsapp_number_display:"+20 100 123 4567",promo_end_date:new Date(Date.now()+1296e6).toISOString(),promo_discount_percent:15,promo_is_active:!0,delivery_areas:[{id:"cairo",name_en:"Cairo",name_ar:"القاهرة",cities:[{id:"nasr_city",name_en:"Nasr City",name_ar:"مدينة نصر"},{id:"maadi",name_en:"Maadi",name_ar:"المعادي"},{id:"heliopolis",name_en:"Heliopolis",name_ar:"مصر الجديدة"}]},{id:"giza",name_en:"Giza",name_ar:"الجيزة",cities:[{id:"dokki",name_en:"Dokki",name_ar:"الدقي"},{id:"mohandessin",name_en:"Mohandessin",name_ar:"المهندسين"},{id:"haram",name_en:"Haram",name_ar:"الهرم"}]},{id:"alexandria",name_en:"Alexandria",name_ar:"الإسكندرية",cities:[{id:"smouha",name_en:"Smouha",name_ar:"سموحة"},{id:"miami",name_en:"Miami",name_ar:"ميامي"}]},{id:"other_gov",name_en:"Other Governorate",name_ar:"محافظة أخرى",cities:[]}],payment_details:{vodafone_cash:"010_YOUR_LIVE_VODA_NUMBER_SEEDER",instapay_ipn:"YOUR_LIVE_IPN_SEEDER@instapay",revolut_details:"@YOUR_LIVE_REVTAG_SEEDER",bank_name:"YOUR_LIVE_BANK_NAME_SEEDER",bank_account_name:"YOUR_LIVE_ACCOUNT_NAME_SEEDER",bank_account_number:"YOUR_LIVE_ACCOUNT_NUMBER_SEEDER",bank_iban:"YOUR_LIVE_IBAN_SEEDER",bank_swift:"YOUR_LIVE_SWIFT_SEEDER"}}},{collection:"livestock_types",data:{value_key:"baladi",name_en:"Baladi Sheep",name_ar:"خروف بلدي",weights_prices:[{weight_range:"30-40 kg",price_egp:4500,stock:15,is_active:!0},{weight_range:"40-50 kg",price_egp:5200,stock:10,is_active:!0},{weight_range:"50+ kg",price_egp:6e3,stock:0,is_active:!0}]}},{collection:"livestock_types",data:{value_key:"barki",name_en:"Barki Sheep",name_ar:"خروف برقي",weights_prices:[{weight_range:"35-45 kg",price_egp:5100,stock:8,is_active:!0},{weight_range:"45-55 kg",price_egp:5900,stock:12,is_active:!0}]}}];(async function(){for(const t of r)try{const r=await fetch(`${e}collections/${t.collection}/records`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data)});r.ok||console.error(`SEEDER_ERROR: Failed to create record in '${t.collection}': ${r.status} ${r.statusText} - ${await r.text()}. Record ID: ${t.data.setting_key||t.data.value_key||"N/A"}`)}catch(e){console.error(`SEEDER_EXCEPTION: Network/other error for record in '${t.collection}' (ID: ${t.data.setting_key||t.data.value_key||"N/A"}):`,e)}window.history.replaceState&&window.history.replaceState({path:location.protocol+"//"+location.host+location.pathname},"",location.protocol+"//"+location.host+location.pathname)})()}}();
