<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inline PocketBase Data Seeder (Auto-Run for Dev)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; line-height: 1.6; padding: 20px; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 800px; margin: 20px auto; background-color: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1); }
        h1 { color: #1877f2; margin-bottom: 20px; text-align: center; }
        .important { color: #856404; font-weight: bold; border: 1px solid #ffeeba; background-color: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px;}
        .important strong { display: block; margin-bottom: 5px; }
        .important ol { padding-left: 20px; margin: 0; }
        .important li { margin-bottom: 5px; }
        .log-output { margin-top: 20px; padding: 15px; background-color: #282c34; color: #abb2bf; border: 1px solid #31353f; border-radius: 6px; white-space: pre-wrap; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace; max-height: 400px; overflow-y: auto; font-size: 0.9em; }
        .log-output .info { color: #61afef; }
        .log-output .error { color: #e06c75; }
        .log-output .warn { color: #e5c07b; }
        .log-output .success { color: #98c379; }
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: bold; }
        .status.success { background-color: #e7f3ff; color: #1877f2; border: 1px solid #b8d7f9; }
        .status.error { background-color: #ffe5e5; color: #fa383e; border: 1px solid #fcc2c2; }
        .status.info { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .config-note { font-size: 0.9em; color: #606770; margin-bottom: 15px; }
        button { display: none; /* Hide manual run button if auto-running */ }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inline PocketBase Data Seeder (Auto-Run for Dev)</h1>

        <div class="important">
            <strong>IMPORTANT INSTRUCTIONS:</strong>
            <ol>
                <li>Ensure your PocketBase instance is running.</li>
                <li><strong>Collections Must Exist:</strong> This script assumes collections 'app_settings' and 'livestock_types' (and 'bookings') are ALREADY CREATED (e.g., by importing <code>pb_schema.json</code>).</li>
                <li><strong>API URL:</strong> The script defaults to <code>/</code>. If PocketBase is on a different URL (e.g., <code>http://localhost:8090</code>) AND you are NOT serving this HTML file from PocketBase itself, update <code>API_URL_PREFIX</code> in the script below. If PocketBase serves this file, <code>/api/</code> is correct.</li>
                <li><strong>Record API Rules:</strong> Temporarily open API rules for 'app_settings' and 'livestock_types' collections (specifically 'List Rule', 'Create Rule', and 'Update Rule' for *records*, e.g., set to <code>""</code> for public) if running this unauthenticated.</li>
                <li><strong>RE-SECURE YOUR RECORD API RULES IMMEDIATELY</strong> after seeding is complete!</li>
                <li>This page will attempt to run the seeder automatically when loaded in a development environment (localhost, 127.0.0.1, file protocol).</li>
            </ol>
        </div>

        <div class="config-note">
            Current API Prefix for the script: <code id="current-api-prefix-display">/</code>
        </div>
        
        <div class="status info" id="status-message">Status: Initializing...</div>
        <div class="log-output" id="log-output"></div>
    </div>

    <script>
        const logOutputDiv = document.getElementById('log-output');
        const statusMessageDiv = document.getElementById('status-message');
        const apiPrefixDisplay = document.getElementById('current-api-prefix-display');

        const API_URL_PREFIX = '/'; 
        apiPrefixDisplay.textContent = API_URL_PREFIX;


        function customLog(message, type = 'info') {
            console.log(message); 
            if (logOutputDiv) {
                const logEntry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                logEntry.innerHTML = `<span>[${timestamp}]</span> ${message.replace(/\n/g, "<br>")}`;
                logEntry.className = type;
                logOutputDiv.appendChild(logEntry);
                logOutputDiv.scrollTop = logOutputDiv.scrollHeight; 
            }
        }

        async function seedData() { // Function name changed to seedData
            if (logOutputDiv) logOutputDiv.innerHTML = ''; 
            customLog("Starting data seeding process...", 'info');
            if (statusMessageDiv) {
                statusMessageDiv.className = 'status info';
                statusMessageDiv.textContent = "Status: Seeding records in progress...";
            }
            
            const defaultAppSettingsData = {
                setting_key: "global_config", 
                exchange_rates: { EGP: { rate_from_egp: 1, symbol: 'LE', is_active: true }, USD: { rate_from_egp: 0.021, symbol: '$', is_active: true }, GBP: { rate_from_egp: 0.017, symbol: '£', is_active: true } },
                default_currency: "EGP",
                whatsapp_number_raw: "201234567890", 
                whatsapp_number_display: "+20 123 456 7890", 
                promo_end_date: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(),
                promo_discount_percent: 15, 
                promo_is_active: true,
                delivery_areas: [ { id: 'cairo', name_en: 'Cairo', name_ar: 'القاهرة', cities: [ {id: 'nasr_city', name_en: 'Nasr City', name_ar: 'مدينة نصر'}, {id: 'maadi', name_en: 'Maadi', name_ar: 'المعادي'}, {id: 'heliopolis', name_en: 'Heliopolis', name_ar: 'مصر الجديدة'} ]}, { id: 'giza', name_en: 'Giza', name_ar: 'الجيزة', cities: [ {id: 'dokki', name_en: 'Dokki', name_ar: 'الدقي'}, {id: 'mohandessin', name_en: 'Mohandessin', name_ar: 'المهندسين'}, {id: 'haram', name_en: 'Haram', name_ar: 'الهرم'} ]}, { id: 'alexandria', name_en: 'Alexandria', name_ar: 'الإسكندرية', cities: [ {id: 'smouha', name_en: 'Smouha', name_ar: 'سموحة'}, {id: 'miami', name_en: 'Miami', name_ar: 'ميامي'} ]}, { id: 'other_gov', name_en: 'Other Governorate', name_ar: 'محافظة أخرى', cities: [] } ],
                payment_details: { vodafone_cash: "010 YOUR VODA NUMBER", instapay_ipn: "YOUR.IPN@instapay", revolut_details: "@YOUR_REVTAG or Phone: +XX XXXXXXXX", bank_name: "YOUR BANK NAME", bank_account_name: "YOUR ACCOUNT HOLDER NAME", bank_account_number: "YOUR ACCOUNT NUMBER", bank_iban: "YOUR IBAN (Optional)", bank_swift: "YOUR SWIFT/BIC (Optional)" }
            };

            try {
                customLog("Processing app_settings record...", 'info');
                const checkSettingsResponse = await fetch(`${API_URL_PREFIX}/collections/app_settings/records?filter=(setting_key='global_config')&perPage=1`);
                
                if (checkSettingsResponse.status === 404) {
                    const errorText = await checkSettingsResponse.text().catch(() => "Unknown error fetching response text");
                     if (errorText.toLowerCase().includes("isn't a valid collection id or name") || errorText.toLowerCase().includes("collection not found")) {
                        throw new Error(`Collection 'app_settings' not found. Please create it first (e.g., import pb_schema.json). Seeding halted.`);
                     }
                } else if (!checkSettingsResponse.ok) {
                    throw new Error(`Checking app_settings record failed: ${checkSettingsResponse.statusText} - ${await checkSettingsResponse.text()}. Ensure 'app_settings' collection exists and its List API Rule is temporarily open if needed for this check.`);
                }
                
                const checkSettingsData = checkSettingsResponse.status === 404 ? { items: [] } : await checkSettingsResponse.json();

                if (checkSettingsData.items && checkSettingsData.items.length > 0) {
                    customLog("App settings 'global_config' record found. Updating it.", 'info');
                    const existingSettingsId = checkSettingsData.items[0].id;
                    const updateResponse = await fetch(`${API_URL_PREFIX}/collections/app_settings/records/${existingSettingsId}`, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(defaultAppSettingsData)
                    });
                    if (!updateResponse.ok) throw new Error(`Failed to update app_settings record: ${updateResponse.statusText} - ${await updateResponse.text()}`);
                    customLog("App settings record updated successfully.", 'success');
                } else {
                    customLog("App settings 'global_config' record not found. Creating it.", 'info');
                    const createResponse = await fetch(`${API_URL_PREFIX}/collections/app_settings/records`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(defaultAppSettingsData)
                    });
                    if (!createResponse.ok) throw new Error(`Failed to create app_settings record: ${createResponse.statusText} - ${await createResponse.text()}. Ensure Create API rule is temporarily open.`);
                    customLog("App settings record created successfully.", 'success');
                }
            } catch (error) {
                customLog("Error seeding app_settings record: " + error.message, 'error');
                if(statusMessageDiv) { statusMessageDiv.className = 'status error'; statusMessageDiv.textContent = "Status: Error with app_settings record. Check console/logs."; }
                alert("Error seeding app_settings. Check console. Ensure collection exists and API rules for records (List, Create, Update) are temporarily open.");
                return; 
            }

            customLog("Processing livestock_types records...", 'info');
            const defaultLivestockData = [
                { value_key: 'baladi', name_en: 'Baladi Sheep', name_ar: 'خروف بلدي', weights_prices: [ { weight_range: "30-40 kg", price_egp: 4500, stock: 15, is_active: true }, { weight_range: "40-50 kg", price_egp: 5200, stock: 10, is_active: true }, { weight_range: "50+ kg", price_egp: 6000, stock: 0, is_active: true } ] },
                { value_key: 'barki', name_en: 'Barki Sheep', name_ar: 'خروف برقي', weights_prices: [ { weight_range: "35-45 kg", price_egp: 5100, stock: 8, is_active: true }, { weight_range: "45-55 kg", price_egp: 5900, stock: 12, is_active: true } ] }
            ];
            let livestockSuccessCount = 0;
            for (const livestock of defaultLivestockData) {
                try {
                    customLog(`Processing livestock record: ${livestock.value_key}`, 'info');
                    const checkLivestockResponse = await fetch(`${API_URL_PREFIX}/collections/livestock_types/records?filter=(value_key='${livestock.value_key}')&perPage=1`);
                    
                    if (checkLivestockResponse.status === 404) {
                        const errorText = await checkLivestockResponse.text().catch(() => "Unknown error fetching response text");
                         if (errorText.toLowerCase().includes("isn't a valid collection id or name") || errorText.toLowerCase().includes("collection not found")) {
                            throw new Error(`Collection 'livestock_types' not found for ${livestock.value_key}. Please create it first.`);
                         }
                    } else if (!checkLivestockResponse.ok) {
                        throw new Error(`Checking livestock record ${livestock.value_key} failed: ${checkLivestockResponse.statusText} - ${await checkLivestockResponse.text()}. Ensure 'livestock_types' collection exists and List API rule is temporarily open.`);
                    }
                    const checkLivestockData = checkLivestockResponse.status === 404 ? { items: [] } : await checkLivestockResponse.json();

                    if (checkLivestockData.items && checkLivestockData.items.length > 0) {
                        customLog(`Livestock record '${livestock.value_key}' found. Updating.`, 'info');
                        const updateResponse = await fetch(`${API_URL_PREFIX}/collections/livestock_types/records/${checkLivestockData.items[0].id}`, {
                            method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(livestock)
                        });
                        if (!updateResponse.ok) throw new Error(`Update failed for ${livestock.value_key}: ${updateResponse.statusText} - ${await updateResponse.text()}`);
                        customLog(`Livestock record '${livestock.value_key}' updated successfully.`, 'success');
                    } else {
                        customLog(`Livestock record '${livestock.value_key}' not found. Creating it.`, 'info');
                        const createResponse = await fetch(`${API_URL_PREFIX}/collections/livestock_types/records`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(livestock)
                        });
                        if (!createResponse.ok) throw new Error(`Create failed for ${livestock.value_key}: ${createResponse.statusText} - ${await createResponse.text()}. Ensure Create API rule is temporarily open.`);
                        customLog(`Livestock record '${livestock.value_key}' created successfully.`, 'success');
                    }
                    livestockSuccessCount++;
                } catch (error) {
                    customLog(`Error seeding livestock record ${livestock.value_key}: ` + error.message, 'error');
                    alert(`Error seeding livestock ${livestock.value_key}. Check console. Ensure collection exists and API rules for records (List, Create, Update) are temporarily open.`);
                }
            }
            if (livestockSuccessCount === defaultLivestockData.length) customLog("All livestock records processed successfully.", 'success');
            else customLog(`${livestockSuccessCount} of ${defaultLivestockData.length} livestock records processed. Some had errors.`, 'warn');

            customLog("Data record seeding process finished. IMPORTANT: Remember to re-secure your Record API Rules in PocketBase if you opened them!", 'warn');
            if(statusMessageDiv) {
                statusMessageDiv.className = 'status success';
                statusMessageDiv.textContent = "Status: Data record seeding finished. Check logs. RE-SECURE RECORD API RULES!";
            }
            alert("Data record seeding finished. Refresh your main application page. IMPORTANT: Review and re-secure your PocketBase API rules for app_settings and livestock_types records.");
        }
        
        // Auto-run on page load if in a dev environment
        document.addEventListener('DOMContentLoaded', () => {
            // Check if served from PocketBase dev server or as a local file
            if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.protocol === "file:") {
                customLog("Development environment detected, auto-running data seeder...", 'info');
                if (statusMessageDiv) {
                    statusMessageDiv.className = 'status info'; 
                    statusMessageDiv.textContent = "Status: Auto-running data seeder...";
                }
                seedData().catch(e => { // Call seedData and catch any top-level errors
                    customLog("Auto-run of data seeder failed overall: " + e.message, 'error');
                    if(statusMessageDiv) {
                        statusMessageDiv.className = 'status error'; 
                        statusMessageDiv.textContent = "Status: Auto-run failed. Check console/logs.";
                    }
                });
            } else {
                customLog("Data seeder auto-run skipped: Not a recognized development environment. You may need to call seedData() manually from the console if intended.", 'warn');
                 if(statusMessageDiv) {
                    statusMessageDiv.className = 'status info'; 
                    statusMessageDiv.textContent = "Status: Auto-run skipped (not dev environment).";
                }
            }
        });
    </script>
</body>
</html>
