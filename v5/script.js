document.addEventListener('alpine:init',()=>{const t={selectedAnimal:{type:"",value:"",weight:"",basePriceEGP:0,nameEN:"",nameAR:"",stock:null,pbId:null,originalStock:null},selectedPrepStyle:{value:"",nameEN:"",nameAR:"",is_custom:!1},customPrepDetails:"",selectedPackaging:{value:"",addonPriceEGP:0,nameEN:"",nameAR:""},totalPriceEGP:0,customerEmail:"",deliveryName:"",deliveryPhone:"",selectedGovernorate:"",deliveryCity:"",availableCities:[],deliveryAddress:"",deliveryInstructions:"",niyyahNames:"",splitDetailsOption:"",customSplitDetailsText:"",groupPurchase:!1,selectedSacrificeDay:{value:"day1_10_dhul_hijjah",textEN:"Day 1 of Eid (10th Dhul Hijjah)",textAR:"اليوم الأول (10 ذو الحجة)"},selectedTimeSlot:"8 AM-9 AM",distributionChoice:"me",paymentMethod:"fa",errors:{}};async function e(n,{recordId:o="",params:s=""}={}){const r=`/api/collections/${n}/records${o?`/${o}`:""}${s?`?${s}`:""}`;try{const t=await fetch(r,options.fetchOptions);if(!t.ok){let e=t.statusText,n="";try{n=await t.text();const s=JSON.parse(n);s&&"object"==typeof s.data&&null!==s.data?e=Object.values(s.data).map(t=>t.message||JSON.stringify(t)).join("; "):s&&s.message&&(e=s.message)}catch(t){e=n||t.statusText}throw new Error(`API Error (${collection} ${recordId||params}): ${response.status} ${e}`)}const a=await t.text();if(!a)return{items:[]};try{return JSON.parse(a)}catch(t){throw new Error(`API Error (${collection} ${recordId||params}): Failed to parse successful response. ${t.message}`)}}catch(n){const t="string"==typeof n.message?n.message:"Unknown network error";throw new Error(`Network Error: Could not connect to API. (${t}`)}}Alpine.data("udheyaBooking",()=>({isLoading:{status:!1,booking:!1,init:!0},appSettings:{exchange_rates:{EGP:{rate_from_egp:1,symbol:"LE",is_active:!0},USD:{rate_from_egp:0,symbol:"$",is_active:!1},GBP:{rate_from_egp:0,symbol:"£",is_active:!1}},default_currency:"EGP",whatsapp_number_raw:"",whatsapp_number_display:"",promo_end_date:null,promo_discount_percent:0,promo_is_active:!0,delivery_areas:[],payment_details:{vodafone_cash:"",instapay_ipn:"",revolut_details:"",bank_name:"",bank_account_name:"",bank_account_number:"",bank_iban:"",bank_swift:""}},productOptions:{livestock:[],preparationStyles:[{value:"Standard Mixed Cuts",nameEN:"Standard Mix",nameAR:"مزيج قياسي",is_custom:!1},{value:"Charity Portions",nameEN:"Charity Portions",nameAR:"حصص صدقة",is_custom:!1},{value:"Feast Preparation",nameEN:"Feast Preparation",nameAR:"تجهيز ولائم",is_custom:!1},{value:"Custom & Ground Mix",nameEN:"Custom & Ground",nameAR:"مخصص ومفروم",is_custom:!0}],packagingOptions:[{value:"standard",nameEN:"Standard Packaging",nameAR:"تعبئة قياسية",addonPriceEGP:0},{value:"vacuum_sealed",nameEN:"Vacuum Sealed",nameAR:"تعبئة مفرغة",addonPriceEGP:100}]},apiError:null,userFriendlyApiError:"",...JSON.parse(JSON.stringify(t)),bookingConfirmed:!1,statusResult:null,statusNotFound:!1,lookupBookingID:"",currentCurrency:"EGP",bookingID:"",currentActiveStep:1,isMobileMenuOpen:!1,stepSectionsMeta:[],countdown:{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!1},promoHasEnded:!1,calculatedPromoDaysLeft:0,countdownTimerInterval:null,currentLang:"en",errorMessages:{required:{en:"This field is required.",ar:"هذا الحقل مطلوب."},select:{en:"Please make a selection.",ar:"يرجى الاختيار."},email:{en:"Please enter a valid email address.",ar:"يرجى إدخال بريد إلكتروني صحيح."},phone:{en:"Please enter a valid phone number.",ar:"يرجى إدخال رقم هاتف صحيح."}},setError(e,n){let o;o="string"==typeof n?this.errorMessages[n]||this.errorMessages.required:n,this.errors[e]="object"!=typeof o||null===o||"string"!=typeof o.en||"string"!=typeof o.ar?this.errorMessages.required:o},clearError(t){this.errors[t]&&this.$delete(this.errors,t)},clearAllErrors(){this.errors={}},focusOnRef(t){this.$nextTick(()=>{this.$refs[t]&&(this.$refs[t].focus({preventScroll:!1}),setTimeout(()=>{try{this.$refs[t].scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch(t){}},50))})},get _needsDeliveryDetails(){const t=(this.customSplitDetailsText||"").toLowerCase();return"me"===this.distributionChoice||"split"===this.distributionChoice&&(["1/3_me_2/3_charity_sl","1/2_me_1/2_charity_sl","2/3_me_1/3_charity_sl","all_me_custom_distro"].includes(this.splitDetailsOption)||"custom"===this.splitDetailsOption&&(t.includes("for me")||t.includes("all delivered to me")))},get splitDetails(){return"split"!==this.distributionChoice?"":"custom"===this.splitDetailsOption?(this.customSplitDetailsText||"").trim():{"1/3_me_2/3_charity_sl":"1/3 for me (delivered), 2/3 for charity (by Sheep Land)","1/2_me_1/2_charity_sl":"1/2 for me (delivered), 1/2 for charity (by Sheep Land)","2/3_me_1/3_charity_sl":"2/3 for me (delivered), 1/3 for charity (by Sheep Land)","all_me_custom_distro":"All for me (for my own distribution)"}[this.splitDetailsOption]||this.splitDetailsOption},_getDeliveryLocation(t){const e="en"===t?"name_en":"name_ar",n=(this.appSettings.delivery_areas||[]).find(e=>e.id===this.selectedGovernorate),o=n?.cities?.find(t=>t.id===this.deliveryCity);return o&&"string"==typeof o[e]?o[e]:n&&0===n.cities?.length&&this.selectedGovernorate&&"string"==typeof n[e]?n[e]:n&&!o&&this.selectedGovernorate&&"string"==typeof n[e]?`${n[e]} (${"en"===t?"City not selected":"المدينة غير مختارة"})`:""},get summaryDeliveryToEN(){if("char"===this.distributionChoice)return"Charity Distribution by Sheep Land";if(this._needsDeliveryDetails){const t=(this.deliveryName||"").trim(),e=(this.deliveryPhone||"").trim(),n=this.selectedGovernorate,o=this.deliveryCity,s=(this.deliveryAddress||"").trim(),r=(this.appSettings.delivery_areas||[]).find(t=>t.id===n),a=r&&r.cities?.length>0&&!o;if(!t||!e||!n||a||!s)return"Delivery Details Incomplete";const i=this._getDeliveryLocation("en"),l=s?s.substring(0,20)+(s.length>20?"...":""):"";return[t,i,l].filter(t=>"string"==typeof t&&""!==t.trim()).join(", ")}return"Self Pickup / Distribution as per split"},get summaryDeliveryToAR(){if("char"===this.distributionChoice)return"توزيع خيري بواسطة أرض الأغنام";if(this._needsDeliveryDetails){const t=(this.deliveryName||"").trim(),e=(this.deliveryPhone||"").trim(),n=this.selectedGovernorate,o=this.deliveryCity,s=(this.deliveryAddress||"").trim(),r=(this.appSettings.delivery_areas||[]).find(t=>t.id===n),a=r&&r.cities?.length>0&&!o;if(!t||!e||!n||a||!s)return"تفاصيل التوصيل غير مكتملة";const i=this._getDeliveryLocation("ar"),l=s?s.substring(0,20)+(s.length>20?"...":""):"";return[t,i,l].filter(t=>"string"==typeof t&&""!==t.trim()).join("، ")}return"استلام ذاتي / توزيع حسب التقسيم"},get summaryDistributionEN(){return"me"===this.distributionChoice?"All to me":"char"===this.distributionChoice?"All to charity (by Sheep Land)":`Split: ${(this.splitDetails||"").trim()||"(Not specified)"}`},get summaryDistributionAR(){return"me"===this.distributionChoice?"الكل لي (لتوزيعه بنفسك)":"char"===this.distributionChoice?"تبرع بالكل للصدقة (أرض الأغنام توزع نيابة عنك)":`تقسيم الحصص: ${(this.splitDetails||"").trim()||"(لم يحدد)"}`},async initApp(){this.isLoading.init=!0,this.apiError=null,this.userFriendlyApiError="";const n=JSON.parse(JSON.stringify(this.appSettings));try{const t=await e("app_settings",{params:"filter=(setting_key='global_config')&perPage=1"}),o=await e("livestock_types");if(t&&t.items&&t.items.length>0){const e=t.items[0],o=JSON.parse(JSON.stringify(n));for(const t in e)e.hasOwnProperty(t)&&("object"==typeof e[t]&&null!==e[t]&&void 0!==o[t]&&"object"==typeof o[t]&&null!==o[t]&&!Array.isArray(e[t])?o[t]={...o[t],...e[t]}:o[t]=e[t]);this.appSettings=o}else this.appSettings=n;o&&o.items?this.productOptions.livestock=o.items.map(t=>({pbId:t.id,value_key:t.value_key,name_en:t.name_en,name_ar:t.name_ar,weights_prices:Array.isArray(t.weights_prices)?t.weights_prices.map(t=>({...t})):[]})):this.productOptions.livestock=[]}catch(t){this.apiError=t.message||"An unknown error occurred during data fetch.",this.userFriendlyApiError="string"==typeof t.message&&t.message.includes("Network Error")?t.message:"Failed to load application settings. Please refresh or try again later.",this.appSettings=JSON.parse(JSON.stringify(n)),this.productOptions.livestock=[]}finally{this.isLoading.init=!1}"string"!=typeof this.appSettings.default_currency&&(this.appSettings.default_currency="EGP"),this.currentCurrency=this.appSettings.default_currency||"EGP",this.startOfferDHDMSCountdown(),this.updateSacrificeDayTexts(),this.updateAllDisplayedPrices(),this.clearAllErrors(),this.$watch(["selectedAnimal.basePriceEGP","selectedPackaging.addonPriceEGP"],()=>this.calculateTotalPrice()),this.$watch("currentCurrency",()=>{this.calculateTotalPrice(),this.updateAllDisplayedPrices()}),this.$watch("selectedSacrificeDay.value",()=>this.updateSacrificeDayTexts()),this.$watch("distributionChoice",t=>{"split"!==t&&(this.splitDetailsOption="",this.customSplitDetailsText=""),"char"===t&&Object.assign(this,{deliveryName:"",deliveryPhone:"",selectedGovernorate:"",deliveryCity:"",deliveryAddress:"",deliveryInstructions:"",availableCities:[]}),this.clearError("splitDetails")}),this.$watch("selectedPrepStyle.value",()=>{this.selectedPrepStyle.is_custom||(this.customPrepDetails="")}),this.$watch("splitDetailsOption",t=>{"custom"!==t&&(this.customSplitDetailsText=""),this.clearError("splitDetails")}),this.$watch("selectedGovernorate",()=>{this.updateCities(),this.clearError("deliveryCity")}),this.stepSectionsMeta=["#step1-content","#step2-content","#step3-content","#step4-content","#step5-content"].map((t,e)=>({id:t,step:e+1,element:document.querySelector(t),titleRef:`step${e+1}Title`,firstFocusableErrorRef:null})),this.$nextTick(()=>{this.handleScroll();const t=this.bookingConfirmed?"bookingConfirmedTitle":this.$refs.step1Title?"step1Title":"bookingSectionTitle";this.focusOnRef(t)}),window.addEventListener("scroll",()=>this.handleScroll(),{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"?this.startOfferDHDMSCountdown():this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval)})},startOfferDHDMSCountdown(){this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),this.appSettings.promo_is_active&&this.appSettings.promo_end_date?this.appSettings.promo_end_date&&"string"==typeof this.appSettings.promo_end_date?isNaN(new Date(this.appSettings.promo_end_date).getTime())?this.countdown.ended=!0:(this.updateDHDMSCountdownDisplay(new Date(this.appSettings.promo_end_date).getTime()),this.countdownTimerInterval=setInterval(()=>this.updateDHDMSCountdownDisplay(new Date(this.appSettings.promo_end_date).getTime()),1e3)):this.countdown.ended=!0:(this.countdown.ended=!0,this.promoHasEnded=!0,this.calculatedPromoDaysLeft=0)},updateDHDMSCountdownDisplay(t){const e=(new Date).getTime(),n=t-e;if(n<0)return this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),Object.assign(this.countdown,{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!0}),this.promoHasEnded=!0,void(this.calculatedPromoDaysLeft=0);this.countdown.ended=!1,this.promoHasEnded=!1;const o=Math.floor(n/864e5),s=Math.floor(n%864e5/36e5),r=Math.floor(n%36e5/6e4),a=Math.floor(n%6e4/1e3);Object.assign(this.countdown,{days:String(o).padStart(2,"0"),hours:String(s).padStart(2,"0"),minutes:String(r).padStart(2,"0"),seconds:String(a).padStart(2,"0")}),this.calculatedPromoDaysLeft=o},handleScroll(){if(this.bookingConfirmed||!this.stepSectionsMeta.some(t=>t.element&&"number"==typeof t.element.offsetTop))return;const t=(document.querySelector(".site-header")?.offsetHeight||70)+(document.querySelector(".stepper-outer-wrapper")?.offsetHeight||55)+20;let e=this.currentActiveStep;const n=window.scrollY+t;for(let o=0;o<this.stepSectionsMeta.length;o++){const s=this.stepSectionsMeta[o];if(s.element&&"number"==typeof s.element.offsetTop){const r=s.element.offsetTop,a=r+s.element.offsetHeight;n>=r&&n<a?(e=s.step,o===this.stepSectionsMeta.length-1&&n>=r&&(e=s.step)):n<r&&0===o&&(e=1)}}const o=this.stepSectionsMeta[this.stepSectionsMeta.length-1]?.element;o&&"number"==typeof o.offsetTop&&n>=o.offsetTop+o.offsetHeight&&(e=this.stepSectionsMeta[this.stepSectionsMeta.length-1].step),this.currentActiveStep!==e&&(()=>{let t=!0;for(let n=1;n<e;n++)if(!this.currentStepCompleted(n,!1)){t=!1;break}t&&(this.currentActiveStep=e)})()},updateCities(){const t=(this.appSettings.delivery_areas||[]).find(t=>t.id===this.selectedGovernorate);this.availableCities=t?.cities||[],this.deliveryCity=""},getFormattedPrice(t,e){const n=e||this.currentCurrency,o=this.appSettings&&this.appSettings.exchange_rates?this.appSettings.exchange_rates[n]:null;return null==t||!o||"number"!=typeof o.rate_from_egp?`${o?.symbol||"?"} ---`:`${o.symbol} ${(t*o.rate_from_egp).toFixed(2)}`},isValidEmail:t=>!t||"string"!=typeof t||!t.trim()||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),isValidPhone:t=>t&&"string"==typeof t&&/^\+?[0-9\s\-()]{7,20}$/.test(t.trim()),scrollToSection:t=>{try{const e=document.querySelector(t);if(e){const t=(document.querySelector(".site-header")?.offsetHeight||0)+(document.querySelector(".stepper-outer-wrapper")?.offsetHeight||0),n=e.getBoundingClientRect().top,o=n+window.pageYOffset-t;window.scrollTo({top:o,behavior:"smooth"})}}catch(t){}},navigateToStep(t){this.clearAllErrors();for(let e=1;e<t;e++)if(!this.currentStepCompleted(e,!0)){this.currentActiveStep=e,this.scrollToSection(this.stepSectionsMeta[e-1]?.id||"#udheya-booking-form-panel");return}this.currentActiveStep=t,this.focusOnRef(this.stepSectionsMeta[t-1]?.titleRef),this.scrollToSection(this.stepSectionsMeta[t-1]?.id||"#udheya-booking-form-panel")},currentStepCompleted(t,e=!0){let n=!1;const o=e&&this.currentActiveStep===t;switch(t){case 1:n=this.validateStep1(o);break;case 2:n=this.validateStep2(o);break;case 3:n=this.validateStep3(o);break;case 4:n=this.validateStep4(o);break;case 5:n=this.validateStep5(o);break;default:n=!1}return n&&o&&this.stepSectionsMeta[t-1]&&(this.stepSectionsMeta[t-1].firstFocusableErrorRef=null),n},validateAndProceedToStep(t){this.clearAllErrors();let e=this.currentStepCompleted(this.currentActiveStep,!0);e?t<=this.stepSectionsMeta.length?(this.currentActiveStep=t,this.$nextTick(()=>{this.focusOnRef(this.stepSectionsMeta[t-1]?.titleRef),this.scrollToSection(this.stepSectionsMeta[t-1]?.id||"#udheya-booking-form-panel")})):this.$nextTick(()=>{this.scrollToSection(this.stepSectionsMeta[this.currentActiveStep-1]?.id||"#udheya-booking-form-panel")})},validateStep1(t=!0){t&&this.clearError("animal");let e=null;return this.selectedAnimal.type?this.stepSectionsMeta[0]&&(this.stepSectionsMeta[0].firstFocusableErrorRef=null),!0:(t&&(this.setError("animal","select"),e=this.$refs.baladiWeightSelect?.closest(".livestock-card")?"baladiWeightSelect":"barkiWeightSelect",this.focusOnRef(e)),this.stepSectionsMeta[0]&&(this.stepSectionsMeta[0].firstFocusableErrorRef=e),!1)},validateStep2(t=!0){t&&(this.clearError("prepStyle"),this.clearError("packaging"));let e=!0,n=null;return this.selectedPrepStyle.value||(t&&(this.setError("prepStyle","select"),n||(n="prepStyleSelect")),e=!1),this.selectedPackaging.value||(t&&(this.setError("packaging","select"),n||(n="packagingSelect")),e=!1),t&&n&&this.focusOnRef(n),this.stepSectionsMeta[1]&&(this.stepSectionsMeta[1].firstFocusableErrorRef=n),e},validateStep3(t=!0){return this.stepSectionsMeta[2]&&(this.stepSectionsMeta[2].firstFocusableErrorRef=null),!0},validateStep4(t=!0){t&&(this.clearError("splitDetails"),this.clearError("deliveryName"),this.clearError("deliveryPhone"),this.clearError("customerEmail"),this.clearError("selectedGovernorate"),this.clearError("deliveryCity"),this.clearError("deliveryAddress"));let e=!0,n=null;const o=(o,s,r)=>{t&&this.setError(o,s),e=!1,t&&!n&&(n=r)};if("split"===this.distributionChoice&&(this.splitDetailsOption?this.splitDetailsOption==="custom"&&!(this.customSplitDetailsText||"").trim()&&o("splitDetails","required","customSplitTextarea"):o("splitDetails","select","distributionChoiceRadios")),this._needsDeliveryDetails){(this.deliveryName||"").trim()||o("deliveryName","required","deliveryNameInput"),(this.deliveryPhone||"").trim()?this.isValidPhone((this.deliveryPhone||"").trim())||o("deliveryPhone","phone","deliveryPhoneInput"):o("deliveryPhone","required","deliveryPhoneInput"),(this.customerEmail||"").trim()&&!this.isValidEmail((this.customerEmail||"").trim())&&o("customerEmail","email","customerEmailInput"),this.selectedGovernorate||o("selectedGovernorate","select","deliveryGovernorateSelect");const t=(this.appSettings.delivery_areas||[]).find(t=>t.id===this.selectedGovernorate);t&&t.cities?.length>0&&!this.deliveryCity&&o("deliveryCity","select","deliveryCitySelect"),(this.deliveryAddress||"").trim()||o("deliveryAddress","required","deliveryAddressInput")}return t&&n&&this.focusOnRef(n),this.stepSectionsMeta[3]&&(this.stepSectionsMeta[3].firstFocusableErrorRef=n),e},validateStep5(t=!0){t&&this.clearError("paymentMethod");let e=null;return this.paymentMethod?this.stepSectionsMeta[4]&&(this.stepSectionsMeta[4].firstFocusableErrorRef=null),!0:(t&&(this.setError("paymentMethod","select"),e="paymentMethodRadios",this.focusOnRef(e)),this.stepSectionsMeta[4]&&(this.stepSectionsMeta[4].firstFocusableErrorRef=e),!1)},selectAnimal(t,e){this.clearError("animal");const n=this.productOptions.livestock.find(t=>t.value_key===e),o=t.querySelector(".livestock-weight-select");if(!n||!o||!o.value)return this.setError("animal","select"),void this.focusOnRef(o&&o.id.includes("baladi")?"baladiWeightSelect":"barkiWeightSelect");const s=n.weights_prices.find(t=>t.weight_range===o.value);return!s||!s.is_active||null!=s.stock&&s.stock<=0?(this.setError("animal",{en:`${n.name_en||"Selected animal"} (${o.value}) is out of stock.`,ar:`${n.name_ar||"الحيوان المختار"} (${o.value}) غير متوفر.`}),void this.updateAllDisplayedPrices()):(this.selectedAnimal={type:n.value_key,value:n.value_key,weight:s.weight_range,basePriceEGP:parseFloat(s.price_egp),stock:s.stock,originalStock:s.stock,nameEN:n.name_en,nameAR:n.name_ar,pbId:n.pbId},this.calculateTotalPrice(),void(this.validateStep1(!1)||console.warn("selectAnimal: Step 1 still not valid after selection (no auto-advance with button).")))},isLivestockWeightOutOfStock(t,e){const n=this.productOptions.livestock.find(t=>t.value_key===e);if(!n||!t||!t.value)return!0;const o=n.weights_prices.find(e=>e.weight_range===t.value);return!o||!o.is_active||null!=o.stock&&o.stock<=0},updateSelectedPrepStyle(t){const e=this.productOptions.preparationStyles.find(e=>e.value===t);e?this.selectedPrepStyle={...e}:this.selectedPrepStyle={value:"",nameEN:"",nameAR:"",is_custom:!1},this.calculateTotalPrice()},updateSelectedPackaging(t){const e=this.productOptions.packagingOptions.find(e=>e.value===t);e?this.selectedPackaging={...e,addonPriceEGP:parseFloat(e.addonPriceEGP||0)}:this.selectedPackaging={value:"",addonPriceEGP:0,nameEN:"",nameAR:""},this.calculateTotalPrice()},updateSacrificeDayTexts(){const t=document.querySelector(`#sacrifice_day_select_s3 option[value="${this.selectedSacrificeDay.value}"]`);t&&Object.assign(this.selectedSacrificeDay,{textEN:t.dataset.en,textAR:t.dataset.ar})},calculateTotalPrice(){this.totalPriceEGP=(this.selectedAnimal.basePriceEGP||0)+(this.selectedPackaging.addonPriceEGP||0)},updateAllDisplayedPrices(){try{(this.productOptions.livestock||[]).forEach(t=>{const e=document.getElementById(t.value_key),n=e?.querySelector(".livestock-weight-select");if(!e||!n)return;const o=n.value;n.innerHTML="";let s=null,r=!1;(t.weights_prices||[]).forEach(t=>{const e=document.createElement("option");e.value=t.weight_range;const a=!t.is_active||null!=t.stock&&t.stock<=0,i=a?" - Out of Stock":null!=t.stock?` - Stock: ${t.stock}`:"";e.textContent=`${t.weight_range||""} (${this.getFormattedPrice(t.price_egp)})${i}`,e.disabled=a,n.appendChild(e),a||null!==s||(s=t.weight_range),t.weight_range===o&&!a&&(r=!0)}),n.value=o&&r?o:s||(n.options.length?n.options[0].value:"");const a=(t.weights_prices||[]).find(t=>t.is_active&&(null==t.stock||t.stock>0)),i=a?a.price_egp:(t.weights_prices||[])[0]?.price_egp||0,l=e.querySelector(".price.bil-row .en span"),c=e.querySelector(".price.bil-row .ar span");l&&(l.textContent=this.getFormattedPrice(i)),c&&(c.textContent=this.getFormattedPrice(i))}),this.calculateTotalPrice()}catch(t){this.userFriendlyApiError="Error updating price displays."}},async validateAndSubmitBooking(){if(this.clearAllErrors(),!this.currentStepCompleted(1,!0))return void this.navigateToStep(1);if(!this.currentStepCompleted(2,!0))return void this.navigateToStep(2);if(!this.currentStepCompleted(3,!0))return void this.navigateToStep(3);if(!this.currentStepCompleted(4,!0))return void this.navigateToStep(4);if(!this.currentStepCompleted(5,!0))return void this.navigateToStep(5);const t=this.productOptions.livestock.find(t=>t.value_key===this.selectedAnimal.value),n=t?.weights_prices.find(t=>t.weight_range===this.selectedAnimal.weight);if(!t||!n||!n.is_active||null!=n.stock&&n.stock<=0)return this.setError("animal",{en:`Sorry, ${this.selectedAnimal.nameEN||"item"} is no longer available. Please reselect.`,ar:`عذراً، ${this.selectedAnimal.nameAR||"المنتج"} لم يعد متوفراً. يرجى إعادة الاختيار.`}),this.selectedAnimal={...initialBookingFormState.selectedAnimal},this.updateAllDisplayedPrices(),void this.navigateToStep(1);this.isLoading.booking=!0,this.apiError=null,this.userFriendlyApiError="",this.calculateTotalPrice();const o=this,s={booking_id_text:`SL-UDHY-${(new Date).getFullYear()}-${String(Math.floor(9e4*Math.random())+1e4).padStart(5,"0")}`,animal_type_key:o.selectedAnimal.value,animal_type_name_en:o.selectedAnimal.nameEN,animal_type_name_ar:o.selectedAnimal.nameAR,animal_weight_selected:o.selectedAnimal.weight,animal_base_price_egp:o.selectedAnimal.basePriceEGP,preparation_style_value:o.selectedPrepStyle.value,preparation_style_name_en:o.selectedPrepStyle.nameEN,preparation_style_name_ar:o.selectedPrepStyle.nameAR,is_custom_prep:o.selectedPrepStyle.is_custom,custom_prep_details:o.selectedPrepStyle.is_custom?(o.customPrepDetails||"").trim():"",packaging_value:o.selectedPackaging.value,packaging_name_en:o.selectedPackaging.nameEN,packaging_name_ar:o.selectedPackaging.nameAR,packaging_addon_price_egp:o.selectedPackaging.addonPriceEGP,total_price_egp:o.totalPriceEGP,sacrifice_day_value:o.selectedSacrificeDay.value,time_slot:o.selectedTimeSlot,distribution_choice:o.distributionChoice,split_details_option:"split"===o.distributionChoice?o.splitDetailsOption:"",custom_split_details_text:"split"===o.distributionChoice&&"custom"===o.splitDetailsOption?(o.customSplitDetailsText||"").trim():"",niyyah_names:(o.niyyahNames||"").trim(),customer_email:(o.customerEmail||"").trim(),group_purchase_interest:o.groupPurchase,delivery_name:o._needsDeliveryDetails?(o.deliveryName||"").trim():"",delivery_phone:o._needsDeliveryDetails?(o.deliveryPhone||"").trim():"",delivery_governorate_id:o._needsDeliveryDetails?o.selectedGovernorate:"",delivery_city_id:o._needsDeliveryDetails?o.deliveryCity:"",delivery_address:o._needsDeliveryDetails?(o.deliveryAddress||"").trim():"",delivery_instructions:o._needsDeliveryDetails?(o.deliveryInstructions||"").trim():"",payment_method:o.paymentMethod,payment_status:"cod"===o.paymentMethod&&o._needsDeliveryDetails?"cod_pending":"pending",booking_status:"confirmed_pending_payment"};try{const r=await e("bookings",{fetchOptions:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}});this.bookingID=r.booking_id_text||r.id,null!=n.stock&&n.stock>0&&(n.stock--,this.updateAllDisplayedPrices()),this.bookingConfirmed=!0,this.$nextTick(()=>{this.scrollToSection("#booking-confirmation-section"),this.focusOnRef("bookingConfirmedTitle")})}catch(t){this.apiError=t.message,this.userFriendlyApiError=t.message.includes("Network Error")?t.message:"There was an issue submitting your booking. Please review your details or try again. If the problem persists, contact support.",this.scrollToSection(".global-error-indicator")}finally{this.isLoading.booking=!1}},async validateAndCheckBookingStatus(){if(this.clearError("lookupBookingID"),!(this.lookupBookingID||"").trim())return this.setError("lookupBookingID","required"),void this.focusOnRef("lookupBookingIdInput");await this.checkBookingStatus()},async checkBookingStatus(){this.statusResult=null,this.statusNotFound=!1,this.isLoading.status=!0,this.apiError=null,this.userFriendlyApiError="";const t=(this.lookupBookingID||"").trim();try{const n=await e("bookings",{params:`filter=(booking_id_text='${encodeURIComponent(t)}')&perPage=1`});n.items&&n.items.length>0?(this.statusResult={booking_id_text:(o=n.items[0]).booking_id_text||o.id,status:o.booking_status||"Unknown",animal_type:o.animal_type_name_en||o.animal_type_key,animal_weight_selected:o.animal_weight_selected,sacrifice_day:o.sacrifice_day_value,time_slot:o.time_slot}):this.statusNotFound=!0}catch(t){this.apiError=t.message,this.userFriendlyApiError=t.message.includes("Network Error")?t.message:"Could not retrieve booking status. Please check the ID or try again later.",this.statusNotFound=!0}finally{this.isLoading.status=!1};var o},getSacrificeDayText(t){const e=document.querySelector(`#sacrifice_day_select_s3 option[value="${t}"]`);return e?{en:e.dataset.en,ar:e.dataset.ar}:{en:t,ar:t}},resetAndStartOver(){Object.assign(this,JSON.parse(JSON.stringify(t)),{bookingConfirmed:!1,bookingID:"",lookupBookingID:"",statusResult:null,statusNotFound:!1,currentActiveStep:1,isMobileMenuOpen:!1,apiError:null,userFriendlyApiError:"",countdown:{days:"00",hours:"00",minutes:"00",seconds:"00",ended:!1},promoHasEnded:!1,calculatedPromoDaysLeft:0}),this.countdownTimerInterval&&clearInterval(this.countdownTimerInterval),this.initApp(),this.$nextTick(()=>{this.scrollToSection("#udheya-booking-start"),this.focusOnRef("bookingSectionTitle")})}}))}),function(){if("true"===new URLSearchParams(window.location.search).get("run_db_seed")){const t="/api/",e=[{collection:"app_settings",data:{setting_key:"global_config",exchange_rates:{EGP:{rate_from_egp:1,symbol:"LE",is_active:!0},USD:{rate_from_egp:.021,symbol:"$",is_active:!0},GBP:{rate_from_egp:.017,symbol:"£",is_active:!0}},default_currency:"EGP",whatsapp_number_raw:"201234567890",whatsapp_number_display:"+20 123 456 7890",promo_end_date:new Date(Date.now()+1296e6).toISOString(),promo_discount_percent:15,promo_is_active:!0,delivery_areas:[{id:"cairo",name_en:"Cairo",name_ar:"القاهرة",cities:[{id:"nasr_city",name_en:"Nasr City",name_ar:"مدينة نصر"},{id:"maadi",name_en:"Maadi",name_ar:"المعادي"},{id:"heliopolis",name_en:"Heliopolis",name_ar:"مصر الجديدة"}]},{id:"giza",name_en:"Giza",name_ar:"الجيزة",cities:[{id:"dokki",name_en:"Dokki",name_ar:"الدقي"},{id:"mohandessin",name_en:"Mohandessin",name_ar:"المهندسين"},{id:"haram",name_en:"Haram",name_ar:"الهرم"}]},{id:"alexandria",name_en:"Alexandria",name_ar:"الإسكندرية",cities:[{id:"smouha",name_en:"Smouha",name_ar:"سموحة"},{id:"miami",name_en:"Miami",name_ar:"ميامي"}]},{id:"other_gov",name_en:"Other Governorate",name_ar:"محافظة أخرى",cities:[]}],payment_details:{vodafone_cash:"010 YOUR VODA NUMBER",instapay_ipn:"YOUR.IPN@instapay",revolut_details:"@YOUR_REVTAG or Phone: +XX XXXXXXXX",bank_name:"YOUR BANK NAME",bank_account_name:"YOUR ACCOUNT HOLDER NAME",bank_account_number:"YOUR ACCOUNT NUMBER",bank_iban:"YOUR IBAN (Optional)",bank_swift:"YOUR SWIFT/BIC (Optional)"}}},{collection:"livestock_types",data:{value_key:"baladi",name_en:"Baladi Sheep",name_ar:"خروف بلدي",weights_prices:[{weight_range:"30-40 kg",price_egp:4500,stock:15,is_active:!0},{weight_range:"40-50 kg",price_egp:5200,stock:10,is_active:!0},{weight_range:"50+ kg",price_egp:6e3,stock:0,is_active:!0}]}},{collection:"livestock_types",data:{value_key:"barki",name_en:"Barki Sheep",name_ar:"خروف برقي",weights_prices:[{weight_range:"35-45 kg",price_egp:5100,stock:8,is_active:!0},{weight_range:"45-55 kg",price_egp:5900,stock:12,is_active:!0}]}}];(async function(){for(const n of e){n.data.setting_key||n.data.value_key;try{const e=await fetch(`${t}collections/${n.collection}/records`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.data)});if(!e.ok){await e.text();e.status,e.statusText}}catch(t){}}window.history.replaceState&&window.history.replaceState({path:window.location.protocol+"//"+window.location.host+window.location.pathname},"",window.location.protocol+"//"+window.location.host+window.location.pathname)})()}}();
